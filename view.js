!function(){"use strict";if(document.getElementById("ae-host"))return void console.warn("Article Extractor is already open. Aborting the launch of a new instance to prevent conflicts.");let e=!1;const t={page:"undefined"!=typeof unsafeWindow?unsafeWindow:window,sandbox:window},n={setValue:"function"==typeof GM_setValue?GM_setValue:"object"==typeof GM&&"function"==typeof GM.setValue?GM.setValue:null,getValue:"function"==typeof GM_getValue?GM_getValue:"object"==typeof GM&&"function"==typeof GM.getValue?GM.getValue:null,deleteValue:"function"==typeof GM_deleteValue?GM_deleteValue:"object"==typeof GM&&"function"==typeof GM?.deleteValue?GM.deleteValue:null,xmlHttpRequest:"object"==typeof GM&&"function"==typeof GM.xmlHttpRequest?GM.xmlHttpRequest:"function"==typeof GM_xmlhttpRequest?GM_xmlhttpRequest:null},a=(...e)=>t.sandbox.setTimeout(...e),o=(...e)=>t.sandbox.clearTimeout(...e),r=(...e)=>t.sandbox.setInterval(...e),i=(...e)=>t.sandbox.clearInterval(...e),s={shadow:null,overlay:null,listeners:{currentEscapeHandler:null},currentTab:"edit",readabilityPrefs:null,articleElement:null,cleanupFunctions:Object.create(null)},l={STREAMS:{CompressionStream:"function"==typeof t.page.CompressionStream&&t.page.CompressionStream||"function"==typeof t.sandbox.CompressionStream&&t.sandbox.CompressionStream||null,DecompressionStream:"function"==typeof t.page.DecompressionStream&&t.page.DecompressionStream||"function"==typeof t.sandbox.DecompressionStream&&t.sandbox.DecompressionStream||null,get available(){return!(!this.CompressionStream||!this.DecompressionStream)}},HIGHLIGHT_CLASSES:["ae-removed","ae-removed-selectors_always_remove","ae-removed-selectors_optional","ae-removed-images","ae-removed-ads","ae-removed-nav","ae-removed-flash"],SYNC:{authKeys:["ae_gdrive_fid","ae_gdrive_uem","ae_gdrive_atk","ae_gdrive_rtk","ae_gdrive_exp"],USERSCRIPT_NETWORKING:"undefined"!=typeof GM&&"function"==typeof GM.xmlHttpRequest||"function"==typeof GM_xmlhttpRequest},HOSTNAME:t.sandbox.location.hostname,REGEXPS:{unlikelyCandidates:/-ad-|ai2html|banner|breadcrumbs|combx|comment|community|cover-wrap|disqus|extra|footer|gdpr|header|legends|menu|related|remark|replies|rss|shoutbox|sidebar|skyscraper|social|sponsor|supplemental|ad-break|agegate|pagination|pager|popup|yom-remote|carousel/i,okMaybeItsACandidate:/and|article|body|column|content|main|mathjax|shadow/i,positive:/article|body|content|entry|hentry|h-entry|post|text|blog|story/i,negative:/-ad-|hidden|^hid$| hid$| hid |^hid |banner|combx|comment|com-|contact|footer|gdpr|masthead|media|meta|outbrain|promo|related|scroll|share|shoutbox|sidebar|skyscraper|sponsor|shopping|tags|widget/i,extraneous:/print|archive|comment|discuss|e[\-]?mail|share|reply|all|login|sign|single|utility/i,byline:/byline|author|dateline|writtenby|p-author/i,commas:/\u002C|\u060C|\uFE50|\uFE10|\uFE11|\u2E41|\u2E34|\u2E32|\uFF0C/g,credit:/(?:(Photo|Image|Picture|Illustration|Credit|Source|Courtesy|©|Copyright|Handout|Screenshot|Still|Illustrative|Pic|Photograph)(:|-|–|—|\.\.\.|…)\s*(.+?)(?=\n|$))|\((?:(Photo|Image|Picture|Illustration|Credit|Source|Courtesy|©|Copyright|Handout|Screenshot|Still|Illustrative|Pic|Photograph)(:|-|–|—|\.\.\.|…)\s*)?([^)]+)\)\s*$|(?:(Photo|Image|Picture|Illustration|Credit|Source|Courtesy|©|Copyright|Handout|Screenshot|Still|Illustrative|Pic|Photograph)(:|-|–|—|\.\.\.|…)\s*)([^)]+)\)/i},ALWAYS_REMOVE_DEFAULTS:["script","nav","header","footer","aside","form","audio","svg","button"],OPTIONAL_REMOVE_DEFAULTS:["style","iframe","video","object","embed",'[class*="read" i]:is([class*="related" i],[class*="most" i],[class*="next" i],[class*="more" i])','[class*="related" i]','[class*="share" i]','[class*="signup" i]','[class*="subscribe" i]','[class*="banner" i]','[class*="comments" i]','[class*="newsletter" i]','[class*="social" i]'],EXTRACTION_METHODS:{READABILITY:"readability",CUSTOM:"custom"},WORDS_PER_MINUTE:200,MOBILE_WIDTH:600,IS_MOBILE:window.innerWidth<=600,IS_SAFARI:/Safari\//.test(navigator.userAgent)&&!/Chrome\//.test(navigator.userAgent),IS_IOS_SAFARI:/iP(ad|hone|od)/.test(navigator.userAgent)&&/Safari\//.test(navigator.userAgent)&&!/Chrome\//.test(navigator.userAgent),IS_USERSCRIPT:"function"==typeof GM_getValue||"object"==typeof GM&&"function"==typeof GM.getValue,ZINDEX_MAX:2147483647,ZINDEX_MINUS_1:2147483646,MAX_FILENAME_LENGTH:100,CLASS_WEIGHT_SCORES:{NEGATIVE:-20,UNLIKELY_CANDIDATE:-10,OK_MAYBE_CANDIDATE:10,POSITIVE:20,BYLINE:-5},REFINEMENT_ACCUM_SCORE_RATIO_THRESHOLD:.8,DESCEND_TO_REFINE_CONTENT_NODE_THRESHOLD:.5,REFINEMENT_COMPETITIVE_OVERALL_SCORE_THRESHOLD:.5,DESCEND_TO_REFINE_MAX_DEPTH:5,PARAGRAPH_SCORE_CAP:60,PARAGRAPH_SCORE_FACTOR:10,TEXT_TO_HTML_SCORE_FACTOR:300,LINK_DENSITY_PENALTY_FACTOR:500,TEXT_LENGTH_PENALTY_FACTOR_NODE:.5,IS_UNLIKELY_PROPAGATED_PENALTY_MULTIPLIER:.5,SEMANTIC_TAG_BOOST_MULTIPLIER:.2,MIN_TEXT_LENGTH_STEP1_CANDIDATE:2500,MIN_PARAGRAPHS_STEP1_CANDIDATE:5,STEP1_EARLY_RETURN_SCORE:500,MIN_CONTENT_NODE_TEXT_LENGTH:120,CONTENT_NODE_LINK_DENSITY_THRESHOLD:.2,CONTENT_NODE_LINK_DENSITY_PENALTY_FACTOR:100,LINK_DENSITY_DIFF_MULTIPLIER:500,ANCESTOR_SCORE_DECAY_DIVISOR_OFFSET:2,MIN_CONTENT_NODES_FOR_BEST_CONTAINER:5,BEST_CONTAINER_LINK_DENSITY_THRESHOLD:.2,MIN_SCORE_FOR_BROAD_SEARCH:150,TOP_N_CANDIDATES_FROM_STEP1:1,BLOCK_LEVEL_TAGS:new Set(["ADDRESS","ARTICLE","ASIDE","BLOCKQUOTE","CANVAS","DD","DIV","DL","DT","FIELDSET","FIGCAPTION","FIGURE","FOOTER","FORM","H1","H2","H3","H4","H5","H6","HEADER","HR","LI","MAIN","NAV","NOSCRIPT","OL","P","PRE","SECTION","TABLE","TD","TH","TR","TFOOT","UL","VIDEO","SECTION","SUMMARY"]),DIV_TO_P_LINK_DENSITY_THRESHOLD:.25,GOOGLE_FONTS_MAP:{atkinson:"Atkinson+Hyperlegible+Next:ital,wght@0,200..800;1,200..800",roboto:"Roboto:ital,wdth,wght@0,75..100,100..900;1,75..100,100..900","noto-sans":"Noto+Sans:ital,wdth,wght@0,62.5..100,100..900;1,62.5..100,100..900",literata:"Literata:ital,opsz,wght@0,7..72,200..900;1,7..72,200..900",inter:"Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900"}},c=new CSSStyleSheet;c.replaceSync('\n:root {\n--zindex-minus-1: 2147483646;\n--zindex-max: 2147483647;\n}\nbody.modal-open {\noverflow: hidden !important;\n}\n/* body.modal-open > :not(#ae-host) {\nopacity: 0;\npointer-events: none !important;\noverscroll-behavior: none !important;\noverflow: hidden !important;\nvisibility: hidden !important;\n} */\n/* body.modal-open > :not(#ae-host) {\nopacity: 0;\nclip: rect(0, 0, 0, 0);\nposition: absolute;\nposition: absolute;\nleft: -9999px;\ntop: -9999px;\ntransform: scale(0);\ntransform-origin: center;\nclip-path: inset(100%);\n} */\n/* body.modal-open.blur > :not(#ae-host) {\nfilter: blur(2px);\n} */\nbody.selection-open p {\nmargin: 22px !important;\n}\n#ae-button {\nall: revert;\nposition: fixed;\ntop: var(--ae-y, 10px);\nleft: var(--ae-x, calc(100vw - 10px - 100%));\nright: auto;\nz-index: var(--zindex-minus-1, 2147483647);\npadding: 10px 14px;\nbackground-color: #4a6b7f;\ncolor: #fff;\nfont: 500 16px/1 system-ui, sans-serif;\nborder: 0;\noutline: none;\nborder-radius: 6px;\ncursor: grab;\nuser-select: none;\n-webkit-user-select: none;\ntouch-action: none;\nbox-shadow: 0 4px 12px rgba(0,0,0,.15);\nwhite-space: nowrap;\n}\n#ae-button:hover {\nbox-shadow: 0 6px 16px rgba(0,0,0,.2);\nbackground-color: color(from #4a6b7f xyz calc(x - 0.02) calc(y - 0.02) calc(z - 0.02));\n}\n#ae-button.dragging {\ncursor: grabbing;\ntransform: scale(0.98);\nbox-shadow: 0 8px 24px rgba(0,0,0,.28);\n}\n.ae-select-highlight {\noutline: 2px dashed #4285f4 !important;\noutline-offset: -1px;\nbackground-color: rgba(66, 133, 244, 0.1) !important;\n}\n#ae-toast-container {\nall: revert;\nposition: fixed;\nbottom: 30px;\nmax-width: 75vw;\nleft: 50%;\ntransform: translateX(-50%);\ndisplay: flex;\nflex-direction: column;\ngap: 10px;\nalign-items: center;\nz-index: var(--zindex-max);\n}\n.ae-toast {\nall: revert;\nbackground-color: #333;\ncolor: #fff;\npadding: 12px 16px;\nborder-radius: 5px;\nfont-size: 15px;\nbox-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);\nfont-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\nopacity: 1;\ntransition: opacity 0.5s ease;\n}\n#ae-selection-bar {\nall: revert;\nposition: fixed;\nbottom: 0;\nleft: 0;\nwidth: 100%;\nbackground-color: rgba(40, 40, 40, 0.95);\ncolor: white;\npadding: 12px;\nz-index: 2147483646;\ndisplay: flex;\njustify-content: center;\nalign-items: center;\ngap: 10px;\nfont-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\nfont-size: 14px;\nbox-shadow: 0 -4px 10px rgba(0, 0, 0, 0.3);\nbox-sizing: border-box;\n}\n#ae-selection-bar span {\nall: revert;\nmargin-right: auto;\noverflow: hidden;\ntext-overflow: ellipsis;\nwhite-space: nowrap;\nmax-width: calc(100% - 260px);\n}\n#ae-selection-bar button {\nall: revert;\npadding: 8px 16px;\nborder: none;\nborder-radius: 5px;\ncursor: pointer;\nfont-size: 15px;\nflex-shrink: 0;\n}\n#ae-selection-bar .accept-btn {\nbackground-color: #4caf50;\ncolor: white;\n}\n#ae-selection-bar .accept-btn:hover {\nbackground-color: color(from #4caf50 xyz calc(x - 0.05) calc(y - 0.05) calc(z - 0.05));\n}\n#ae-selection-bar .cancel-btn {\nbackground-color: #f44336;\ncolor: white;\n}\n#ae-selection-bar .cancel-btn:hover {\nbackground-color: color(from #f44336 xyz calc(x - 0.05) calc(y - 0.05) calc(z - 0.05));\n}\n#ae-selection-bar .buttons-group {\ndisplay: flex;\ncolumn-gap: 12px;\n}\n@media (max-width: 700px) and (orientation: portrait) {\nbody.modal-open > :not(#ae-host, .ae) {\nvisibility: hidden !important;\n}\n}\n@media (max-width: 1000px) {\nbutton {\ntransform: none !important;\n}\n#ae-selection-bar {\nflex-direction: column;\ngap: 8px;\npadding: 8px;\n}\n#ae-selection-bar span {\ntext-align: center;\nwidth: 100%;\nmax-width: 100%;\nmargin-bottom: 5px;\n}\n#ae-selection-bar .buttons-group {\ndisplay: flex;\njustify-content: space-around;\nwidth: 100%;\ngap: 8px;\n}\n#ae-selection-bar button {\nflex-grow: 1;\n}\n.visible {\ndisplay: block !important;\n}\n.invisible {\ndisplay: none !important;\n}\n}');const d=new CSSStyleSheet;d.replaceSync(':root {\n--zindex-minus-1: 2147483646;\n--zindex-max: 2147483647;\n}\n:host {\ndirection: ltr;\n}\n#ae-overlay {\ninset: 0;\nposition: fixed;\nmargin-left: auto;\nmargin-right: auto;\nbackground-color: white;\nz-index: var(--zindex-minus-1);\noverflow-y: auto;\noverscroll-behavior: none;\nbox-sizing: border-box;\nfont-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n}\n#ae-backdrop {\nposition: fixed;\nz-index: var(--zindex-minus-1);\ninset: 0;\nbackground-color: rgba(0, 0, 0, 0.7);\n}\n.article-settings-wrapper {\nmax-width: 900px;\nmargin: auto;\npadding: 3px 7px 5px 7px;\nbackground-color: #fff;\nbox-shadow: 0 5px 7px 6px rgba(0, 0, 0, 0.08);\nborder-radius: 0 0 6px 6px;\nline-height: 1.6;\nz-index: var(--zindex-minus-1) !important;\nposition: relative;\n}\n#ae-btn-pick-element {\nmargin: 1px 0 0 0;\n}\n#excerpt {\nfont-size: 16px;\ncolor: #555;\nbox-sizing: border-box;\nwidth: 100%;\nmargin: 0px 0px 1px 0px;\n}\n#ae-toast-container {\nposition: fixed;\nbottom: 30px;\nleft: 50%;\ntransform: translateX(-50%);\ndisplay: flex;\nflex-direction: column;\ngap: 10px;\nalign-items: center;\nz-index: var(--zindex-max);\n}\n.ae-toast {\nbackground-color: #333;\ncolor: #fff;\nmax-width: 80vw;\noverflow: auto;\nword-wrap: break-word;\npadding: 12px 16px;\nborder-radius: 5px;\nfont-size: 15px;\nbox-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);\nfont-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\nopacity: 1;\ntransition: opacity 0.5s ease;\n}\n.conflict-actions {\ndisplay:flex;\ngap: 10px;\nflex-wrap: wrap;\n}\n.chevron {\ndisplay: inline-block;\nwidth: 7px;\nheight: 7px;\nborder-top: 2px solid currentColor;\nborder-right: 2px solid currentColor;\ntransform: rotate(45deg);\ntransition: 0.2s;\nmargin-inline-start: auto;\nmargin-top: 4px;\n}\n.chevron.visible {\ntransform: rotate(135deg);\n}\n.sync-tab-container {\nmargin: 10px 5px;\n}\n.sync-controls-container {\ndisplay: flex;\nflex-flow: wrap;\ngap: 12px 10px;\nmargin-top: 20px;\njustify-content: space-between;\n}\n.sync-conflict-resolver {\ndisplay: none;\nborder: 1px solid #f0ad4e;\nborder-radius: 4px;\npadding: 10px;\nmargin-top: 15px;\nbox-sizing: border-box;\nbackground-color: #fcf8e3;\n}\n.sync-conflict-resolver pre {\noverflow-wrap: break-word;\nwhite-space: break-spaces;\n}\n.sync-conflict-resolver p {\nmargin: 0 0 10px 0;\nfont-size: 14px;\nline-height: 1.4;\n}\n.sync-conflict-resolver-buttons {\ndisplay: flex;\ngap: 10px;\nflex-wrap: wrap;\n}\n.ae-controls {\nposition: sticky;\ntop: 0;\nbackground-color: #fff;\npadding: 10px;\nz-index: var(--zindex-max);\nbox-shadow: 0 4px 10px 7px rgba(0, 0, 0, 0.08);\nborder-radius: 0px 0px 5px 5px;\ndisplay: flex;\njustify-content: space-between;\nborder-bottom: 0.25px solid #dcdcdc;\nalign-items: center;\n}\n#article-control-bar-right {\ndisplay: flex;\ncolumn-gap: 15px;\n}\n#title {\nfont-size: 19px;\nfont-weight: 500;\nbox-sizing: border-box;\nwidth: 100%;\n}\n#ae-details-panel {\nposition: fixed;\nfont-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\nbottom: 10px;\nright: 10px;\nbackground-color: white;\nborder-radius: 8px;\nbox-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);\nwidth: 25%;\nmax-height: calc(100% - 20px);\nheight: 50%;\noverflow-x: hidden;\noverflow-y: auto;\nz-index: var(--zindex-max);\nfont-size: 14px;\nline-height: 1.5;\nword-break: break-word;\noverscroll-behavior: none;\n}\n#ae-resize-handle {\nwidth: 40px;\nheight: 30px;\ncursor: nwse-resize;\ntouch-action: none;\nuser-select: none;\n-webkit-user-select: none;\n}\n#ae-details-panel pre {\nwhite-space: pre;\noverflow-x: auto;\npadding: 6px;\nbackground-color: #f0f0f0;\nuser-select: none;\n-webkit-user-select: none;\n}\n.ae-copyable {\ncursor: copy;\n}\n.ae-html-tag {\ncursor: pointer;\nborder-radius: 3px;\npadding: 0 2px;\nborder-left: 3px solid var(--ae-html-tag-accent, transparent);\ncolor: var(--ae-html-tag-accent, inherit);\n}\n.ae-tag-flash {\nanimation: ae-tag-flash 0.9s ease-out;\n}\n@keyframes ae-tag-flash {\n0% {\nbackground-color: rgba(241, 47, 22, 0.5);\n}\n60% {\nbackground-color: rgba(241, 47, 22, 0.12);\n}\n100% {\nbackground-color: rgba(241, 47, 22, 0.0);\n}\n}\n.ae-removed-flash {\nanimation: ae-removed-flash 0.9s ease-out;\n}\n@keyframes ae-removed-flash {\n0% {\nbox-shadow: 0 0 0 5px rgba(241, 47, 22, 0.85);\n}\n60% {\nbox-shadow: 0 0 0 5px rgba(241, 47, 22, 0.12);\n}\n100% {\nbox-shadow: 0 0 0 5px rgba(241, 47, 22, 0.0);\n}\n}\n.ae-tools {\ndisplay: flex;\nflex-wrap: wrap;\nalign-items: center;\npadding: 4px 7px 5px 7px;\nbackground-color: #f8f9fa;\nborder-radius: 6px;\nborder: 1px solid #ccc;\ncolumn-gap: 12px;\n}\n.ae-tools input {\nmin-height: 30.5px;\nflex-grow: 1;\n}\n.ae-tools button {\ndisplay: flex;\nflex-grow: 1;\nmin-height: 36px;\nmargin-top: 2px;\n}\n.ae-btn {\npadding: 8px 10px;\ncolor: #fff;\nborder: none;\nborder-radius: 4px;\ncursor: pointer;\nfont-size: 14px;\nposition: relative;\n}\n.ae-btn-small {\npadding: 5px 7px;\nfont-size: 13px;\ncolor: #fff;\nborder: 0.5px solid #ccc;\nborder-radius: 3.5px;\ncursor: pointer;\nfont-size: 14px;\n}\n.ae-tab {\nbackground-color: transparent;\ncolor: black;\n}\n.ae-tab.selected {\nbackground-color: #1c89cb;\ncolor: #fff;\n}\n.ae-advanced-options .ae-tab.selected {\nbackground-color: #e67e22;\n}\n.ae-tab-container {\ndisplay: flex;\nmargin: 6px auto 4px;\ngap: 10px;\nflex-wrap: wrap;\n}\n.import-export-container {\nmargin-top: 20px;\nborder-top: 1px solid #ccc;\npadding-top: 15px;\ndisplay: flex;\ngap: 10px;\nflex-wrap: wrap;\n}\n.ae-btn-copy {\nbackground-color: #4caf50;\n}\n.ae-btn-copy:hover {\nbackground-color: color(from #4caf50 xyz calc(x - 0.05) calc(y - 0.05) calc(z - 0.05));\n}\n.ae-btn-add-defaults {\nbackground-color: #3498db;\nmargin-top: 2px;\n}\n.ae-btn-add-defaults:hover {\nbackground-color: color(from #3498db xyz calc(x - 0.05) calc(y - 0.05) calc(z - 0.05));\n}\n.ae-btn-update-settings {\nbackground-color: #e67e22;\nmax-height: 36px;\nmin-width: 140px;\nalign-self: center;\n}\n.ae-btn-update-settings:hover {\nbackground-color: color(from #e67e22 xyz calc(x - 0.05) calc(y - 0.05) calc(z - 0.05));\n}\n.ae-btn-cancel-settings {\nbackground-color: #7f8c8d;\nmax-height: 36px;\nmin-width: 110px;\nalign-self: center;\n}\n.ae-btn-cancel-settings:hover {\nbackground-color: color(from #7f8c8d xyz calc(x - 0.05) calc(y - 0.05) calc(z - 0.05));\n}\n.ae-btn-close {\nbackground-color: #f1434b;\n}\n.ae-btn-close:hover {\nbackground-color: color(from #f1434b xyz calc(x - 0.05) calc(y - 0.05) calc(z - 0.05));\n}\n.ae-btn-top {\nbackground-color: #95a5a6;\n}\n.ae-btn-top:hover {\nbackground-color: color(from #95a5a6 xyz calc(x - 0.05) calc(y - 0.05) calc(z - 0.05));\n}\n.ae-btn-replace {\nbackground-color: #8e44ad;\n}\n.ae-btn-replace:hover {\nbackground-color: color(from #8e44ad xyz calc(x - 0.05) calc(y - 0.05) calc(z - 0.05));\n}\n.ae-preview-btn {\nbackground-color: #3498db;\n}\n.ae-preview-btn:hover {\nbackground-color: color(from #3498db xyz calc(x - 0.05) calc(y - 0.05) calc(z - 0.05));\n}\n.ae-preview-btn.previewing {\nbackground-color: #00b9b9;\n}\n.ae-preview-btn.previewing:hover {\nbackground-color: color(from #00b9b9 xyz calc(x - 0.05) calc(y - 0.05) calc(z - 0.05));\n}\n.disabled,\n.disabled:hover {\nbackground-color: #95a5a6 !important;\ntransform: none !important;\nbox-shadow: none !important;\ntransition: none !important;\ncursor: not-allowed;\n}\n.ae-btn-readability {\nbackground-color: #00b9b9;\n}\n.ae-btn-readability:hover {\nbackground-color: color(from #00b9b9 xyz calc(x - 0.05) calc(y - 0.05) calc(z - 0.05));\n}\n.standard-blue {\nbackground-color: #3498db;\n}\n.standard-blue:hover {\nbackground-color: color(from #3498db xyz calc(x - 0.05) calc(y - 0.05) calc(z - 0.05));\n}\n.orange {\nbackground-color: #e67e22;\n}\n.orange:hover {\nbackground-color: color(from #e67e22 xyz calc(x - 0.05) calc(y - 0.05) calc(z - 0.05));\n}\n.ae-btn-primary {\nbackground-color: #1c89cb;\ncolor: white;\npadding: 7px 10px;\nborder-radius: 4px;\n}\n.ae-btn-primary:hover {\nbackground-color: color(from #1c89cb xyz calc(x - 0.05) calc(y - 0.05) calc(z - 0.05));\n}\n.ae-btn-secondary {\nbackground-color: #3d8b40;\ncolor: white;\npadding: 7px 10px;\nborder-radius: 4px;\n}\n.ae-btn-secondary:hover {\nbackground-color: color(from #3d8b40 xyz calc(x - 0.05) calc(y - 0.05) calc(z - 0.05));\n}\n#minimize-details-btn {\nbackground-color: transparent;\ncolor: #666;\npadding: 7px 10px;\nborder: none;\n}\n.ae-settings {\nmargin-top: 10px;\nposition: relative;\n}\n.ae-option {\ndisplay: flex;\nflex-direction: column;\nmargin: 5px 0;\n}\n@media (min-width: 1001px) {\n.ae-btn:hover {\ntransform: translateY(-1px);\n}\n.ae-btn-small:hover {\ntransform: translateY(-1px);\n}\n.ae-html-tag:hover {\nbackground-color: var(--ae-html-tag-hover, rgba(224, 243, 255, 0.85));\n}\n.ae-restore-btn {\nbottom: 10px;\nright: 10px;\npadding: 10px 14px;\n}\n.translate button {\ntransform: translateY(-1px);\n}\n}\n@media (max-width: 1000px) {\n#ae-overlay {\n-webkit-text-size-adjust: none;\n-webkit-overflow-scrolling: touch;\n}\n.ae-html-tag:active {\nbackground-color: var(--ae-html-tag-hover, rgba(224, 243, 255, 0.85));\n}\n.ae-restore-btn {\nbottom: 7px;\nfont-size: 13px;\nright: 5px;\npadding: 7px 11px;\nborder: 0.5px solid #bbb;\n}\n.ae-tab-container {\ngap: 10px;\n}\nbutton {\ntransform: none !important;\n-webkit-user-select: none;\nuser-select: none;\n}\n.chevron {\nmargin-top: 5px;\n}\n.article-settings-wrapper {\npadding: 3px 7px 4px 7px;\nbackground-color: #fff;\nbox-shadow: 0 0 15px rgba(0, 0, 0, 0.1);\nborder-radius: 0 0 6px 6px;\nline-height: 1.6;\n}\n.ae-tools {\nflex-direction: column;\nalign-items: stretch;\ncolumn-gap: 4px;\npadding: 5px 7px 3px 7px;\n}\n.ae-tools button {\nmargin-bottom: 3px;\n}\n#ae-details-panel {\nmax-width: calc(100vw - 20px);\nmax-height: calc(100% - 20px);\nwidth: calc(95% - 20px);\n-webkit-text-size-adjust: none;\n-webkit-overflow-scrolling: touch;\n}\n}\n@media (max-width: 1000px) and (orientation: landscape) {\n.readability-option.readability-line-width,\n.readability-option.readability-overlay-width {\ndisplay: flex;\n}\n#ae-backdrop {\ndisplay: block;\n}\n}\n@media (max-width: 700px) and (orientation: portrait) {\n.readability-option.readability-line-width,\n.readability-option.readability-overlay-width,\n#ae-backdrop {\ndisplay: none;\n}\n#ae-overlay {\nmax-width: 100% !important;\nwidth: 100% !important;\n}\n.article-settings-wrapper {\nborder: none;\n}\n}\n.ae-removed {\noutline: 2px dashed #d32f2f;\noutline-offset: -1px;\nopacity: 0.6;\n}\n.ae-removed-nav {\noutline: 2px dashed #a81da3ff;\noutline-offset: -1px;\nopacity: 0.6;\n}\n.ae-removed-images {\noutline: 2px dashed #d1680d;\noutline-offset: -1px;\nopacity: 0.6;\n}\n.ae-removed-selectors_optional {\noutline: 2px dashed #1c89cb;\noutline-offset: -1px;\nopacity: 0.6;\n}\n.ae-removed-selectors_always_remove {\noutline: 2px dashed #3d8b40;\noutline-offset: -1px;\nopacity: 0.6;\n}\n#preview-contents-container {\npadding: 10px;\noverflow-wrap: break-word;\n}\n#preview-contents-container pre {\nwhite-space: pre-wrap;\n}\n.extractor-preview-content :has(img, picture, video, figure, table, pre, code, iframe) {\ndisplay: block;\nmax-width: 100% !important;\nheight: auto !important;\nmargin-left: auto;\nmargin-right: auto;\n}\n.extractor-preview-content :is(img, picture, video, figure, table, pre, code, iframe) {\ndisplay: block;\nmax-width: 90%;\nheight: auto;\nmargin: 12px auto 12px auto;\n}\n.ae-advanced-options,\n.ae-readability-options {\ndisplay: none;\nborder: 1px solid #ddd;\nborder-radius: 5px;\npadding: 10px;\n}\n.ae-advanced-options.visible,\n.ae-readability-options.visible {\ndisplay: block;\nmargin-bottom: 10px;\nbackground-color: #f9fafb;\nbox-sizing: border-box;\n}\n.ae-advanced-options.visible {\nborder: 1px solid #e67e22;\n}\n.ae-readability-options.visible {\nborder: 1px solid #00b9b9;\n}\n.ae-advanced-options.visible hr {\nborder: none;\nborder-top: 1px solid #ccc;\n}\n.ae-readability-options.visible :is(input, select) {\nbox-sizing: border-box;\nwidth: 100%;\nmax-width: 600px;\n}\n.ae-overlay input,\n.ae-overlay select,\n.ae-overlay textarea {\nfont-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\npadding: 5px;\nfont-size: 14px;\nborder: 1px solid #bbb;\nborder-radius: 4px;\nbackground-color: #fff;\ncolor: #333;\nbox-sizing: border-box;\n}\n#advanced-settings-content textarea {\nfont-size: 16px;\nwidth: 100%;\nheight: 70px;\n/* transition: height 0.2s ease; */\n}\n/* #advanced-settings-content textarea:focus {\nheight: 110px;\n} */\ntextarea#ae-text-removal {\nheight: 50px;\n}\n.readability-option {\ndisplay: flex;\nflex-direction: column;\nmargin: 0px;\npadding: 0px;\n}\nheader#header-preview {max-width: 800px; margin: 0 12px;}\n#header-preview > h2 {font-size: 25px;margin:0px;}\n#header-preview > .subtitle {color: #444;font-size: 16px;font-weight:500;margin:10px 0px;}\n#header-preview > .metadata {color: #666; font-size:0.95em;margin:7px 0px;}\n.metadata-inputs :is(input, select, textarea):focus,\n.ae-readability-options.visible :is(input, select, textarea):focus,\n.ae-advanced-options.visible :is(input, select, textarea):focus {\noutline: none;\nbox-shadow: 0 0 0 2px rgba(66, 133, 244, 0.4);\n}\n.ae-overlay button {\ncursor: pointer;\nfont-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\nfont-size: 15px;\nborder: 1px solid #bbb;\nborder-radius: 5px;\npadding: 8px 12px;\n}\n.ae-overlay input[type="checkbox"] {\n-webkit-appearance: checkbox;\nappearance: checkbox;\nmargin-right: 8px;\n}\n.metadata-inputs {\nmargin: 5px 0;\n}\n.metadata-inputs.showing-preview {\ndisplay: block;\n}\n.metadata-details {\ndisplay: flex;\nflex-wrap: wrap;\ncolumn-gap: 10px;\nrow-gap: 7px;\nfont-size: 14px;\ncolor: #666;\nmargin: 5px 0;\n}\n.ae-restore-btn {\nposition: fixed;\nz-index: var(--zindex-max);\nbackground-color: #1c89cb;\nfont-size: 15px;\ncolor: #fff;\nborder-radius: 5px;\ncursor: pointer;\nborder: 0.5px solid #bbb;\nbox-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);\n}\n.ae-restore-btn:hover {\nbackground-color: color(from #1c89cb xyz calc(x - 0.05) calc(y - 0.05) calc(z - 0.05));\ntransform: translateY(-1px);\n}\n.ae-tab-container button {\npadding: 5px 9px;\nmax-height: 30px;\n}\n.ae-tab-container button {\npadding: 5px 10px;\nmax-height: 30px;\nflex: 1;\nz-index: var(--zindex-minus-1);\n}\n.visible {\ndisplay: block !important;\n}\n.invisible {\ndisplay: none !important;\n}');const u=()=>t.sandbox.performance&&"function"==typeof t.sandbox.performance.now?t.sandbox.performance.now():Date.now();function h(e,t,n={}){if("function"!=typeof e)throw new TypeError("Expected function");const r=!0===n.leading,i=!1!==n.trailing,s=Number.isFinite(n.maxWait)?Math.max(0,n.maxWait):null,l=Math.max(0,t||0);let c,d,h,p,m=0,f=0;const g=t=>{f=t;const n=e.apply(h,d);return d=h=void 0,p=n},y=e=>{c=a(w,e)},b=e=>{const t=e-f,n=l-(e-m);return null==s?n:Math.min(n,s-t)},E=e=>(c=void 0,i&&d?g(e):(d=h=void 0,p)),w=()=>{const e=u();if((e=>0!==m&&(e-m>=l||null!=s&&e-f>=s))(e))return E(e);y(Math.max(0,b(e)))};function v(...e){const t=u();return d=e,h=this,m=t,void 0===c?(e=>(0===f&&(f=e),y(l),r?g(e):p))(t):(o(c),y(Math.max(0,b(t))),p)}return v.cancel=function(){void 0!==c&&o(c),c=d=h=void 0,m=f=0},v.flush=function(){return void 0===c?p:E(u())},v.pending=function(){return void 0!==c},v}async function p(e,t=3,n=1e3,r={}){const i=Number.isFinite(r.factor)?r.factor:2,s=Number.isFinite(r.maxDelay)?r.maxDelay:3e4,l=Number.isFinite(r.jitter)?Math.min(1,Math.max(0,r.jitter)):.2,c="function"==typeof r.isRetryable?r.isRetryable:()=>!0,d="function"==typeof r.onRetry?r.onRetry:null,u=Number.isFinite(r.perAttemptTimeout)?r.perAttemptTimeout:null,h=r.signal,p=()=>h&&h.aborted,m=()=>h&&h.reason instanceof Error?h.reason:new Error("Aborted"),f=e=>new Promise(((t,n)=>{if(p())return n(m());const r=a(t,e);h&&h.addEventListener("abort",(()=>{o(r),n(m())}),{once:!0})})),g=t=>{if(!u)return e(t,h);let n,r=!1;const i=new Promise(((e,t)=>{n=a((()=>{r||t(new Error("Attempt timed out"))}),u)}));return Promise.race([e(t,h),i]).finally((()=>{r=!0,n&&o(n)}))};let y;for(let e=0;e<=t;e++){if(p())throw m();try{return await g(e)}catch(a){if(y=a,e>=t||!c(a,e))throw a;const o=Math.min(s,n*Math.pow(i,e)),r=Math.max(0,Math.floor(o+(2*Math.random()-1)*o*l));if(d)try{d({attempt:e,error:a,delay:r})}catch{}await f(r)}}throw y}const m={debug(e,t=null){E.DEBUG_MODE&&console.log(`[SYNC DEBUG] ${e}`,t||"")},info(e,t=null){E.DEBUG_MODE&&console.log(`[SYNC INFO] ${e}`,t||"")},warn(e,t=null){E.DEBUG_MODE&&console.warn(`[SYNC WARN] ${e}`,t||"")},error(e,t=null){E.DEBUG_MODE&&console.error(`[SYNC ERROR] ${e}`,t||"")}};const f={mode:()=>function(){try{const e=void 0!==E&&E&&E.STORAGE_MODE||"auto",t="function"==typeof GM_getValue&&"function"==typeof GM_setValue&&"function"==typeof GM_deleteValue||"undefined"!=typeof GM&&"function"==typeof GM.getValue&&"function"==typeof GM.setValue&&"function"==typeof GM.deleteValue;return"gm"===e?t?"gm":"local":"local"===e?"local":t?"gm":"local"}catch(e){return"local"}}(),isUserscript(){return"gm"===this.mode()},getItem(e){try{if(this.isUserscript()&&l.SYNC.authKeys.includes(e)){const t=n.getValue(e,null);return null==t?null:String(t)}return localStorage.getItem(e)}catch(t){try{m?.warn("Storage getItem failed",{key:e,e:t})}catch(e){}return null}},setItem(e,t){try{const a=String(t);this.isUserscript()&&l.SYNC.authKeys.includes(e)?n.setValue(e,a):localStorage.setItem(e,a),E.DEBUG_MODE&&m.debug(`Stored key in ${this.mode()} storage: ${e}`)}catch(e){try{m?.error("Storage setItem failed",e)}catch(e){}}},removeItem(e){try{this.isUserscript()&&l.SYNC.authKeys.includes(e)?n.deleteValue(e):localStorage.removeItem(e)}catch(t){try{m?.warn("Storage removeItem failed for preferred storage",{key:e,e:t})}catch(e){}}finally{try{localStorage.removeItem(e)}catch(e){}}}},g=e=>{if(null==e)return null;if(""===e)return btoa("");try{const t=(new TextEncoder).encode(String(e));let n="";for(let e=0;e<t.length;e++)n+=String.fromCharCode(t[e]);return btoa(n)}catch{return btoa(unescape(encodeURIComponent(String(e))))}},y=e=>{if(null==e)return null;if(""===e)return"";try{const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return new TextDecoder("utf-8").decode(n)}catch{try{return decodeURIComponent(escape(atob(e)))}catch(e){return console.error("Failed to deobfuscate string:",e),null}}},b={isAuthenticated:!1,isSyncing:!1,fileId:null,userEmail:null,accessToken:null,refreshToken:null,tokenExpiresAt:null,lastSyncTimestamp:null,syncStatus:"Not Connected",retryCount:0,maxRetries:3,operationHistory:[],addOperation(e,t){if(E.DEBUG_MODE){for(this.operationHistory.push({id:e,type:t,startTime:Date.now(),status:"started"});this.operationHistory.length>E.MAX_OPERATION_HISTORY;)this.operationHistory.shift();m.debug(`Operation started: ${t}`,{operationId:e})}},completeOperation(e,t="completed",n=null){if(!E.DEBUG_MODE)return;const a=this.operationHistory.find((t=>t.id===e));a&&(a.status=t,a.endTime=Date.now(),a.duration=a.endTime-a.startTime,n&&(a.error=n.message||n)),m.debug(`Operation ${t}: ${e}`,{duration:a?.duration})},loadAuthFromStorage(){try{this.fileId=y(f.getItem("ae_gdrive_fid"))||null,this.userEmail=y(f.getItem("ae_gdrive_uem"))||null,this.accessToken=y(f.getItem("ae_gdrive_atk"))||null,this.refreshToken=y(f.getItem("ae_gdrive_rtk"))||null;const e=f.getItem("ae_gdrive_exp");this.tokenExpiresAt=e?parseInt(e):null,E.DEBUG_MODE&&m.debug("Auth state loaded from storage",{mode:f.mode(),hasAT:!!this.accessToken,hasRT:!!this.refreshToken,hasFID:!!this.fileId,hasUEM:!!this.userEmail,exp:this.tokenExpiresAt})}catch(e){m.error("Failed to load auth state from storage",e)}}},E={CLIENT_ID:"491773885869-ls6d7eb1vf5kl7f1cn56e7e4hhv5i7k8.apps.googleusercontent.com",CLIENT_SECRET:"YOUR_CLIENT_SECRET",SCOPE:"https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/userinfo.email",AUTH_HELPER_URL:"https://ae-auth.pages.dev/",AUTH_REDIRECT_URL:"https://auth.ae-reader.workers.dev/cb",OAUTH2_AUTHORIZE_URL:"https://accounts.google.com/o/oauth2/v2/auth",REFRESH_CONFIGURED:!1,PREFERENCES_FILENAME:"preferences.json",LOCAL_ONLY_PREFS:["cleanupAnnotations","removeAllImagesAndCaptions","syncEnabled","extractionMethod","highlightRemovals"],DEBOUNCE_DELAY:2e3,ALLOWED_ORIGINS:["https://ae-auth.pages.dev","https://ada-boy.github.io","https://auth.ae-reader.workers.dev"],TOKEN_ENDPOINT:"https://oauth2.googleapis.com/token",REFRESH_SKEW_MS:6e4,HEALTH_CHECK_INTERVAL:3e5,DEBUG_MODE:e,MAX_OPERATION_HISTORY:20,OPERATION_TIMEOUT_MS:8e3,SYNC_TIMEOUT_MS:2e4,validateConfiguration(){const e=["CLIENT_ID","PREFERENCES_FILENAME"].filter((e=>!this[e]||String(this[e]).includes("YOUR_")));if(e.length>0)throw new Error(`Missing required configuration: ${e.join(", ")}`);if(!this.AUTH_REDIRECT_URL&&!this.AUTH_HELPER_URL)throw new Error("Missing AUTH_REDIRECT_URL (preferred) or AUTH_HELPER_URL (fallback).");return!0}},w="ae-prefs",v=()=>({syncEnabled:!1,extractionMethod:l.EXTRACTION_METHODS.CUSTOM,textRemovalRules:[],cleanupAnnotations:!1,alwaysRemoveSelectors:l.ALWAYS_REMOVE_DEFAULTS,optionalRemoveSelectors:l.OPTIONAL_REMOVE_DEFAULTS,highlightRemovals:!1,removeAllImagesAndCaptions:!1,customArticleSelector:"",modifiedTime:null}),S={syncEnabled:!1,extractionMethod:l.EXTRACTION_METHODS.CUSTOM,textRemovalRules:[],cleanupAnnotations:!1,alwaysRemoveSelectors:l.ALWAYS_REMOVE_DEFAULTS,optionalRemoveSelectors:l.OPTIONAL_REMOVE_DEFAULTS,highlightRemovals:!1,removeAllImagesAndCaptions:!1,customArticleSelector:"",modifiedTime:null,validationSchema:{syncEnabled:"boolean",extractionMethod:"string",textRemovalRules:"array",cleanupAnnotations:"boolean",alwaysRemoveSelectors:"array",optionalRemoveSelectors:"array",highlightRemovals:"boolean",removeAllImagesAndCaptions:"boolean",customArticleSelector:"string",modifiedTime:e=>"string"==typeof e||null===e},validatePreferences(e){const t={valid:!0,errors:[],warnings:[]};if("object"!=typeof e||null===e||Array.isArray(e))return t.valid=!1,t.errors.push("Preferences must be a non-null object"),t;for(const n in e)if(Object.hasOwnProperty.call(e,n)){const a=e[n];if("object"!=typeof a||null===a||Array.isArray(a)){t.valid=!1,t.errors.push(`Domain ${n}: preferences must be an object`);continue}for(const[e,o]of Object.entries(this.validationSchema))if(e in a){const r=a[e],i=o;let s=!0;"string"==typeof i?("array"!==i||Array.isArray(r)||(s=!1),"boolean"===i&&"boolean"!=typeof r&&(s=!1),"string"===i&&"string"!=typeof r&&(s=!1)):"function"==typeof i&&(s=i(r)),s||(t.valid=!1,t.errors.push(`Domain ${n}: invalid ${e} (expected ${i}, got ${typeof r})`))}for(const e in a)Object.hasOwnProperty.call(this.validationSchema,e)||t.warnings.push(`Domain ${n}: unknown key ${e}`)}return t.errors.length>0&&m.error("Preferences validation failed",t.errors),t.warnings.length>0&&m.warn("Preferences validation warnings",t.warnings),t},validateSingleDomainPreferences(e){if("object"!=typeof e||null===e||Array.isArray(e))return!1;for(const[t,n]of Object.entries(this.validationSchema))if(Object.hasOwnProperty.call(e,t)){const a=e[t],o=n;let r=!0;if("string"==typeof o?"array"!==o||Array.isArray(a)?("boolean"===o&&"boolean"!=typeof a||"string"===o&&"string"!=typeof a)&&(r=!1):r=!1:"function"==typeof o&&(r=o(a)),!r)return!1}return!0},load(){let e;try{const t=localStorage.getItem(w);e=t?JSON.parse(t):null,e&&this.validateSingleDomainPreferences(e)||(m.warn("Invalid preferences structure found in storage. Using defaults."),e=v())}catch(t){m.error("Failed to parse user preferences from storage. Resetting.",t),e=v()}Object.assign(this,e),m.info("Preferences loaded for current domain")},save(e={}){const{updateTimestamp:t=!1,sync:n=!1}=e,a=localStorage.getItem(w);try{t&&(this.modifiedTime=(new Date).toISOString());const e={};for(const t of Object.keys(this.validationSchema))this.hasOwnProperty(t)&&(e[t]=this[t]);if(!this.validateSingleDomainPreferences(e))throw new Error("Preferences validation failed before save");localStorage.setItem(w,JSON.stringify(e)),m.debug("Preferences saved successfully",{updateTimestamp:t}),n&&this.syncEnabled&&b.isAuthenticated&&A.debouncedUpload()}catch(e){if(m.error("Error saving preferences, attempting rollback",e),a)try{localStorage.setItem(w,a);const e=JSON.parse(a);Object.assign(this,e),m.info("Successfully rolled back to previous preferences")}catch(e){m.error("Rollback failed",e)}throw k.showToast("Failed to save preferences"),e}},updateCurrentDomainFromCloud(e){if(!this.validatePreferences({[l.HOSTNAME]:e}).valid)return m.warn("Received invalid domain-specific preferences from the cloud."),void k.showToast("Cloud settings for this site were invalid.",4e3);const t={};for(const e of Object.keys(this.validationSchema))this.hasOwnProperty(e)&&(t[e]=this[e]);try{Object.assign(this,e),this.save({updateTimestamp:!0}),k.showToast("Local settings for this site have been updated from the cloud.",3e3),D.extractArticle(),m.info("Updated domain preferences from cloud",{hostname:l.HOSTNAME})}catch(e){throw m.error("Failed to update domain preferences from cloud, rolling back",e),Object.assign(this,t),k.showToast("Failed to update settings from cloud. Keeping local settings.",4e3),e}},toObject(){const e={};for(const t of Object.keys(this.validationSchema))this.hasOwnProperty(t)&&(e[t]=this[t]);return e}};S.load();const x={arrayEquals(e,t){if(e===t)return!0;if(!Array.isArray(e)||!Array.isArray(t)||e.length!==t.length)return!1;if(0===e.length)return!0;if(e.length<=10){const n=[...t];for(const t of e){const e=n.indexOf(t);if(-1===e)return!1;n.splice(e,1)}return!0}const n=new Map;for(const t of e)n.set(t,(n.get(t)||0)+1);for(const e of t){const t=n.get(e);if(!t)return!1;1===t?n.delete(e):n.set(e,t-1)}return 0===n.size},isDefault(e,t){const n=v();if(!Object.hasOwnProperty.call(n,e))return!1;const a=n[e];return Array.isArray(t)?this.arrayEquals(t,a):t===a},isObjectUniformlyDefault(e){if(!e||"object"!=typeof e)return!0;const t=this.filter(e);if(0===Object.keys(t).length)return!0;for(const e in t)if(!this.isDefault(e,t[e]))return!1;return!0},generateKeyDifferenceSummary(e,t,n){const a=v()[e],o=x.isDefault(e,t),r=void 0===n||x.isDefault(e,n),i=o?a:t,s=r?a:n;if(Array.isArray(i)||Array.isArray(s)){const e=new Set(i||[]),t=new Set(s||[]),n=[...e].filter((e=>!t.has(e))),a=[...t].filter((t=>!e.has(t))),o=e=>e.map((e=>`<code>${k.escapeHtml(e)}</code>`)).join(", ");let r=[];return a.length>0&&r.push(`In Cloud, Absent Locally: ${o(a)}`),n.length>0&&r.push(`Present Locally, Absent in Cloud: ${o(n)}`),r.length>0?r.join("<br>"):"No changes in list items."}const l=o?"(default)":JSON.stringify(t),c=r?"(default)":JSON.stringify(n);return`Local: <code>${k.escapeHtml(l)}</code><br>Cloud: <code>${k.escapeHtml(c)}</code>`},getIgnoredKeys:()=>new Set([...E.LOCAL_ONLY_PREFS,"modifiedTime"]),filter(e){if(!e||"object"!=typeof e)return{};const t={},n=this.getIgnoredKeys();for(const a in e)Object.hasOwnProperty.call(e,a)&&!n.has(a)&&(t[a]=e[a]);return t},computeDiff(e,t){const n=[],a=this.filter(e),o=this.filter(t||{}),r=new Set([...Object.keys(a),...Object.keys(o)]);for(const e of r){const t=a[e],r=o[e],i=this.isDefault(e,t),s=void 0===r||this.isDefault(e,r);if(i&&s)continue;let l=!1;l=Array.isArray(t)||Array.isArray(r)?this.arrayEquals(t||[],r||[]):JSON.stringify(t)===JSON.stringify(r),l||n.push({key:e,local:t,cloud:r})}return n}},T={createConflictDescription(e){const t=document.createElement("p");return t.innerHTML=e?"<b>Sync Conflict:</b> Your local settings and cloud settings for this site are different. Please choose which version to keep for each setting below.":"<b>No Conflicts:</b> Your local and cloud settings are in sync.",t},createPerSettingRow(e,t){const{key:n,local:a,cloud:o}=e,r=document.createElement("div");r.className="conflict-row",r.dataset.key=n;const i=x.isDefault(n,a),s=void 0===o||x.isDefault(n,o),l=i?t[n]:a,c=s?t[n]:o,d=JSON.stringify(l,null,2),u=JSON.stringify(c,null,2),h=x.generateKeyDifferenceSummary(n,a,o),p=document.createElement("div");p.className="conflict-key";const m=document.createElement("u"),f=document.createElement("strong");f.textContent=n,m.appendChild(f),p.appendChild(m);const g=document.createElement("div");g.className="conflict-summary";const y=document.createElement("strong");y.textContent="Key Differences:";const b=document.createElement("div");b.className="summary-details",b.innerHTML=h,g.appendChild(y),g.appendChild(b);const E=document.createElement("div");E.className="conflict-choices";const w=document.createElement("div");w.className="conflict-option";const v=document.createElement("label"),S=document.createElement("input");S.type="radio",S.name=`resolve_${n}`,S.value="local",S.checked=!0;const T=document.createElement("strong");if(T.textContent="Keep Local Version ",i){const e=document.createElement("span");e.className="default-tag",e.textContent="(default)",T.appendChild(e)}const C=document.createElement("pre");C.textContent=d,v.appendChild(S),v.appendChild(T),w.appendChild(v),w.appendChild(C);const A=document.createElement("div");A.className="conflict-option";const _=document.createElement("label"),k=document.createElement("input");k.type="radio",k.name=`resolve_${n}`,k.value="cloud";const N=document.createElement("strong");if(N.textContent="Use Cloud Version ",s){const e=document.createElement("span");e.className="default-tag",e.textContent="(default)",N.appendChild(e)}const R=document.createElement("pre");return R.textContent=u,_.appendChild(k),_.appendChild(N),A.appendChild(_),A.appendChild(R),E.appendChild(w),E.appendChild(A),r.appendChild(p),r.appendChild(g),r.appendChild(E),r},createActionButtons(e,t){const n=document.createElement("div");n.className="conflict-actions";const a=document.createElement("button");a.textContent="Apply Choices & Sync",a.className="ae-btn ae-btn-primary",a.onclick=e;const o=document.createElement("button");return o.textContent="Cancel",o.className="ae-btn ae-btn-secondary",o.onclick=t,n.appendChild(a),n.appendChild(o),n}},C={_STATE_STORAGE_KEY:"ae_oauth_state",_rand(e=16){const n=new Uint8Array(e);return(t.page.crypto||t.sandbox.crypto).getRandomValues(n),Array.from(n).map((e=>e.toString(16).padStart(2,"0"))).join("")},createState(){const e={v:1,nonce:this._rand(16),ts:Date.now()};return f.setItem(this._STATE_STORAGE_KEY,JSON.stringify(e)),e},readState(){try{return JSON.parse(f.getItem(this._STATE_STORAGE_KEY)||"null")}catch{return null}},clearState(){f.removeItem(this._STATE_STORAGE_KEY)},buildAuthURL({prompt:e="select_account",loginHint:t}={}){if(!E.AUTH_REDIRECT_URL)return E.AUTH_HELPER_URL;const n=this.createState(),a=new URLSearchParams({client_id:E.CLIENT_ID,redirect_uri:E.AUTH_REDIRECT_URL,response_type:"token",scope:E.SCOPE,include_granted_scopes:"true",prompt:e,state:btoa(JSON.stringify(n))});return t&&a.set("login_hint",t),`${E.OAUTH2_AUTHORIZE_URL}?${a.toString()}`},verifyState(e){try{const t=this.readState();if(!e||!t)return!1;const n=JSON.parse(atob(e)),a=Date.now()-Number(n.ts||0)<3e5;return!(n.v!==t.v||n.nonce!==t.nonce||!a)&&(this.clearState(),!0)}catch{return!1}}},A={isInitialized:!1,eventListeners:new Map,operationLock:!1,operationQueue:[],healthCheckInterval:null,initializationPromise:null,async init(e=!0){return this.isInitialized||this.initializationPromise||(this.initializationPromise=this.performInitialization(e)),this.initializationPromise},async performInitialization(e){try{m.info("Initializing Google Drive sync module"),E.validateConfiguration(),this.updateSyncStatus("Initializing..."),b.loadAuthFromStorage(),this.setupAuthListener(),this.startHealthCheck(),await this.checkAndHandleExpiredToken(),b.accessToken?(this.setAuthState(!0),e&&S.syncEnabled&&(await this.performSync(),this.updateSyncStatus())):this.updateSyncStatus(),this.isInitialized=!0,m.info("Google Drive sync module initialized successfully"),this.updateSyncStatus()}catch(e){throw m.error("Failed to initialize Google Drive sync",e),this.updateSyncStatus(e.message.includes("timeout")?"Initialization timed out. Please refresh and try again.":"Initialization failed",!0),this.isInitialized=!1,this.initializationPromise=null,e}},_expiryTimerId:null,scheduleExpiryReminder(){if(this._expiryTimerId&&(o(this._expiryTimerId),this._expiryTimerId=null),!b.tokenExpiresAt)return;const e=Math.max(12e4,E.REFRESH_SKEW_MS),t=Math.max(0,b.tokenExpiresAt-Date.now()-e);this._expiryTimerId=a((()=>{if(!b.refreshToken&&b.isAuthenticated){this.updateSyncStatus("Session expiring soon. Click to renew.",!0),k.showToast("Your Google Drive session is expiring soon. Click to renew.",6e3);const e=s.shadow?.getElementById("sync-status");e&&(e.style.cursor="pointer",e.onclick=()=>{e.style.cursor="default",e.onclick=null,this.handleAuthClick()})}}),t)},async driveRequest(e,{method:t="GET",headers:n={},body:a,params:o={},timeout:r,signal:i}={}){if(!b.accessToken)throw new Error("Missing access token for Drive request");const s=/^https?:\/\//i.test(e),l=new URL(s?e:"https://www.googleapis.com/drive/v3"+e);if(o&&"object"==typeof o)for(const[e,t]of Object.entries(o))null!=t&&l.searchParams.set(e,String(t));const c=k.toHeaderObj(n),d=()=>k.universalFetch(l.toString(),{method:t,headers:{...c,Authorization:`Bearer ${b.accessToken}`},body:a,timeout:r});let u=await d();if(401===u.status){m.info("Access token expired during Drive request, attempting refresh");if(!await this.refreshAccessToken(!0)){const e=new Error("Token refresh failed during Drive request");throw e.status=401,e}u=await d()}if(!u.ok){let e,t="";try{e=await u.json(),t=e?.error?.message||""}catch{try{t=await u.text()}catch{}}const n=new Error(`Drive request failed: ${u.status} ${u.statusText}${t?" - "+t:""}`);throw n.status=u.status,e&&(n.result=e),n}return u},handleAuthClick(){try{E.validateConfiguration()}catch(e){return k.showToast("Sync feature is not properly configured.",4e3),void m.error("Auth attempted with invalid configuration",e)}m.info("Starting authentication flow (single-popup)");const e=C.buildAuthURL({prompt:"select_account",loginHint:b.userEmail||void 0}),n=t.page.open(e,"google_signin","width=500,height=650,resizable=yes,scrollbars=yes,status=yes");if(!n)return void k.showToast("Please allow popups for this site to enable sync.",5e3);let a=0;const o=r((()=>{a++,!n||n.closed?(i(o),b.isAuthenticated||(m.info("Authentication popup closed without completion"),a<5?this.updateSyncStatus("Authentication cancelled quickly - popup blocked?",!0):this.updateSyncStatus("Authentication cancelled."))):a>=120&&(i(o),n.close(),this.updateSyncStatus("Authentication timed out.",!0),m.warn("Authentication popup timed out"))}),500)},async uploadGlobalSettingsAndReload(e){let t;E.DEBUG_MODE&&(t=`global_upload_${Date.now()}`,b.addOperation(t,"global_upload")),this.updateSyncStatus("Uploading global settings...");try{let n;try{if(n=JSON.parse(e),!S.validatePreferences(n).valid)throw new Error("Validation failed for the provided settings file.")}catch(e){return k.showToast(`Error: Invalid settings file. ${e.message}`,5e3),m.error("Global upload validation failed",e),void(E.DEBUG_MODE&&b.completeOperation(t,"failed",e))}const a=await this.findOrCreateFile();await this.updateFile(a,JSON.stringify(n)),m.info("Global settings file successfully uploaded to cloud."),this.updateSyncStatus("Applying new settings locally...");const o=n[l.HOSTNAME]||v();Object.assign(S,o),S.save({updateTimestamp:!0}),D.extractArticle({sync:!1}),this.updateLastSyncTime(),k.showToast("Global settings uploaded and applied successfully.",4e3),m.info("Local state reloaded from global upload."),E.DEBUG_MODE&&b.completeOperation(t,"completed")}catch(e){this.handleApiError(e,"Global settings upload failed."),E.DEBUG_MODE&&b.completeOperation(t,"failed",e)}finally{this.updateSyncStatus()}},async handleDisconnectClick(e=!1){let n;E.DEBUG_MODE&&(n=`disconnect_${Date.now()}`,b.addOperation(n,"disconnect"));try{m.info("Starting disconnect process",{wipeLocal:e}),b.isAuthenticated&&b.fileId&&(this.updateSyncStatus("Removing site data from cloud..."),await this.apiOperation((async()=>{let e;try{e=await this.readFile(b.fileId)}catch(e){throw this.handleReadError(e),e}e&&e[l.HOSTNAME]&&(delete e[l.HOSTNAME],await this.updateFile(b.fileId,JSON.stringify(e)),k.showToast("This site's preferences have been removed from the cloud."),m.info("Successfully removed site data from cloud",{hostname:l.HOSTNAME}))})))}catch(e){m.warn("Could not update cloud on disconnect. Proceeding with local cleanup.",e),k.showToast("Note: Could not remove cloud data, but local cleanup will proceed.",3e3)}finally{this.clearAuthState(),e?(this.updateSyncStatus("Clearing local data..."),f.removeItem(w),m.info("Cleared preferences from storage during disconnect"),this.updateSyncStatus("Disconnected & wiped. Reloading...",!1),a((()=>t.sandbox.location.reload()),1500)):this.updateSyncStatus("Disconnected."),E.DEBUG_MODE&&b.completeOperation(n,"completed")}},async performSync(){b.isAuthenticated?this.enqueueOperation(this._performSync.bind(this)):m.debug("Sync skipped - not authenticated")},async performSyncOperation(){const e=await this.findOrCreateFile();if(!e)throw new Error("Could not get or create preferences file ID.");let t={};try{const n=await this.readFile(e),a=S.validatePreferences(n);if(!a.valid)throw new Error(`Cloud preferences invalid: ${a.errors.join("; ")}`);t=n}catch(e){if(this.handleReadError(e),404!==e.status)throw m.error("Failed to fetch or validate cloud preferences",e),e;m.info("Preferences file not found on Drive, will be created on upload.")}const n=S.toObject(),a=t?.[l.HOSTNAME],o=x.isObjectUniformlyDefault(n),r=!a||x.isObjectUniformlyDefault(a);if(o&&!r)return m.info("Local is default, cloud has settings. Auto-downloading."),this.updateSyncStatus("Downloading settings from cloud..."),S.updateCurrentDomainFromCloud(a),void this.updateSyncStatus("Settings updated from cloud.");if(!o&&r)return m.info("Local has settings, cloud is empty. Auto-uploading."),void await this._upload();const i=x.computeDiff(n,a);0===i.length?(m.info("Settings are in sync."),this.updateSyncStatus("Settings are up to date.")):(m.info(`Found ${i.length} differences. Showing conflict resolver.`),this.updateSyncStatus("Conflict detected. User action required.",!0),this.showConflictResolver(n,a,i))},async upload(){b.isAuthenticated?this.enqueueOperation(this._upload.bind(this)):m.warn("Upload attempted without authentication")},cleanup(){m.info("Starting cleanup process"),this.debouncedUpload&&this.debouncedUpload.cancel&&(this.debouncedUpload.cancel(),m.debug("Cancelled debounced upload")),this.healthCheckInterval&&(i(this.healthCheckInterval),this.healthCheckInterval=null,m.debug("Cleared health check interval")),this.operationQueue.length=0,m.debug("Cleared operation queue"),this.eventListeners.forEach((({target:e,handler:t})=>{e.removeEventListener("message",t,!1)})),this.eventListeners.clear(),this.isInitialized=!1,this.operationLock=!1,this.initializationPromise=null,m.info("Cleanup completed")},async retryInitialization(){m.info("Retrying initialization"),this.cleanup(),this.isInitialized=!1,this.initializationPromise=null;try{await this.init(!0),k.showToast("Sync initialized successfully!")}catch(e){m.error("Retry initialization failed",e),k.showToast("Initialization retry failed. Please refresh the page.",5e3)}},updateSyncStatus(e="",t=!1){const n=s.shadow?.getElementById("sync-status");if(!n)return;let a=e;if(!e)if(S.syncEnabled)if(b.isAuthenticated){if(n.style.cursor="default",n.onclick=null,a=`Connected as ${b.userEmail||"..."}. `,this.isOperationInProgress()){const e=this.operationQueue.length;a+="Syncing...",e>0&&(a+=` (${e} pending)`)}else if(this.operationQueue.length>0){const e=this.operationQueue.length;a+=` ${e} operation${e>1?"s":""} queued.`}else if(a+=b.lastSyncTimestamp?`Last sync: ${new Date(b.lastSyncTimestamp).toLocaleString()}`:"Ready to sync.",E.DEBUG_MODE&&b.operationHistory.length>0){const e=b.operationHistory[b.operationHistory.length-1];a+=` (Last: ${e.type} ${e.status})`}}else n.style.cursor="default",n.onclick=null,a="Not connected. Click to authorize.";else a="Sync is disabled for this site.";n.textContent=a,n.style.color=t?"red":"",n.style.alignSelf="center";const o=s.shadow?.getElementById("sync-connect-btn"),r=s.shadow?.getElementById("sync-disconnect-btn"),i=s.shadow?.getElementById("import-export-container");if(o&&r&&i){const e=S.syncEnabled&&!b.isAuthenticated;[{element:o,show:e},{element:r,show:!e},{element:i,show:!e}].forEach((({element:e,show:t})=>{e.classList.toggle("invisible",!t)}))}},showConflictResolver(e,t,n){const a=s.shadow?.getElementById("sync-conflict-resolver");if(!a)return;a.innerHTML="",m.info("Showing per-setting conflict resolver UI");const o=T.createConflictDescription(n.length>0);a.appendChild(o);const r=document.createElement("form");r.className="conflict-form",a.appendChild(r);const i=v();n.forEach((e=>{const t=T.createPerSettingRow(e,i);r.appendChild(t)}));const l=T.createActionButtons((()=>{m.info("User chose to resolve conflicts.");const t={...e};n.forEach((e=>{const n=r.querySelector(`input[name="resolve_${e.key}"]:checked`);n&&"cloud"===n.value&&(void 0===e.cloud?t[e.key]=i[e.key]:t[e.key]=e.cloud)})),this.hideConflictResolver();this.enqueueOperation((async()=>{try{Object.assign(S,t),S.save({updateTimestamp:!0}),D.extractArticle({sync:!1}),m.info("Resolved settings applied locally and UI refreshed. Triggering upload."),k.showToast("Applying choices and syncing to cloud...",3e3),await this._upload()}catch(e){m.error("Failed to save or upload resolved preferences",e),k.showToast("Failed to apply choices.",4e3)}}).bind(this))}),(()=>{m.info("User cancelled conflict resolution."),this.hideConflictResolver(),this.updateSyncStatus("Conflict resolution cancelled.")}));a.appendChild(l),a.classList.add("visible"),k.showToast("Cloud conflict detected, resolve in cloud sync tab.",4e3);const c=s.shadow?.querySelector(".ae-advanced-options");if(c&&!c.classList.contains("visible")){const e=s.shadow?.getElementById("options-chevron")?.parentElement;e&&!e.nextSibling?.classList.contains("visible")&&e.click()}const d=s.shadow?.getElementById("sync-tab");d?.classList.contains("selected")||(d.click(),d.scrollIntoView({behavior:"instant",block:"start"}))},hideConflictResolver(){const e=s.shadow?.getElementById("sync-conflict-resolver");e&&(e.classList.remove("visible"),e.innerHTML="",m.debug("Conflict resolver hidden"))},isOperationInProgress(){return this.operationLock},setOperationLock(e){this.operationLock=e,m.debug("Operation lock "+(e?"acquired":"released")),this.updateSyncStatus()},enqueueOperation(e){const t=e.name||"anonymous";m.debug(`Enqueuing operation: ${t.replace(/^_/,"")}`,{queueSize:this.operationQueue.length}),this.operationQueue.push(e),this.updateSyncStatus(),a((()=>this.processQueue()),0)},async processQueue(){for(;!this.isOperationInProgress()&&this.operationQueue.length>0;){this.setOperationLock(!0);const e=this.operationQueue.shift();try{const t=e.name||"anonymous";m.info(`Processing operation from queue: ${t.replace(/^_/,"")}`,{remaining:this.operationQueue.length}),await p(e,1,1e3,{perAttemptTimeout:E.OPERATION_TIMEOUT_MS})}catch(t){const n=e.name||"anonymous";m.error(`Unhandled error during queued operation: ${n}`,t)}finally{this.setOperationLock(!1)}}},async _performSync(){let e;E.DEBUG_MODE&&(e=`sync_${Date.now()}_${Math.random()}`,b.addOperation(e,"sync"));try{if(!S.syncEnabled)return m.debug("Sync skipped - disabled for current domain"),this.updateSyncStatus(),void(E.DEBUG_MODE&&b.completeOperation(e,"skipped"));m.info("Starting sync operation"),this.updateSyncStatus("Checking for updates..."),this.hideConflictResolver(),await this.performSyncOperation(),this.updateLastSyncTime(),E.DEBUG_MODE&&b.completeOperation(e,"completed")}catch(t){const n=t.message.includes("timed out")?"Sync timed out":"Sync failed";this.handleApiError(t,`${n}, using local settings.`),E.DEBUG_MODE&&b.completeOperation(e,"failed",t)}finally{this.updateSyncStatus()}},async _upload(){let e;E.DEBUG_MODE&&(e=`upload_${Date.now()}_${Math.random()}`,b.addOperation(e,"upload")),this.updateSyncStatus("Uploading settings...");try{m.info("Starting upload operation");const t=await this.findOrCreateFile();let n={};try{this.updateSyncStatus("Reading current cloud settings..."),n=await this.readFile(t);if(!S.validatePreferences(n).valid)throw new Error("Invalid cloud preferences structure")}catch(e){if(this.handleReadError(e),404!==e.status)throw m.error("Failed to fetch or validate cloud preferences",e),e;m.warn("Could not read cloud file, it may be new or empty.",e)}this.updateSyncStatus("Merging preferences...");const a={[l.HOSTNAME]:S.toObject()},o=this.computeMergedPreferences(n,a);if(!S.validatePreferences(o).valid)throw new Error("Merged preferences failed validation");this.updateSyncStatus("Uploading to Google Drive..."),await this.updateFile(t,JSON.stringify(o)),this.updateLastSyncTime(),k.showToast("Settings saved to Google Drive."),m.info("Upload completed successfully"),E.DEBUG_MODE&&b.completeOperation(e,"completed")}catch(t){this.handleApiError(t,"Upload failed."),E.DEBUG_MODE&&b.completeOperation(e,"failed",t)}finally{this.updateSyncStatus()}},setupAuthListener(){let e=this.eventListeners.get("message-sandbox")?.handler;e||(e=this.handleTokenFromPopup.bind(this)),this.eventListeners.has("message-sandbox")||(t.sandbox.addEventListener("message",e,!1),this.eventListeners.set("message-sandbox",{target:t.sandbox,handler:e})),t.page===t.sandbox||this.eventListeners.has("message-page")||(t.page.addEventListener("message",e,!1),this.eventListeners.set("message-page",{target:t.page,handler:e}))},handleTokenFromPopup(e){if(!e.data)return;if(!!(!e.data.access_token&&!e.data.error&&"ae-google-oauth"!==e.data.source))return;if(!E.ALLOWED_ORIGINS.some((t=>e.origin===t)))return m.error("Received token from unauthorized origin",{origin:e.origin}),void this.updateSyncStatus("Security error: Invalid origin",!0);const t=e.data;if(m.debug("Received token response from popup",{hasToken:!!t.access_token,hasError:!!t.error}),!t.error&&t.state){if(!C.verifyState(t.state))return m.error("OAuth state verification failed"),void this.updateSyncStatus("Security error: State mismatch",!0)}if(t.error)return m.error("OAuth error received",t),void this.updateSyncStatus(`Error: ${t.error_description||t.error}`,!0);try{if(b.accessToken=t.access_token,f.setItem("ae_gdrive_atk",g(b.accessToken)),t.expires_in&&(b.tokenExpiresAt=Date.now()+1e3*t.expires_in,f.setItem("ae_gdrive_exp",b.tokenExpiresAt.toString()),this.scheduleExpiryReminder()),t.refresh_token&&(b.refreshToken=t.refresh_token,f.setItem("ae_gdrive_rtk",g(t.refresh_token))),!b.refreshToken){const e=Number(t.expires_in)||3600,n=Math.max(1,Math.round(e/60));m.warn("No refresh token received during authentication"),E.REFRESH_CONFIGURED?k.showToast(`Warning: No refresh token received. Session will expire in ~${n} min.`,3e3):k.showToast(`Session will expire in ~${n} min.`,3e3)}b.isAuthenticated||(this.setAuthState(!0),this.fetchUserEmail(),this.performSync(),this.updateSyncStatus()),m.info("Authentication completed successfully")}catch(e){m.error("Failed to process authentication token",e),this.updateSyncStatus("Failed to process authentication",!0)}},setAuthState(e){const t=b.isAuthenticated;b.isAuthenticated=e,b.retryCount=0,e||this.clearAuthState(),t!==e&&m.info(`Authentication state changed: ${t} → ${e}`),this.updateSyncStatus()},clearAuthState(){m.debug("Clearing authentication state"),b.isAuthenticated=!1,b.accessToken=null,b.refreshToken=null,b.tokenExpiresAt=null,b.fileId=null,b.userEmail=null,b.retryCount=0,b.lastSyncTimestamp=null,l.SYNC.authKeys.forEach((e=>f.removeItem(e))),this.updateSyncStatus()},async checkAndHandleExpiredToken(){if(b.refreshToken&&(!b.accessToken||b.tokenExpiresAt&&Date.now()>=b.tokenExpiresAt-E.REFRESH_SKEW_MS)){m.info("Access token missing or expired (with skew), attempting refresh");return await this.refreshAccessToken(!0)||(m.warn("Failed to refresh expired token, clearing authentication"),this.clearAuthState(),this.updateSyncStatus("Session expired, please reconnect.",!0)),!0}return!1},async fetchUserEmail(){if(!b.accessToken)return void m.warn("Attempted to fetch user email without access token");const e=async()=>{m.debug("Fetching user email from Google API");const e=await this.driveRequest("https://www.googleapis.com/oauth2/v3/userinfo",{timeout:E.OPERATION_TIMEOUT_MS});if(!e.ok)throw new Error(`userinfo API error: ${e.status} ${e.statusText}`);return e.json()};try{const t=await p(e,2,1e3);b.userEmail=t.email,f.setItem("ae_gdrive_uem",g(t.email)),m.info("User email fetched successfully",{email:t.email}),this.updateSyncStatus()}catch(e){m.error("Failed to get user email",e),k.showToast("Could not fetch user information, but sync should still work.",3e3)}},apiOperation:async e=>p(((t,n)=>e()),b.maxRetries,1e3,{isRetryable:e=>{const t="number"==typeof e?.status&&e.status||"number"==typeof e?.result?.error?.code&&e.result.error.code||void 0;return void 0===t||429===t||408===t||t>=500&&t<600},perAttemptTimeout:E.OPERATION_TIMEOUT_MS}),async findOrCreateFile(){if(b.fileId)return m.debug("Using cached file ID"),b.fileId;const e=String(E.PREFERENCES_FILENAME).replace(/'/g,"\\'");return await this.apiOperation((async()=>{m.debug("Searching for preferences file in Google Drive"),this.updateSyncStatus("Searching for settings file...");const t=await this.driveRequest("/files",{params:{spaces:"appDataFolder",q:`name='${e}' and trashed=false`,fields:"files(id,name,createdTime)",orderBy:"createdTime desc"}}),n=(await t.json()).files;if(n&&n.length>0)n.length>1&&m.warn(`Found ${n.length} preferences files, using most recent`),b.fileId=n[0].id,m.info("Found existing preferences file",{fileId:b.fileId});else{m.info("No preferences file found, creating new one"),this.updateSyncStatus("No settings file found, creating one...");const t={name:e,parents:["appDataFolder"],mimeType:"application/json"},n=await this.driveRequest("/files",{method:"POST",headers:{"Content-Type":"application/json"},params:{fields:"id"},body:JSON.stringify(t)}),a=await n.json();b.fileId=a.id,m.info("Created new preferences file",{fileId:b.fileId});const o={[l.HOSTNAME]:S.toObject()},r=this.computeMergedPreferences({},o);await this.updateFile(b.fileId,JSON.stringify(r))}return f.setItem("ae_gdrive_fid",g(b.fileId)),b.fileId}))},async readFile(e,t=!1){return await this.apiOperation((async()=>{m.debug("Reading preferences file from Google Drive",{fileId:e});const n=await this.driveRequest(`/files/${encodeURIComponent(e)}`,{params:{alt:"media"}}),a=n.headers.get("Content-Type")?.toLowerCase()||"",o=await n.arrayBuffer(),r=new Uint8Array(o),i=r.length>=2&&31===r[0]&&139===r[1],s=/(?:^|\/)(?:x-)?gzip\b/.test(a);let c,d=i;s&&!i&&m.warn("Content-Type indicates gzip but magic bytes are missing — treating as plain text",{contentType:a,firstBytes:Array.from(r.slice(0,4))}),!s&&i&&m.warn("GZIP magic bytes present despite non-gzip Content-Type",{contentType:a});try{if(d){if(!l.STREAMS.available){const e=new Error("Failed to decompress GZIP preferences file: DecompressionStream not supported");throw e.status=n.status,e.data=o,e.isCompressed=!0,e}c=await k.gunzipToText(o)}else c=await new Response(o).text()}catch(e){const t=new Error(`Failed to decode file content: ${e.message||e}`);throw t.status=n.status,t.data=o,t.isCompressed=!!d,t}if(!c||!c.trim())return m.info("Empty preferences file detected; treating as {}"),{};try{k.isBase64(c)&&(c=await k.gunzipToText(c));const e=JSON.parse(c||"{}");return m.debug("Successfully parsed preferences file",{domains:Object.keys(e).length}),e}catch(e){const n=new Error(`Invalid JSON in preferences file: ${e.message||"Unknown parse error"}`);n.data=c;const a=c.slice(0,Math.min(1024,c.length));if(m.error("Failed to parse preferences file JSON (excerpt follows)",{excerpt:a}),t)return c;throw n}}))},async updateFile(e,t,n={}){const{compress:a=!0,multipart:o=!1}=n;return await this.apiOperation((async()=>{if(!e)throw new Error("updateFile: fileId is required");m.debug("Updating preferences file on Google Drive",{fileId:e,contentLength:"string"==typeof t?t.length:-1});const n="string"==typeof t?t:JSON.stringify(t);try{JSON.parse(n)}catch(e){throw new Error(`Invalid JSON content for upload: ${e.message}`)}let r=n,i="application/json; charset=UTF-8",s="application/json",c=!1,d={uploadType:"media"},u={"Content-Type":"application/json; charset=UTF-8"},h=n;if(l.STREAMS.available&&a)try{let e,a;if(E.DEBUG_MODE&&(e=await k.gzipString(n),a=await k.gunzipToText(e)),i="application/gzip",s="application/gzip",E.DEBUG_MODE&&a!==n)m.error("GZIP roundtrip validation failed, falling back to uncompressed",{originalLength:n.length,decompressedLength:a.length});else{const e="-------"+Math.random().toString(36).slice(2);if(c=!0,o){r=l.SYNC.USERSCRIPT_NETWORKING?await k.gzipString(t,{as:"base64"}):await k.gzipString(t),u={"Content-Type":`multipart/related; boundary=${e}`},d={uploadType:"multipart"};const n={mimeType:s};h=new Blob(["--"+e+"\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n"+JSON.stringify(n)+"\r\n","--"+e+"\r\nContent-Type: "+i+"\r\n\r\n",r,"\r\n--"+e+"--\r\n"])}else h=l.SYNC.USERSCRIPT_NETWORKING?await k.gzipString(t,{as:"base64"}):await k.gzipString(t),u={"Content-Type":i};m.debug("GZIP compression validated successfully")}}catch(e){m.error("GZIP compression or validation failed, falling back to uncompressed",e)}const p=await this.driveRequest(`https://www.googleapis.com/upload/drive/v3/files/${encodeURIComponent(e)}`,{method:"PATCH",headers:u,params:d,body:h});let f={};try{f=await p.json()}catch(e){}return m.debug("File updated successfully"),f}))},handleApiError(e,t){const n=401===e.status||e.result&&e.result.error&&401===e.result.error.code,o=429===e.status||e.result&&e.result.error&&429===e.result.error.code,r=!e.status&&(e.message.includes("network")||e.message.includes("fetch"));m.error("API operation failed",{error:e.message,status:e.status,isAuthError:n,isRateLimited:o,isNetworkError:r}),n?(this.updateSyncStatus("Authentication error. Please reconnect.",!0),this.clearAuthState(),a((()=>{b.isAuthenticated||k.showToast("Please click the sync button to reconnect.",5e3)}),2e3)):o?(this.updateSyncStatus("Rate limited. Please try again later.",!0),k.showToast("Google Drive sync is temporarily rate limited. Will retry automatically.",4e3)):r?(this.updateSyncStatus("Network error. Check your connection.",!0),k.showToast("Network error during sync. Please check your internet connection.",4e3)):(this.updateSyncStatus(t,!0),k.showToast(t,4e3))},handleReadError(e){e.message.startsWith("Invalid JSON in preferences file")?(this.downloadRawContent(e.data,!1),m.info("Downloaded corrupted preferences file for correction")):e.message.startsWith("Failed to decode file content")?(this.downloadRawContent(e.data,e.isCompressed||!1),m.info("Downloaded undecodable preferences file for correction")):e.message.startsWith("Failed to decompress GZIP preferences file")&&(this.downloadRawContent(e.data,!0),m.info("Downloaded compressed preferences file for correction"))},updateLastSyncTime(){b.lastSyncTimestamp=(new Date).toISOString(),b.retryCount=0,m.debug("Updated last sync timestamp")},computeMergedPreferences(e,t){const n={},a=v();m.debug("Computing merged preferences",{localDomains:Object.keys(t).length,cloudDomains:Object.keys(e).length});for(const o in t)if(Object.hasOwnProperty.call(t,o)){const r=t[o],i={};let s=!1;for(const e in r)if(Object.hasOwnProperty.call(r,e)){if(E.LOCAL_ONLY_PREFS&&E.LOCAL_ONLY_PREFS.includes(e))continue;const t=r[e],n=a[e];let o=!1;o=void 0!==n&&(Array.isArray(t)?x.arrayEquals(t,n):t===n),o||(i[e]=t,"modifiedTime"!==e&&(s=!0))}s?n[o]=i:e[o]&&(n[o]={})}const o={...e,...n};for(const e in o)0===Object.keys(o[e]).length&&delete o[e];return m.debug("Merged preferences computed",{finalDomains:Object.keys(o).length,domainsAdded:Object.keys(n).length}),o},async refreshAccessToken(e=!1){if(!b.refreshToken)return m.debug("No refresh token available"),!1;if(!e&&b.tokenExpiresAt&&Date.now()<b.tokenExpiresAt-E.REFRESH_SKEW_MS)return m.debug("Token still valid, refresh not needed"),!0;m.info("Attempting to refresh access token",{force:e});try{const e=new URLSearchParams({client_id:E.CLIENT_ID,grant_type:"refresh_token",refresh_token:b.refreshToken}),t=E.CLIENT_SECRET;t&&"YOUR_CLIENT_SECRET"!==t&&e.append("client_secret",t);const n=await k.universalFetch(E.TOKEN_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e.toString(),timeout:E.OPERATION_TIMEOUT_MS});if(!n.ok){const e=await n.json().catch((()=>({})));throw"invalid_grant"===e.error&&(m.error("Refresh token is invalid. Clearing authentication.",e),this.clearAuthState()),new Error(`Token refresh failed (${n.status}): ${e.error||"Unknown error"}`)}const a=await n.json();return b.accessToken=a.access_token,b.tokenExpiresAt=Date.now()+1e3*a.expires_in,f.setItem("ae_gdrive_atk",g(b.accessToken)),f.setItem("ae_gdrive_exp",b.tokenExpiresAt.toString()),this.scheduleExpiryReminder(),m.info("Access token refreshed successfully"),!0}catch(t){const n=t?.result||{};return"invalid_grant"===("string"==typeof n.error?n.error:n.error?.error||void 0)&&(m.error("Refresh token is invalid. Clearing authentication.",n),this.clearAuthState()),m.error("refreshAccessToken() failed",t),e&&this.clearAuthState(),!1}},async healthCheck(){if(!b.isAuthenticated||!b.accessToken)return!1;m.debug("Performing health check");await this.refreshAccessToken(!1)||m.warn("Proactive token refresh failed during health check");try{const e=await k.universalFetch("https://www.googleapis.com/oauth2/v3/tokeninfo?access_token="+encodeURIComponent(b.accessToken),{timeout:E.OPERATION_TIMEOUT_MS});if(e.ok)return m.debug("Health check passed (token valid)"),!0;if(401!==e.status)return!1;m.warn(`Token ping failed with status ${e.status}. Forcing refresh.`);const t=await this.refreshAccessToken(!0);return t||this.clearAuthState(),t}catch(e){return m.error("Health check failed due to network or other error",e),!1}},startHealthCheck(){this.healthCheckInterval?m.debug("Health check interval already running"):(this.healthCheckInterval=r((async()=>{if(b.isAuthenticated&&!this.operationLock){await this.healthCheck()||(m.warn("Health check failed. Auth token appears invalid, clearing authentication."),this.clearAuthState(),this.updateSyncStatus("Authentication expired",!0),k.showToast("Your session has expired. Please reconnect.",4e3))}}),E.HEALTH_CHECK_INTERVAL),m.info("Health check interval started"))},downloadRawContent(e,t=!1){const n=t?"preferences.json.gz":"preferences.json",a=new Blob([e],{type:t?"application/gzip":"application/json"}),o=URL.createObjectURL(a),r=document.createElement("a");r.href=o,r.download=n,r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o),t?(k.showToast("Downloaded compressed file. Decompress it (e.g., rename to .gz and unzip) to edit, then upload via import.",7e3),m.info("Downloaded compressed preferences bytes for user decompression/recovery")):(k.showToast("Downloaded corrupted file for correction. Fix and upload via import.",5e3),m.info("Downloaded raw corrupted preferences file for user correction"))}};A.debouncedUpload=h((async()=>{try{await A.upload()}catch(e){m.error("Debounced upload failed",e)}}),E.DEBOUNCE_DELAY),(()=>{const e="ae-readability-"+l.HOSTNAME,t={fontSize:16,fontWidth:100,fontFamily:"system-ui",lineWidth:800,lineHeight:1.5,fontWeight:400,paragraphSpacing:13,textAlign:"left",overlayWidth:l.IS_MOBILE?100:55};let n=null;try{n=JSON.parse(localStorage.getItem(e))}catch(e){console.error("Error loading readability preferences:",e)}const a=Object.assign({},t,n||{});Object.assign(a,{save(){try{localStorage.setItem(e,JSON.stringify({fontSize:this.fontSize,fontWidth:this.fontWidth,fontFamily:this.fontFamily,lineWidth:this.lineWidth,lineHeight:this.lineHeight,fontWeight:this.fontWeight,paragraphSpacing:this.paragraphSpacing,textAlign:this.textAlign,overlayWidth:this.overlayWidth}))}catch(e){console.error("Error saving readability preferences:",e)}}}),s.readabilityPrefs=a})();const _={readabilityContent:null,metadata:null,updateContent:null,findArticleCache:null,css:null},k={applyStyles(e,t){Object.assign(e.style,t)},makeInert(e=!0){[...document.body.children,...document.head.children].forEach((t=>{"ae-host"==t.id||t.classList.contains("ae")||(t.inert=e)}))},toHeaderObj(e){const t={};if(!e)return t;if("undefined"!=typeof Headers&&e instanceof Headers)try{e.forEach(((e,n)=>t[n]=e))}catch{for(const[n,a]of e.entries())t[n]=a}else if(Array.isArray(e))for(const[n,a]of e)t[n]=String(a);else if("object"==typeof e)for(const n in e)e.hasOwnProperty(n)&&(t[n]=String(e[n]));return t},loadedScriptsCache:{},loadScript(e,n,r={}){const{onUserError:i,attributes:s={},pollTimeout:l=5e3,loadTimeout:c=15e3,useObserver:d=!0,cleanup:u=!0,forceReload:h=!1,globalTest:p,signal:m,retryAttempts:f=0,retryDelay:g=1e3}=r,y=k.loadedScriptsCache||(k.loadedScriptsCache={});if(!e||"string"!=typeof e||!e.trim())throw new Error("A valid script URL is required.");const b=e=>{try{return new URL(e,document.baseURI).href}catch{return e}},E=b(e);h&&delete y[E];const w=e=>!(!e||void 0===(e=>e?t.page[e]:void 0)(e)),v=()=>{if("function"==typeof p)try{return!!p(t.page)}catch{return!1}return w(n)},S=()=>new Error(`Aborted while waiting for ${n||"script readiness"}`),x=e=>{if(!n&&"function"!=typeof p)return Promise.resolve();if(v())return Promise.resolve();if(m&&m.aborted)return Promise.reject(S());const t=Date.now()+Math.max(0,e||0);let r=50,i=null,s=null;return new Promise(((n,l)=>{const c=()=>{i&&(o(i),i=null),s&&(s.disconnect(),s=null),m&&m.removeEventListener("abort",h)},u=e=>{c(),l(e)},h=()=>u(S()),p=()=>v()?(c(),void n()):Date.now()>=t?u(new Error(`Readiness not detected within ${e}ms for: ${E}`)):void 0;if(m&&m.addEventListener("abort",h,{once:!0}),d&&"undefined"!=typeof MutationObserver){s=new MutationObserver((e=>{e.some((e=>Array.from(e.addedNodes).some((e=>"SCRIPT"===e.tagName||e.nodeType===Node.ELEMENT_NODE&&e.querySelector("script")))))&&a(p,10)}));[document.head,document.body].filter(Boolean).forEach((e=>s.observe(e,{childList:!0,subtree:!0})))}const f=()=>{p(),!v()&&Date.now()<t&&(r=Math.min(1.5*r+50*Math.random(),1e3),i=a(f,r))};i=a(f,50)}))},T=(e,t)=>{const n=e.getAttribute(t);return null==n?null:String(n)},C=(e=0)=>m&&m.aborted?Promise.reject(S()):new Promise(((t,n)=>{const r={...s};!("integrity"in r)||"crossorigin"in r||"crossOrigin"in r||(r.crossorigin="anonymous");let l=!1;const d=o=>{if(!l){if(l=!0,e<f&&(!m||!m.aborted))return console.warn(`Retrying script load (${e+1}/${f+1}): ${E}`),void a((()=>{C(e+1).then(t).catch(n)}),g*Math.pow(2,e));try{i&&i(o.message)}catch{}u&&delete y[E],n(o)}},h=()=>{l||(l=!0,t())},p=Array.from(document.getElementsByTagName("script")).find((e=>b(e.src)===E));if(p){try{((e,t)=>{const n=[],a=[];for(const[i,s]of Object.entries(t||{})){const t=(o=i,"boolean"==typeof(r=s)?r?["async","defer","nomodule"].includes(o)?o:"":null:null==r?null:String(r)),l=T(e,i);if(t!==l){const e={key:i,expected:t,actual:l};n.push(e),["integrity","crossorigin","nonce"].includes(i)&&a.push(e)}}var o,r;if(n.length&&(console.warn(`Script ${E} has attribute mismatches:`,n),a.length))throw new Error(`Security-critical attribute mismatch for ${E}: `+a.map((e=>`${e.key}=${e.expected} vs ${e.actual}`)).join(", "))})(p,r)}catch(e){return d(e)}const e=()=>{try{p.dataset.loaded="true",p.dataset.loadTime=String(Date.now()),p.dataset.loadDuration=String(Date.now()-(parseInt(p.dataset.loadStart)||Date.now()))}catch{}};if("loaded"===p.readyState||"complete"===p.readyState||"true"===p.dataset.loaded)return e(),h();let t=null;const n=()=>{p.removeEventListener("load",i),p.removeEventListener("error",s),m&&p.removeEventListener("abort",l),t&&(o(t),t=null)},i=()=>{n(),e(),h()},s=e=>{n(),d(new Error(`Failed to load existing script: ${E} (${e.type||"network error"})`))},l=()=>{n(),d(S())};return p.addEventListener("load",i,{once:!0}),p.addEventListener("error",s,{once:!0}),m&&m.addEventListener("abort",l,{once:!0}),void(c>0&&(t=a((()=>{n(),d(new Error(`Timeout loading existing script after ${c}ms: ${E}`))}),c)))}const w=document.createElement("script");w.className="ae",w.dataset.url=E,w.dataset.loadStart=String(Date.now()),w.dataset.attempt=String(e+1);const v="async"in r,x="defer"in r,A="module"===String(r.type||"").toLowerCase();v||x||A||(w.async=!0),((e,t)=>{for(const[n,a]of Object.entries(t))if("boolean"==typeof a)if(a){const t=["async","defer","nomodule","hidden"];e.setAttribute(n,t.includes(n)?n:"")}else e.removeAttribute(n);else null!=a?e.setAttribute(n,String(a)):e.removeAttribute(n)})(w,r);let _=null;const k=()=>{w.removeEventListener("load",N),w.removeEventListener("error",R),m&&w.removeEventListener("abort",I),_&&(o(_),_=null)},N=()=>{k();try{w.dataset.loaded="true",w.dataset.loadTime=String(Date.now()),w.dataset.loadDuration=String(Date.now()-parseInt(w.dataset.loadStart,10))}catch{}h()},R=e=>{k();try{w.dataset.failed="true",w.dataset.errorType=e.type||"unknown",w.remove()}catch{}d(new Error(`Failed to load script: ${E} (${e.type||"network error"})`))},I=()=>{k();try{w.dataset.aborted="true",w.remove()}catch{}d(S())};w.addEventListener("load",N,{once:!0}),w.addEventListener("error",R,{once:!0}),m&&m.addEventListener("abort",I,{once:!0}),c>0&&(_=a((()=>{k();try{w.dataset.timedOut="true",w.remove()}catch{}d(new Error(`Script load timeout after ${c}ms (attempt ${e+1}): ${E}`))}),c)),w.src=E;const L=document.head||document.getElementsByTagName("head")[0]||document.documentElement;if(!L)return d(new Error("No suitable DOM insertion point found"));L.appendChild(w)}));return y[E]||(y[E]=C()),y[E].then((()=>x(l))).catch((e=>{const t=new Error(`Script loading pipeline failed for ${E}: ${e.message}`);t.originalError=e,t.url=E;try{i&&i(t.message)}catch{}throw t}))},async universalFetch(e,t={}){const n="function"==typeof fetch,r="undefined"!=typeof GM&&GM.xmlHttpRequest?GM.xmlHttpRequest:null,i="undefined"!=typeof GM_xmlhttpRequest?GM_xmlhttpRequest:"undefined"!=typeof GM_xmlHttpRequest?GM_xmlHttpRequest:null;let s,l={};"undefined"!=typeof Request&&e instanceof Request?(s=e.url,l={method:e.method,headers:e.headers,body:e.body??void 0,credentials:e.credentials,signal:e.signal}):s="string"==typeof e?e:String(e?.url??e);const c={...l,...t},d="undefined"!=typeof GM||"undefined"!=typeof GM_xmlhttpRequest||"undefined"!=typeof GM_xmlHttpRequest,u=!(!r&&!i);if(!(c.forceGM||!n&&u||d&&u)){if(!n)return Promise.reject(new Error("fetch is unavailable and GM.xmlHttpRequest not requested/available."));const e="number"==typeof c.timeout&&c.timeout>0;if(!e&&c.signal?.aborted)return Promise.reject(p(c.signal?.reason));if(e){const e=c.signal,t=new AbortController,n=a((()=>t.abort(new Error("Timeout"))),c.timeout);let r;e&&(e.aborted?t.abort(e.reason):(r=()=>t.abort(e.reason),e.addEventListener("abort",r,{once:!0})));try{const{timeout:e,forceGM:n,...a}=c;return await fetch(s,{...a,signal:t.signal})}finally{o(n),e&&r&&e.removeEventListener("abort",r)}}const{timeout:t,forceGM:r,...i}=c;return fetch(s,i)}if(!u)return Promise.reject(new Error("GM.xmlHttpRequest/GM_xmlhttpRequest is unavailable."));const h=()=>{switch(c.credentials??"same-origin"){case"include":return!1;case"omit":return!0;case"same-origin":try{const e="undefined"!=typeof location?location:null;if(!e)return!0;return new URL(s,e.href).origin!==e.origin}catch{return!0}default:return!0}},p=e=>{try{return new DOMException(e||"The operation was aborted","AbortError")}catch{const t=new Error(e||"The operation was aborted");return t.name="AbortError",t}};return new Promise((async(e,t)=>{const n=(c.method||"GET").toUpperCase(),a=k.toHeaderObj(c.headers);let{data:o,binary:l}=await(async(e,t)=>{if(null==e)return{data:void 0,binary:!1};if("string"==typeof e)return{data:e,binary:!1};if("undefined"!=typeof URLSearchParams&&e instanceof URLSearchParams)return t["Content-Type"]??="application/x-www-form-urlencoded;charset=UTF-8",{data:e.toString(),binary:!1};if("undefined"!=typeof FormData&&e instanceof FormData)return{data:e,binary:!1};if("undefined"!=typeof Blob&&e instanceof Blob){e.type&&!t["Content-Type"]&&(t["Content-Type"]=e.type);const n=await e.arrayBuffer();return t["Content-Type"]??=e.type||"application/octet-stream",{data:n,binary:!0}}if((n=e)&&"object"==typeof n&&"number"==typeof n.byteLength&&"number"==typeof n.byteOffset&&n.buffer instanceof ArrayBuffer){const n=e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength);return t["Content-Type"]??="application/octet-stream",{data:n,binary:!0}}var n;if(e instanceof ArrayBuffer)return t["Content-Type"]??="application/octet-stream",{data:e,binary:!0};if("undefined"!=typeof ReadableStream&&e instanceof ReadableStream){const t=e.getReader(),n=[];let a=0;try{for(;;){const{done:e,value:o}=await t.read();if(e)break;n.push(o),a+=o.byteLength}}finally{t.releaseLock()}const o=new Uint8Array(a);let r=0;for(const e of n)o.set(new Uint8Array(e),r),r+=e.byteLength;return{data:o.buffer,binary:!0}}return t["Content-Type"]??="application/json;charset=UTF-8",{data:JSON.stringify(e),binary:!1}})(c.body,a);const d=c.signal;let u=!1,m=null;const f=(e,t)=>{u||(u=!0,g(),e(t))},g=()=>{if(d&&y)try{d.removeEventListener("abort",y)}catch{}},y=()=>{try{m?.abort?.()}catch{}f(t,p(d?.reason))};if(d?.aborted)return f(t,p(d.reason));const b={method:n,url:s,headers:a,data:o,binary:l||false,responseType:"arraybuffer",anonymous:h(),timeout:c.timeout||0,onload:t=>{const n=new Map;(t.responseHeaders||"").split(/\r?\n/).forEach((e=>{const t=e.indexOf(":");if(t>0){const a=e.slice(0,t).trim().toLowerCase(),o=e.slice(t+1).trim();a&&(n.has(a)?n.set(a,`${n.get(a)}, ${o}`):n.set(a,o))}}));const a=new Headers;n.forEach(((e,t)=>a.set(t,e)));const o=t.status>>>0,r=t.statusText||"",i=t.finalUrl||t.responseURL||s,l=!(!t.finalUrl||t.finalUrl===s);let c;if(t.response instanceof ArrayBuffer)c=t.response;else if("string"==typeof t.response){const e=t.response,n=new Uint8Array(e.length);for(let t=0;t<e.length;t++)n[t]=255&e.charCodeAt(t);c=n.buffer}else if(t.responseText){const e=t.responseText,n=new Uint8Array(e.length);for(let t=0;t<e.length;t++)n[t]=255&e.charCodeAt(t);c=n.buffer}else c=new ArrayBuffer(0);const d=(e,t,n=!1)=>{let a=n;const s=()=>{if(a)throw new TypeError("Body has already been consumed.");a=!0};return{ok:o>=200&&o<300,status:o,statusText:r,url:i,redirected:l,type:"cors",headers:new Headers(t),body:null,get bodyUsed(){return a},async text(){return s(),((e,t)=>{const n=new Uint8Array(e),a=(e=>{if(e.length>=3&&239===e[0]&&187===e[1]&&191===e[2])return{encoding:"utf-8",offset:3};if(e.length>=2){if(255===e[0]&&254===e[1])return{encoding:"utf-16le",offset:2};if(254===e[0]&&255===e[1])return{encoding:"utf-16be",offset:2}}return{encoding:"",offset:0}})(n),o=(e=>{if(!e)return"";const t=/charset\s*=\s*([^;,\s]+)/i.exec(e);if(!t)return"";let n=t[1].trim().toLowerCase().replace(/['"]/g,"");return{utf8:"utf-8",latin1:"windows-1252","iso-8859-1":"windows-1252",ascii:"windows-1252","x-user-defined":"windows-1252"}[n]||n})(t),r=a.encoding||o||"utf-8";try{return new TextDecoder(r,{fatal:!1}).decode(n.subarray(a.offset))}catch{return new TextDecoder("utf-8",{fatal:!1}).decode(n.subarray(a.offset))}})(e,this.headers.get("content-type"))},async json(){const e=await this.text();return JSON.parse(e)},arrayBuffer:async()=>(s(),e.slice()),async blob(){s();const t=this.headers.get("content-type")||"application/octet-stream";return new Blob([e],{type:t})},clone(){if(a)throw new TypeError("Body has already been consumed.");return d(e.slice(),this.headers,!1)}}},u=d(c,a);f(e,u)},onerror:e=>{f(t,new TypeError(e?.error||e?.message||"Network request failed"))},onabort:()=>{f(t,p())},ontimeout:()=>{f(t,new TypeError("Network request timed out"))}};d&&d.addEventListener("abort",y,{once:!0});try{if(r)m=r(b),m&&"function"==typeof m.then&&m.then((e=>!u&&b.onload(e))).catch((e=>!u&&b.onerror(e)));else{if(!i)throw new Error("No GM.xmlHttpRequest implementation available");m=i(b)}}catch(e){f(t,e)}}))},async gzipString(e,t={}){if(!l.STREAMS.available)throw new Error("gzipString unavailable: CompressionStream is not supported.");const{serialize:n="auto",as:a="arraybuffer",encoding:o="utf-8",normalizeNewlines:r="preserve",contentTypeForBlob:i,jsonReplacer:s,jsonSpace:c}=t||{},d=e=>{if("string"==typeof e){let t=e;if("preserve"!==r&&(t="lf"===r?t.replace(/\r\n?/g,"\n"):t.replace(/\r?\n/g,"\r\n")),o&&"utf-8"!==o.toLowerCase())throw new Error("gzipString: non-utf8 TextEncoder not supported in this environment");return(new TextEncoder).encode(t)}return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e instanceof ArrayBuffer?new Uint8Array(e):null},u=async()=>{if((t=e)&&"function"==typeof t.getReader)return e;var t;if((e=>!!e&&"function"==typeof e.stream&&"function"==typeof e.arrayBuffer&&"type"in e)(e))return e.stream();if((e=>!!e&&"function"==typeof e.arrayBuffer&&"ok"in e&&"status"in e)(e)){if(e.body)return e.body;const t=await e.arrayBuffer();return l.IS_SAFARI?new ReadableStream({start(e){e.enqueue(new Uint8Array(t)),e.close()}}):new Blob([t]).stream()}const a=(e=>{if(null==e)throw new TypeError("gzipString: input cannot be null or undefined");if("string"==typeof e)return d(e);if("raw"!==n){if(e instanceof URLSearchParams||"urlencoded"===n)return d(e.toString());if(!("object"!=typeof e||e instanceof Blob||"json"!==n&&"auto"!==n))return d(JSON.stringify(e,s,c))}const t=d(e);if(t)return t;throw new TypeError("gzipString: unsupported non-stream input for requested serialize option")})(e);return l.IS_SAFARI?new ReadableStream({start(e){e.enqueue(a),e.close()}}):new Blob([a],{type:"application/octet-stream"}).stream()};try{const e=(await u()).pipeThrough(new l.STREAMS.CompressionStream("gzip"));if("stream"===a)return e;const t=new Response(e);switch(a){case"blob":{const e=await t.blob();return i?e.slice(0,e.size,i):e}case"uint8array":{const e=await t.arrayBuffer();return new Uint8Array(e)}case"base64":return(e=>{let t="";for(let n=0;n<e.length;n+=32768)t+=String.fromCharCode.apply(null,e.subarray(n,n+32768));return btoa(t)})(new Uint8Array(await t.arrayBuffer()));default:return await t.arrayBuffer()}}catch(e){const t=e?.message??String(e);throw new Error(`gzipString failed (CompressionStream): ${t}`)}},async streamToString(e,t="utf-8"){const n="string"==typeof t?{encoding:t}:t||{},{encoding:a="utf-8",normalizeNewlines:o="preserve",as:r="string"}=n;if("string"==typeof e){let t=e;return"preserve"!==o&&(t="lf"===o?t.replace(/\r\n?/g,"\n"):t.replace(/\r?\n/g,"\r\n")),"json"===r?JSON.parse(t):"lines"===r?t.split(/\r?\n/):t}const i=e=>e.length>=3&&239===e[0]&&187===e[1]&&191===e[2]?3:e.length>=2&&254===e[0]&&255===e[1]||e.length>=2&&255===e[0]&&254===e[1]?2:0,s=(await(async()=>{if((t=e)&&"function"==typeof t.getReader)return e;var t;if((e=>!!e&&"function"==typeof e.stream&&"function"==typeof e.arrayBuffer&&"type"in e)(e))return e.stream();if((e=>!!e&&"function"==typeof e.arrayBuffer&&"ok"in e&&"status"in e)(e)){if(e.body)return e.body;const t=await e.arrayBuffer();return l.IS_SAFARI?new ReadableStream({start(e){e.enqueue(new Uint8Array(t)),e.close()}}):new Blob([t]).stream()}if(e instanceof Uint8Array||ArrayBuffer.isView(e))return l.IS_SAFARI?new ReadableStream({start(t){t.enqueue(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),t.close()}}):new Blob([new Uint8Array(e.buffer,e.byteOffset,e.byteLength)]).stream();if(e instanceof ArrayBuffer)return l.IS_SAFARI?new ReadableStream({start(t){t.enqueue(new Uint8Array(e)),t.close()}}):new Blob([e]).stream();throw new TypeError("streamToString: unsupported input type")})()).getReader(),c=e=>new TextDecoder(e);let d="auto"===a?null:c(a);const u=[];try{let e=!0,t=!1;for(;;){const{value:n,done:o}=await s.read();if(o)break;const r=n instanceof ArrayBuffer?new Uint8Array(n):n;if(e&&"auto"===a){e=!1;d=c(((h=r).length>=3&&239===h[0]&&187===h[1]&&191===h[2]?"utf-8":h.length>=2&&254===h[0]&&255===h[1]?"utf-16be":h.length>=2&&255===h[0]&&254===h[1]?"utf-16le":null)||"utf-8");const n=i(r);if(n){t=!0,u.push(d.decode(r.subarray(n),{stream:!0}));continue}}u.push(d.decode(r,{stream:!0}))}u.push(d.decode());let n=u.join("");return"preserve"!==o&&(n="lf"===o?n.replace(/\r\n?/g,"\n"):n.replace(/\r?\n/g,"\r\n")),"json"===r?JSON.parse(n):"lines"===r?n.split(/\r?\n/):n}catch(e){const t=e?.message??String(e);throw new Error(`streamToString failed: ${t}`)}finally{try{s.releaseLock?.()}catch{}}var h},async gunzipToText(e,t={}){if(!l.STREAMS.available)throw new Error("gunzipToText unavailable: DecompressionStream is not supported.");const{encoding:n="utf-8",as:a="string",normalizeNewlines:o="preserve"}=t||{},r=e=>{const t=/^data:([^;,]+)?(?:;charset=[^;,]+)?(;base64)?,(.*)$/i.exec(e),n=(t?t[2]&&t[3]:null)?t[3]:e;if(!/^[A-Za-z0-9+/=\s]+$/.test(n))return null;try{return(e=>{const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n})(n.replace(/\s+/g,""))}catch{return null}},i=async()=>{if("string"==typeof e){const t=r(e);if(!t)throw new TypeError("gunzipToText: string input must be base64 gzip or data:...; got plain string");return l.IS_SAFARI?new ReadableStream({start(e){e.enqueue(t),e.close()}}):new Blob([t]).stream()}if((t=e)&&"function"==typeof t.getReader)return e;var t;if((e=>!!e&&"function"==typeof e.stream&&"function"==typeof e.arrayBuffer&&"type"in e)(e))return e.stream();if((e=>!!e&&"function"==typeof e.arrayBuffer&&"ok"in e&&"status"in e)(e)){if(e.body)return e.body;const t=await e.arrayBuffer();return l.IS_SAFARI?new ReadableStream({start(e){e.enqueue(new Uint8Array(t)),e.close()}}):new Blob([t]).stream()}const n=(e=>e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e instanceof ArrayBuffer?new Uint8Array(e):e&&"number"==typeof e.byteLength&&e.buffer?new Uint8Array(e.buffer,e.byteOffset||0,e.byteLength):null)(e);if(n)return l.IS_SAFARI?new ReadableStream({start(e){e.enqueue(n),e.close()}}):new Blob([n]).stream();throw new TypeError("gunzipToText: expected gzip bytes (ArrayBuffer/View), Blob, Stream, Response, or base64 string")};try{const e=(await i()).pipeThrough(new l.STREAMS.DecompressionStream("gzip")),t=await k.streamToString(e,{encoding:n,normalizeNewlines:o});return"json"===a?JSON.parse(t):"lines"===a?t.split(/\r?\n/):t}catch(e){const t=e?.message??String(e);throw new Error(`gunzipToText failed (DecompressionStream): ${t}`)}},async createGzipFileFromString(e,t){if(null==t)throw new TypeError("createGzipFileFromString: text cannot be null/undefined");const n=/\.gz$/i.test(e)?e:`${e}.gz`,a=await k.gzipString(String(t)),o=new Uint8Array(a),r=new Blob([o],{type:"application/gzip"});try{return new File([r],n,{type:"application/gzip"})}catch{return r}},async downloadGzipFromString(e,t){const n=await createGzipFileFromString(e,t),a=URL.createObjectURL(n);try{const t=document.createElement("a");t.href=a,t.download=n.name&&n.name.length>0?n.name:/\.gz$/i.test(e)?e:`${e}.gz`,t.click()}finally{URL.revokeObjectURL(a)}},makeAbsoluteUrl(e,t=location.href){let n;try{n=new URL(t,location.href)}catch{console.warn("makeAbsoluteUrl: invalid baseUrl:",t,"using current document URL"),n=new URL(location.href)}const a=n.href;if("string"!=typeof e)return console.warn("makeAbsoluteUrl: non-string inputUrl:",e),String(e||"");const o=e.trim();if(!o)return"";if(/^(data|blob|mailto|tel|javascript):/i.test(o)||o.startsWith("#"))return o;if(o.startsWith("//"))return n.protocol+o;if(/^[a-z][a-z0-9+.-]*:/i.test(o))try{return new URL(o).href}catch(e){return console.warn("makeAbsoluteUrl: malformed absolute URL:",o,e),o}try{return new URL(o,a).href}catch(e){return console.error("makeAbsoluteUrl: cannot resolve",o,"against",a,e),o}},isBase64(e){if("string"!=typeof e)return!1;if(0===(e=e.trim()).length)return!1;if(e.length%4!=0)return!1;return!!/^(?:[A-Za-z0-9+\/]{4})*(?:[A-Za-z0-9+\/]{2}==|[A-Za-z0-9+\/]{3}=)?$/.test(e)},corsEnabled(e){var t=new XMLHttpRequest;t.open("HEAD",e,!1);try{t.send()}catch(e){}return t.status>=200&&t.status<=299},ensureFontLink(e){if("system-ui"===e||!l.GOOGLE_FONTS_MAP[e]||document.getElementById(`ae-font-${e}`))return;const t=document.createElement("link");t.id=`ae-font-${e}`,t.className="ae",t.rel="stylesheet",t.href=`https://fonts.googleapis.com/css2?family=${l.GOOGLE_FONTS_MAP[e]}&display=swap`,document.head.appendChild(t)},showToast(e,t=2500,n){let o=(n=n||(s.shadow||document.body)).querySelector("#ae-toast-container");o||(o=document.createElement("div"),o.id="ae-toast-container",n.appendChild(o));const r=document.createElement("div");r.className="ae-toast",r.textContent=e,o.appendChild(r),a((()=>{r.style.opacity=0,a((()=>r.remove()),500)}),Math.min(t,1e4))},stripSiteFromTitle(e,t){if(!t)return e||"";const n=RegExp.escape(t),a=new RegExp(`\\s*(?:[-–—|:])\\s*${n}\\s*$`);return e.replace(a,"")},formatReadableDate(e,t={weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",timeZoneName:"short",sortable:!1}){const n=Date.parse(e);if(isNaN(n))return null;if(t.sortable){const e=new Date;return`${String(e.getFullYear()).slice(-2)}.${String(e.getMonth()+1).padStart(2,"0")}.${String(e.getDate()).padStart(2,"0")}_${e.getHours()%12||12}.${String(e.getMinutes()).padStart(2,"0")}${e.getHours()>=12?"PM":"AM"}`}return new Date(e).toLocaleString("en-US",t)},prettyPrintElement(e){if(!e||e.nodeType!==Node.ELEMENT_NODE)return"";const t=e.tagName.toLowerCase(),n=e.attributes;if(0===n.length)return`<${t}>`;return`<${t} ${Array.from(n,(e=>`${e.name}="${e.value}"`)).join(" ")}>`},async copyToClipboard(e){return!navigator.clipboard||l.IS_SAFARI?this.fallbackCopyToClipboard(e):await navigator.clipboard.writeText(e).then((()=>this.showToast("Copied to clipboard!"))).catch((t=>(console.error("Clipboard error:",t),this.showToast("Error copying to clipboard"),this.fallbackCopyToClipboard(e))))},fallbackCopyToClipboard(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-999999px",t.style.top="-999999px",t.className="ae",document.body.appendChild(t),t.focus(),t.select();let n=!1;try{n=document.execCommand("copy"),this.showToast(n?"Copied to clipboard!":"Failed to copy text")}catch(e){console.error("Fallback clipboard error:",e),this.showToast("Error copying: "+e.message),n=!1}return document.body.removeChild(t),Promise.resolve(n)},async downloadFile(e,t,n,o={}){const{secondaryMethod:r="data",dataUrlMaxBytes:i=1e5}=o,s="string"==typeof n&&n.trim()?n.trim():"application/octet-stream",c=/^(text\/|application\/(json|xml|csv|rss|atom|javascript|ecmascript)|image\/svg\+xml)/i.test(s);let d;if(t instanceof Blob)d=t.type?t:new Blob([t],{type:s});else if(t instanceof ArrayBuffer||ArrayBuffer.isView(t))d=new Blob([t],{type:s});else{if("string"!=typeof t)throw new Error("Unsupported content type for downloadFile: "+typeof t);{const e=(new TextEncoder).encode(t),n=c&&!/\bcharset=/i.test(s)&&!/^image\/svg\+xml/i.test(s);d=new Blob([e],{type:n?`${s};charset=utf-8`:s})}}let u="string"==typeof e&&e.trim()?e.replace(/[\/\\:*?"<>|]+/g,"-"):"download";if(!/\.[^.]+$/.test(u)){const e={"application/json":".json","application/gzip":".gz","text/plain":".txt","text/markdown":".md","text/html":".html"}[(d.type||s).toLowerCase().split(";")[0]]||"";u+=e}try{if(l.IS_IOS_SAFARI){if("data"===r&&d.size<i)return new Promise(((e,t)=>{const n=new FileReader;n.onload=()=>{try{const t=document.createElement("a");t.href=n.result,t.download=u,t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t),e()}catch(e){t(new Error("Failed to trigger download"))}},n.onerror=()=>t(new Error("Failed to read file content")),n.readAsDataURL(d)}));if("share"===r||d.size>=i){const e=d.type||s,t=new File([d],u,{type:e});if(navigator.canShare&&navigator.canShare({files:[t]}))return void await navigator.share({files:[t]});throw new Error("Web Share API not available or file sharing not supported")}}else{const e=URL.createObjectURL(d),t=document.createElement("a");t.href=e,t.style.display="none",t.className="ae",t.download=u,document.body.appendChild(t),t.click();const n=()=>{t.isConnected&&t.remove(),URL.revokeObjectURL(e),this.showToast(`Downloaded ${u}`)};"undefined"!=typeof requestAnimationFrame?requestAnimationFrame((()=>a(n,100))):a(n,1e3)}}catch(e){throw console.error("Download failed:",e),new Error(`Download failed: ${e.message}`)}},parseAuthors(e){if(!e||"string"!=typeof e||!e.trim())return{author:"",authors:[]};let t=e.trim().replace(/\s+/g," ");[/^(?:by|author|written by|created by|from|posted by):\s*/gi,/\b(?:by|author|writ(?:ten|er)|compos(?:ed|er)|profile|edit(?:ed|or)|post(?:ed)?|publish(?:ed|er)|from|creat(?:ed|or)|contrib(?:uted|utor))\b/gi].forEach((e=>{t=t.replace(e," ")})),t=t.replace(/\s+/g," ").trim();const n=t.split(/\s*(?:,|\band\b|&|\||\n|;\s*|\s{3,})\s*/i),a=/^\s*(?:photograph(?:er|y)?|illustration|illustrator|video|reporting|reporter|editing|editor|graphic|design(?:er)?|layout|production)\b/i,o=/^[a-zA-Z\s\-'\.]{2,}$/,r=n.map((e=>(e=>{let t=e.trim();const n=[/\s*(?:,|\s|at)*\b(?:today|tomorrow|yesterday)\b$/i,/\s*(?:,|\s|at)*\b(?:this|next)?\s*(?:Mon(?:day)?|Tue(?:sday)?|Wed(?:nesday)?|Thu(?:rsday)?|Fri(?:day)?|Sat(?:urday)?|Sun(?:day)?)\b$/i,/\s*(?:,|\s|at)*\b(?:morning|afternoon|evening|night|tonight)\b$/i,/\s*(?:,|\s|at)*\b(?:noon|midnight)\b$/i,/\s*(?:,|\s|at)*\b\d{4}-(?:0[1-9]|1[0-2])(?:-(?:0[1-9]|[12]\d|3[01]))?(?:(?:[T\s])(?:(?:[01]?\d|2[0-3]):[0-5]\d(?::[0-5]\d)?\s*(?:[APMapm]{2})?))?$/i,/\s*(?:,|\s|at)*\b(?:0?[1-9]|1[0-2])\/(?:0?[1-9]|[12]\d|3[01])(?:\/(?:\d{4}|\d{2}))?(?:\s+\d{1,2}(?::[0-5]\d(?::[0-5]\d)?)?\s*(?:[APMapm]{2})?)?$/i,/\s*(?:,|\s|at)*\b(?:\d{1,2}(?:st|nd|rd|th)?\s+(?:Jan(?:uary)?|Feb(?:ruary)?|Mar(?:ch)?|Apr(?:il)?|May|Jun(?:e)?|Jul(?:y)?|Aug(?:ust)?|Sep(?:t(?:ember)?)?|Oct(?:ober)?|Nov(?:ember)?|Dec(?:ember)?)(?:\s*,?\s*(?:\d{4}|\d{2}))?|(?:Jan(?:uary)?|Feb(?:ruary)?|Mar(?:ch)?|Apr(?:il)?|May|Jun(?:e)?|Jul(?:y)?|Aug(?:ust)?|Sep(?:t(?:ember)?)?|Oct(?:ober)?|Nov(?:ember)?|Dec(?:ember)?)\.?\s+\d{1,2}(?:st|nd|rd|th)?(?:\s*,?\s*(?:\d{4}|\d{2}))?)(?:\s+\d{1,2}(?::[0-5]\d(?::[0-5]\d)?)?\s*(?:[APMapm]{2})?)?$/i,/\s*(?:,|\s|at)*\b\d{1,2}(?::[0-5]\d(?::[0-5]\d)?)?\s*(?:[APMapm]{2}|h(?:ou)?rs?)?\b$/i,/\s*(?:,|\s|at)*\b\d{1,2}\s*o'clock\s*\b$/i,/(http(s)?:\/\/.)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/gi];for(const e of n)t=t.replace(e,"");return t=t.replace(/\s{2,}/g," ").replace(/[\s,;:–-]+$/,"").trim(),t})(e))).filter((e=>!(!e||e.length<2)&&(!a.test(e)&&!!o.test(e)))),i=[...new Set(r)];return{author:i.length>0?i[0]:"",authors:i}},sanitizeFilename:e=>e?e.replace(/[<>:"/\\|?*\x00-\x1F]/g,"_").replace(/\s+/g,"_").replace(/__+/g,"_").trim().substring(0,100):"untitled",generateMetadataHeaderPlain(e,t){const n=e.authors.map((e=>e.name)).join(", "),a=k.formatReadableDate(e.date);return`${e.title||""}\n${e.description&&!t?e.description+"\n":""}${e.url||""}\n${n?"By "+n+"\n\n":"\n"}${a?"Published "+a+"\n\n":"\n"}`},generateMetadataHeaderMarkdown(e,t){const n=e.authors.map((e=>e.name)).join(", "),a=k.formatReadableDate(e.date);return`# ${e.title||""}\n\n${e.description&&!t?`*${e.description}*\n\n`:""}[${e.title||""}](${e.url||""})\n\n${n?`*By ${n}*\n\n`:""}${a?`*Published ${a}*\n\n`:""}`},escapeHtml(e,t=!1){if(null==e)return"";const n=String(e);if(!t&&!/[&<>"'\u0000-\u001F\u007F-\u009F\u2028\u2029\uFEFF\uFFFE\uFFFF]/.test(n))return n;const a={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"};function o(e){return"&#x"+e.toString(16).toUpperCase()+";"}function r(e){return e<=31||(e>=127&&e<=159||(8232===e||8233===e||(65279===e||(e>=64976&&e<=65007||65534==(65534&e)&&e>=65534&&e<=1114111))))}if(!t)return n.replace(/[&<>"']|[\u0000-\u001F\u007F-\u009F]|\u2028|\u2029|\uFEFF|\uFFFE|\uFFFF/g,(e=>Object.hasOwn(a,e)?a[e]:o(e.charCodeAt(0))));let i="";for(const e of n){const t=e.codePointAt(0);Object.hasOwn(a,e)?i+=a[e]:t>126||r(t)?i+=o(t):i+=e}return i},handleError(e,t){console.error(t,e),k.showToast(t)},generateCssSelector(e,t={}){if(!(e instanceof Element))return console.warn("generateCssSelector: input must be a DOM Element",e),null;const n=200,a=12,o=!!t.skipGlobalCache;_.css||(_.css=new WeakMap);const r=Object.assign({},{useCache:t.useCache||!0,attributePrefs:["id","data-testid","data-test-id","data-cy","data-qa","data-automation-id","name","role","type","aria-label","aria-labelledby","aria-describedby","title","placeholder","value","for"],limitAttributes:!1,maxAttributeCombinations:2,maxClasses:5,maxSelectorLength:200,resourceLimit:!1,maxQueries:5e3,maxTimeMs:1e3,rootNode:t.rootNode||t.doc||s.overlay||(e&&"function"==typeof e.getRootNode?e.getRootNode():null)||document,doc:t.doc||s.overlay||document,ignoredClasses:["focus","hover","active","visited","disabled","loading","ae-select-highlight","ae-removed","ae-removed-selectors_always_remove","ae-removed-selectors_optional","ae-removed-images","ae-removed-ads","ae-removed-nav","ae-removed-flash"],ignoredAttributes:["style","class","height","width","data-height","data-width","data-file-height","data-file-width"],volatileClassPatterns:[/^(ng-|v-|svelte-|react-|__[^_]+__|css-)/],useModern:!0,useHas:!0,useIs:!0,useNot:!0,usePositionalPseudos:!0,useSiblingCombinators:!0,useAttributePartialMatch:!0,useClassesPartialMatch:!0,useClassesInPath:!0,useSemanticPriority:!0,preferStableSelectors:!0,preferAttributeOverPosition:!0,expandAttributesSeparately:!1,useModernCombinations:!0,componentMemo:!0,useAttrPresence:!0,useAttrOps:!0,useAttrCaseI:!0,positionalPenaltyThreshold:5,siblingWeightBoost:10,pathMaxClasses:2,maxAncestorDepth:5,maxAncestorCandidates:12,ancestorCandidateWeightDelta:10,maxIsCombinations:25,allowNonUnique:!1,verbose:!1,enableEscalationRetries:!0,enableJitterRetries:!0,customWeight:null,maxSingleClassCombos:3,maxIdClassCombos:2,maxIdAttrCombos:2,maxClassAttrCombos:2,maxClassPairCombinations:5,maxAttributePairCombinations:4,maxHasChildren:3,maxHasSelectorsPerChild:2,maxSiblingPrevComps:3,maxOtherAttrCombos:2,maxModerateCandidates:15,maxNotSiblingClasses:2,combinationSchemas:t.combinationSchemas||[{comboName:"id",parts:{id:1},weightOffset:20},{comboName:"cls",parts:{cls:1},weightOffset:20},{comboName:"tag+id",parts:{tag:1,id:1},weightOffset:15},{comboName:"tag+cls",parts:{tag:1,cls:1},weightOffset:15},{comboName:"tag+attr",parts:{tag:1,attrs:1},weightOffset:15},{comboName:"id+cls",parts:{id:1,cls:1},weightOffset:10},{comboName:"tag+cls2",parts:{tag:1,cls:2},weightOffset:0},{comboName:"cls+attr",parts:{cls:1,attrs:1},weightOffset:0},{comboName:"cls2",parts:{cls:2},weightOffset:15},{comboName:"attr2",parts:{attrs:2},weightOffset:0}],CLASS_PRIORITY_BONUS:t.class_bonus||25,maxLocalCacheEntries:t.maxLocalCacheEntries||1e3,volatilityCacheLimit:t.volatilityCacheLimit||1e3},t);r.attributePrefs=[...r.attributePrefs],r.ignoredClasses=[...r.ignoredClasses],r.ignoredAttributes=[...r.ignoredAttributes],r.combinationSchemas=r.combinationSchemas.map((e=>({...e})));const i=100,l=80,c=60,d=50,u=45,h=40,p=15,m=10,f=r.maxLocalCacheEntries,g=r.volatilityCacheLimit,y=(b=r.rootNode)?String(b.id||b.tagName||b.nodeType||"unknown"):"null";var b;const E=`${r.useModern}_${r.maxClasses}_${r.preferStableSelectors}_${r.useHas}_${r.useIs}_${y}`;if(_.css.has(e)&&!o){const t=_.css.get(e);if(t&&t.configKey===E)return t.selector}function w(e){try{return r.doc.querySelector(`${e}(*)`),!0}catch{return!1}}r.useModern?(r.useHas=r.useHas&&w(":has"),r.useIs=r.useIs&&w(":is"),r.useNot=r.useNot&&w(":not")):r.useHas=r.useIs=r.useNot=!1;const v=()=>"undefined"!=typeof performance&&performance.now?performance.now():Date.now();let S=r.resourceLimit?v():0,x=0;class T{constructor(e){this.maxSize=e,this.cache=new Map}get(e){if(this.cache.has(e)){const t=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,t),t}}set(e,t){if(this.cache.has(e))this.cache.delete(e);else if(this.cache.size>=this.maxSize){const e=this.cache.keys().next().value;void 0!==e&&this.cache.delete(e)}this.cache.set(e,t)}has(e){return this.cache.has(e)}get entryCount(){return this.cache.size}}const C=!1===r.useCache||o?null:new T(f),A=r.verbose?new Map:null,k=!o&&r.componentMemo?new WeakMap:null,N=e=>{if("string"!=typeof e||!e||!e.trim())return null;try{return CSS.escape(e.trim())}catch{return null}},R=[{pattern:/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i,weight:.95,reason:"uuid"},{pattern:/^[0-9a-f]{64}$/i,weight:.95,reason:"sha256_hash"},{pattern:/^[0-9a-f]{40}$/i,weight:.9,reason:"sha1_hash"},{pattern:/^[0-9a-f]{16,39}$/i,weight:.85,reason:"hex_hash"},{pattern:/^[A-Za-z0-9_-]{12,}\.[A-Za-z0-9_-]{2,}\.[A-Za-z0-9_-]{2,}$/,weight:.9,reason:"jwt_token"},{pattern:/^(sk|pk|api)_[A-Za-z0-9]{20,}$/i,weight:.95,reason:"api_key"},{pattern:/^[A-Za-z0-9+/_-]{12,}={0,2}$/,weight:.85,reason:"base64"},{pattern:/^[A-Za-z0-9]{20,}$/,weight:.75,reason:"long_token"},{pattern:/\b1[0-9]{12,}\b/,weight:.8,reason:"timestamp_ms"},{pattern:/\d{12,}/,weight:.7,reason:"long_numeric"},{pattern:/^[A-Z0-9]{8,}-[A-Z0-9]{4,}-[A-Z0-9]{4,}$/i,weight:.8,reason:"custom_id"}],I=[{pattern:/^[A-Za-z\s-_]+$/,weight:.9,reason:"natural_language"},{pattern:/^\d{1,4}$/,weight:.8,reason:"small_number"},{pattern:/^(true|false|null|undefined)$/i,weight:.95,reason:"literal"},{pattern:/^https?:\/\/[^\s]+$/,weight:.6,reason:"url"},{pattern:/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/,weight:.8,reason:"email"}],L=o?null:new T(g);function O(e,t={}){const{returnConfidence:n=!0,threshold:a=.5,cache:o=!0}=t;if(!e||"string"!=typeof e||e.length<9)return!!n&&{isVolatile:!1,confidence:0,reason:"invalid_input"};if(o&&L&&L.has(e)){const t=L.get(e);return n?t:t.isVolatile}for(const{pattern:t,weight:a,reason:r}of I)if(t.test(e)){const t={isVolatile:!1,confidence:Math.round(100*(1-a))/100,reason:`stable_${r}`};return o&&L&&L.set(e,t),!!n&&t}let r=0,i="heuristic";for(const{pattern:t,weight:n,reason:a}of R)if(t.test(e)&&(r=Math.max(r,n),r===n&&(i=a),n>=.95))break;if(r<a){const t=function(e){const t=e.length;let n=0;const a=[],o=(e.match(/\d/g)||[]).length/t,r=(e.match(/[a-zA-Z]/g)||[]).length/t,i=/\s/.test(e);t>=16&&(n+=.01*(t-16),a.push("length"));return o>.6&&t>8&&(n+=.25,a.push("digit_heavy")),/[A-Z]/.test(e)&&/[a-z]/.test(e)&&o>.3&&t>10&&(n+=.3,a.push("mixed_case_num")),new Set(e).size/t>.7&&t>12&&!i&&(n+=.2,a.push("high_entropy")),r>.8&&i&&(n-=.3,a.push("natural_lang_penalty")),{score:Math.max(0,Math.min(.95,n)),reason:a.length?a.join("+"):"low_heuristic"}}(e);t.score>r&&(r=t.score,i=t.reason)}const s={isVolatile:r>=a,confidence:Math.round(100*r)/100,reason:i};return o&&L&&L.set(e,s),n?s:s.isVolatile}function M(e,t=1){return e<t?t:e}function D(e,t,n=e){const a=O(t),o=a.isVolatile;let r=e;return o&&(r-=Math.floor(n*a.confidence)),{weight:M(r),isVolatile:o,volatilityInfo:a}}function P(e,t){if(t||(t=r.rootNode||r.doc),!e||"string"!=typeof e||e.length>r.maxSelectorLength)return{length:1/0,error:"invalid selector"};if(r.resourceLimit&&(++x>r.maxQueries||r.resourceLimit&&v()-S>r.maxTimeMs))return{length:1/0,error:"budget exceeded"};if(!C)try{return t.querySelectorAll(e)}catch(e){return{length:1/0,error:e}}const n=1===t.nodeType&&t.tagName?t.tagName:"",a=(t===r.doc?"":n+"|"+(t.id||t.className||t.dataset?.testid||t.dataset?.testId||""))+"||"+e;if(C.has(a)){const e=C.get(a);return e.error?{length:1/0,error:e.error}:(A&&A.set(a,{count:e.length,cached:!0}),e)}let o;try{o=t.querySelectorAll(e)}catch(e){return{length:1/0,error:e}}return C.set(a,o),A&&A.set(a,{count:o.length,cached:!1}),o}function $(t,n){n||(n=e);const a=P(t,r.rootNode);return!a.error&&a.length!==1/0&&(1===a.length&&a[0]===n)}function H(e,t,n){return n+function(e,t){if(!r.useSemanticPriority)return 0;let n=0;return/^#/.test(e)&&(n+=i),/\[data-testid/i.test(e)&&(n+=l),/\[data-/.test(e)&&(n+=c),/\[role/.test(e)&&(n+=d),/\[aria-/.test(e)&&(n+=u),/\[name/.test(e)&&(n+=h),/(header|nav|main|footer|section|article|aside)/i.test(e)&&(n+=p),/:first-child|:last-child|:only-child/.test(e)&&(n+=m),/:first-of-type|:last-of-type|:only-of-type/.test(e)&&(n+=m),n}(e)+(r.customWeight&&r.customWeight(e,t)||0)}function F(e){if(k&&k.has(e))return k.get(e);let t=null;if(e.id){const n=e.id,a=N(n);if(a){const e=D(i,n,80);e.isVolatile||(t={selector:`#${a}`,weight:e.weight,type:"id",rawValue:n})}}const n={id:t,tag:e.tagName.toLowerCase(),attr:B(e),cls:j(e),pos:W(e),sib:q(e),has:V(e),not:Y(e)};return k&&k.set(e,n),n}const z={BUTTON:"button",A:"link",INPUT:"textbox",NAV:"navigation",HEADER:"banner",FOOTER:"contentinfo",MAIN:"main"};function U(e,t,n){let a;return"id"===e?a=i:/^data-(test|qa|cy)/.test(e)?a=l:e.startsWith("data-")?a=c:"role"===e?(a=d,z[n.tagName]!==String(t).toLowerCase()&&(a+=20)):a=30,a}function B(e){const t=[];let n=0;for(const o of r.limitAttributes?r.attributePrefs:e.getAttributeNames()){if(!e.hasAttribute(o)||"id"===o||r.ignoredAttributes.includes(o))continue;const i=e.getAttribute(o),s=N(o),l=N(i);if(!s||!l)continue;let c=D(U(o,i,e),i,50);if(!c.isVolatile&&i.length<20)t.push({selector:`[${s}="${l}"]`,weight:c.weight,type:"attr",rawValue:i});else{if(r.useAttributePartialMatch&&i.length>5)if(["href","src","data-uri","srcset","data-src","data-lazy-src","data-original","data-lazyload","data-srcset","data-bg","data-background-image"].includes(o)&&i.length>=20){const e=i.slice(-20),n=N(e);n&&t.push({selector:`[${s}$="${n}"]`,weight:c.weight-25,type:"attr$",rawValue:e})}else if(["alt","title","data-testid","data-test-id"].includes(o)&&i.length<=50){const e=i.slice(0,15),n=N(e);n&&t.push({selector:`[${s}*="${n}"]`,weight:c.weight-15,type:"attr*",rawValue:e})}if(r.useAttrCaseI&&/[a-z]/i.test(i)&&i.length<50&&(t.push({selector:`[${s}="${l}" i]`,weight:c.weight-10,type:"attri",rawValue:i.toLowerCase()}),n++,n>=a))break;if(r.useAttrOps){if(i.length>=6){const e=N(i.slice(0,Math.min(12,Math.max(6,Math.floor(.3*i.length)))));if(e&&(t.push({selector:`[${s}^="${e}"]`,weight:M(c.weight-20),type:"attr^",rawValue:String(e)}),n++,n>=a))break}if(["href","src","data-uri","srcset","data-src","data-lazy-src","data-original","data-lazyload","data-srcset","data-bg","data-background-image"].includes(o)&&i.length>=20){const e=N(i.slice(-20));if(e&&(t.push({selector:`[${s}$="${e}"]`,weight:M(c.weight-25),type:"attr$",rawValue:String(e)}),n++,n>=a))break}if(/\s/.test(i)){const e=i.split(/\s+/).find((e=>e&&e.length>=2&&e.length<=24&&!O(e,{returnConfidence:!1})));if(e){const o=N(e);if(o&&(t.push({selector:`[${s}~="${o}"]`,weight:c.weight-12,type:"attr~",rawValue:e}),n++,n>=a))break}}if(!/\s/.test(i)&&/-/.test(i)){const e=N(String(i).split("-")[0]);if(e&&e.length>=2&&(t.push({selector:`[${s}|="${e}"]`,weight:c.weight-18,type:"attr|",rawValue:e}),n++,n>=a))break}if(r.useAttributePartialMatch&&["alt","title","data-testid","data-test-id"].includes(o)&&i.length>5&&i.length<=50){const e=N(i.slice(0,15));if(e&&(t.push({selector:`[${s}*="${e}"]`,weight:c.weight-15,type:"attr*",rawValue:String(e)}),n++,n>=a))break}}}}return t}function j(e){return Array.from(e.classList).filter((e=>e&&!r.ignoredClasses.includes(e))).map((e=>{const t=N(e);if(!t)return null;let n=r.preferStableSelectors&&/^(btn|nav|content|main|header|footer|container)/.test(e)?25:20;r.volatileClassPatterns.some((t=>t.test(e)))&&(n=Math.max(1,n-15));const a=D(n,e,n);if(!a.isVolatile&&e.length<25)return{selector:`.${t}`,weight:a.weight+r.CLASS_PRIORITY_BONUS,type:"class",rawValue:e};if(r.useClassesPartialMatch)if(e.length>20){const t=e.slice(-20),n=N(t);if(n)return{selector:`[class$="${n}"]`,weight:a.weight-10,type:"class$",rawValue:t}}else if(e.length>5){const t=e.slice(0,15),n=N(t);if(n)return{selector:`[class*="${n}"]`,weight:a.weight-5,type:"class*",rawValue:t}}return null})).filter(Boolean).sort(((e,t)=>t.weight-e.weight)).slice(0,r.maxClasses)}function G(e){const t=e.parentElement;if(!t)return null;let n=0,a=0,o=0,r=0;const i=e.tagName;for(let s=t.firstElementChild;s;s=s.nextElementSibling)a++,s.tagName===i&&(r++,s===e&&(o=r)),s===e&&(n=a);return{index:n,total:a,sameIdx:o,sameTotal:r,isOnly:1===a,isFirst:1===n,isLast:n===a,isOnlyOfType:1===r,isFirstOfType:1===o,isLastOfType:o===r}}function W(e){if(!r.usePositionalPseudos)return[];const t=G(e);if(!t)return[];const n=e.tagName.toLowerCase(),a=[];t.isOnly&&a.push({selector:`${n}:only-child`,weight:35,type:"pos"}),t.isOnlyOfType&&a.push({selector:`${n}:only-of-type`,weight:30,type:"pos"}),t.isFirst&&a.push({selector:`${n}:first-child`,weight:25,type:"pos"}),t.isLast&&a.push({selector:`${n}:last-child`,weight:25,type:"pos"}),t.isFirstOfType&&a.push({selector:`${n}:first-of-type`,weight:20,type:"pos"}),t.isLastOfType&&a.push({selector:`${n}:last-of-type`,weight:20,type:"pos"});const o=t.total>r.positionalPenaltyThreshold?-20:-5;if(a.push({selector:`${n}:nth-child(${t.index})`,weight:10+o,type:"pos"}),t.sameTotal>1){const e=t.sameTotal>r.positionalPenaltyThreshold?-15:0;a.push({selector:`${n}:nth-of-type(${t.sameIdx})`,weight:15+e,type:"pos"})}return a}function q(e){if(!r.useSiblingCombinators)return[];const t=e.tagName.toLowerCase(),n=[],a=e.previousElementSibling;if(a){const{id:e,attr:o,cls:i}=F(a);[...[e].filter(Boolean),...o.slice(0,3),...i.slice(0,3)].filter(Boolean).sort(((e,t)=>t.weight-e.weight)).slice(0,r.maxSiblingPrevComps).forEach((e=>n.push({selector:`${e.selector} + ${t}`,weight:e.weight-15+r.siblingWeightBoost,type:"sib+"})))}let o=a,i=0;for(;o&&i<2;){const{id:e,attr:a}=F(o);[e,...a.filter((e=>e.weight>50))].filter(Boolean).slice(0,1).forEach((e=>n.push({selector:`${e.selector} ~ ${t}`,weight:e.weight-25+r.siblingWeightBoost,type:"sib~"}))),o=o.previousElementSibling,i++}return n}function V(e){if(!r.useHas)return[];const t=e.tagName.toLowerCase(),n=[];for(const a of Array.from(e.children).slice(0,r.maxHasChildren)){const{id:e,attr:o,cls:i}=F(a);[e,...o,...i].filter(Boolean).filter((e=>e.weight>30)).sort(((e,t)=>t.weight-e.weight)).slice(0,r.maxHasSelectorsPerChild).forEach((e=>{n.push({selector:`${t}:has(> ${e.selector})`,weight:e.weight+10,type:"has>"}),n.push({selector:`${t}:has(${e.selector})`,weight:e.weight+5,type:"has"})}))}return n}function Y(e){if(!r.useNot||!e.parentElement)return[];const t=e.tagName.toLowerCase(),n=[],a=Array.from(e.parentElement.children).filter((t=>t!==e&&t.tagName===e.tagName));if(!a.length||a.length>4)return n;const o=new Set(e.classList),i=new Set(Array.from(e.attributes).map((e=>e.name))),s=e.id;for(const e of a){if(e.id&&e.id!==s){const a=N(e.id);if(a){let o=D(80,e.id,40);o.isVolatile||n.push({selector:`${t}:not(#${a})`,weight:o.weight,type:"!id"})}}Array.from(e.classList).filter((e=>!o.has(e)&&!r.ignoredClasses.includes(e))).sort().slice(0,r.maxNotSiblingClasses).forEach((e=>{const a=N(e);let o=D(15,e,10);a&&!o.isVolatile&&n.push({selector:`${t}:not(.${a})`,weight:o.weight,type:"!cls"})}));for(const a of Array.from(e.attributes)){if(i.has(a.name)||!r.attributePrefs.includes(a.name))continue;const e=N(a.name),o=N(a.value);if(!e||!o)continue;let s=D(20,a.value,15);s.isVolatile||n.push({selector:`${t}:not([${e}="${o}"])`,weight:s.weight,type:"!attr"})}}return n}function X(t,a,o,i){const s=[],l=e=>(e.match(/^\[\s*([^=\s*~^$|\]]+)/)||[])[1];o.sort(((e,t)=>t.weight-e.weight)),i.sort(((e,t)=>t.weight-e.weight));const c=i.filter((e=>{const t=l(e.selector);return t&&r.attributePrefs.includes(t)&&"id"!==e.type})),d=r.limitAttributes?[]:i.filter((e=>{const t=l(e.selector);return t&&!r.attributePrefs.includes(t)&&"id"!==e.type}));const u=e=>Object.keys(e).map((t=>`${t}${e[t]>1?e[t]:""}`)).join("+");let h=0;r.combinationSchemas.forEach((i=>{if(h>=n)return;const l=i.parts||{};let p=[{selector:"",weight:0,parts:{}}];l.tag&&a&&(p=p.map((e=>({selector:e.selector+a,weight:e.weight+1,parts:{...e.parts,tag:1}})))),l.id&&t&&(p=p.map((e=>({selector:e.selector+t.selector,weight:e.weight+t.weight,parts:{...e.parts,id:1}}))));const m=(e,t,a,o)=>{if(!a||!t||0===t.length)return e;const r=function(e,t){if(0===t)return[[]];if(!e||e.length<t)return[];const a=[];return function o(r,i){if(!(a.length>=n))if(i.length!==t){if(r!==e.length)for(let t=r;t<e.length;t++)if(o(t+1,[...i,e[t]]),a.length>=n)return}else a.push(i)}(0,[]),a}(t,Math.min(a,t.length));if(0===r.length)return e;const i=[];return e.forEach((e=>{r.forEach((t=>{if(h>=n)return;const a=t.map((e=>e.selector)).join(""),r=t.reduce(((e,t)=>e+t.weight),0);i.push({selector:e.selector+a,weight:e.weight+r,parts:{...e.parts,[o]:t.length}}),h++}))})),i};if(p=m(p,o,l.cls,"cls"),r.expandAttributesSeparately)p=m(p,c,l.attrs||0,"attrs"),p=m(p,d,l.otherAttrs||0,"otherAttr");else{const e=(l.attrs||0)+(l.otherAttrs||0);p=m(p,[...c,...d],e,"attrs")}p.forEach((t=>{t.selector&&t.selector!==a&&s.push({selector:t.selector,weight:H(t.selector,e,t.weight+(i.weightOffset||0)),type:i.comboName||u(t.parts)})}))}));const p=new Set;return s.filter((e=>!p.has(e.selector)&&(p.add(e.selector),!0)))}function K(e){if(r.doc&&r.doc.documentElement&&e===r.doc.documentElement)return"html";if(e===r.rootNode){if(e.id&&!O(e.id).isVolatile){const t=`#${N(e.id)}`,n=P(t,r.doc);if(!n.error&&1===n.length)return t}return e.tagName.toLowerCase()}const{id:t,tag:n,attr:a,cls:o,pos:i,sib:s,has:l,not:c}=F(e);let d=[{selector:n,weight:1,type:"tag"}];t&&d.push(t),d.push(...a,...o,...i,...s,...l,...c,...X(t,n,o,a)),d.sort(((e,t)=>t.weight-e.weight));for(const t of d)if($(t.selector,e))return t.selector;const u=function(e,t){if(!r.useModernCombinations||!r.useIs)return null;const n=e.filter((e=>{const t=P(e.selector);return!t.error&&t.length>1&&t.length<10})).slice(0,r.maxModerateCandidates);let a=0;const o=r.maxIsCombinations;for(let e=0;e<n.length&&a<o;e++)for(let i=e+1;i<n.length&&a<o;i++){const o=n[e].selector,s=n[i].selector,l=`:is(${o}):is(${s})`;if(a++,$(l,t))return l;if(r.useHas){const e=`*:has(${o}):has(${s})`;if($(e,t))return e}}return null}(d,e);if(u)return u;const h=d[0]?.weight??0,p=d.filter((e=>h-e.weight<r.ancestorCandidateWeightDelta)).slice(0,r.maxAncestorCandidates);let m=0;for(let t=e.parentElement;t&&t!==r.rootNode&&m<r.maxAncestorDepth;t=t.parentElement,m++){const{id:n,attr:a,cls:o}=F(t),i=[n,...a,...o].filter(Boolean).filter((e=>e.weight>20)).slice(0,4);i.push({selector:t.tagName.toLowerCase(),weight:1,type:"ancestor-tag"});for(const n of i){const a=P(n.selector,t.parentElement||r.rootNode),o=!a.error&&1===a.length;for(const t of p){const a=o&&n.weight>80?[`${n.selector} > ${t.selector}`,`${n.selector} ${t.selector}`]:[`${n.selector} ${t.selector}`];r.useIs&&a.push(`${n.selector} :is(${t.selector})`),o&&n.weight>80&&a.unshift(`${n.selector} ${t.selector}`);for(const t of a)if($(t,e))return t}}}const f=[];let g=e;const y=new WeakSet,b=r.maxAncestorDepth+3;for(let t=0;g&&1===g.nodeType&&g!==r.rootNode&&t<b;t++){if(y.has(g)||!g.parentElement&&g!==r.doc.documentElement){r.verbose&&console.warn("generateCssSelector: aborting path build – invalid DOM topology");break}if(y.add(g),0!==t&&g.id&&!O(g.id).isVolatile){const t=N(g.id);if(t){const n=`#${t}${f.length?" > "+f.join(" > "):""}`;if($(n,e))return n}}const{tag:n,cls:a,attr:o}=F(g);let i=n;r.useClassesInPath&&a.slice(0,r.pathMaxClasses).forEach((e=>i+=e.selector));const s=G(g);let l=!1;if(r.preferAttributeOverPosition&&s&&s.sameTotal>1){const e=o.sort(((e,t)=>t.weight-e.weight)).find((e=>e.weight>30));e&&(i+=e.selector,l=!0)}l||!s||s.isOnlyOfType||(i+=s.sameTotal<=8?`:nth-of-type(${s.sameIdx})`:`:nth-child(${s.index})`),f.unshift(i);const c=f.join(" > ");if(t>0&&$(c,e))return c;g=g.parentElement}return $(f.join(" > "),e)?f.join(" > "):r.allowNonUnique&&d.length?d[0].selector:null}for(let t=0;t<2;t++){t&&(r.resourceLimit&&(S=v()),r.enableEscalationRetries&&(r.maxClasses*=2,r.maxAttributeCombinations*=2,r.maxSingleClassCombos*=2,r.maxIdClassCombos*=2,r.maxIdAttrCombos*=2,r.maxClassAttrCombos*=2,r.maxClassPairCombinations*=2,r.maxAttributePairCombinations*=2,r.maxOtherAttrCombos*=2),r.enableJitterRetries&&(r.attributePrefs=[...r.attributePrefs].sort((()=>Math.random()-.5)),r.maxAncestorCandidates+=Math.floor(5*Math.random()))),x=0;const n=K(e);if(n)return o||_.css.set(e,{selector:n,configKey:E}),n;if(!r.enableEscalationRetries&&!r.enableJitterRetries)break}return r.verbose&&console.error("generateCssSelector: failed for",e,A?Object.fromEntries(A):""),null}};const N={elementsRemoved:new Set,elementToDetacher:new WeakMap,elementToCategories:new WeakMap,categoryToDetachers:new Map,checkpoints:new Map,_lastCheckpointId:0,placeholderToDetacher:new WeakMap,tokenToDetacher:new Map,tokenToPlaceholderRef:new Map,parentToPlaceholders:new WeakMap};class R{constructor(e,t=!0){this._weakRef=t?new WeakRef(e):e}get range(){return this._weakRef.deref?.()||null}isConnected(){const e=this.range;if(!e)return!1;try{const t=e.commonAncestorContainer||e.startContainer;return!!t&&L.isInRoot(t)}catch{return!1}}insert(e){const t=this.range;if(!t)throw new Error("Anchor range is invalid");try{t.insertNode(e),t.setStartAfter(e),t.setEndAfter(e)}catch(n){const a=t.startContainer;if(a&&a.nodeType===Node.ELEMENT_NODE)a.appendChild(e);else{if(!a||!a.parentNode)throw n;a.parentNode.insertBefore(e,a.nextSibling)}}if(!e.parentNode)throw new Error("Failed to insert node using anchor")}}class I{constructor(e,t){if(!e)throw new Error("Element must be provided");const n=N.elementToDetacher.get(e);if(n)return n;if(!e.parentNode)throw new Error("Element must have a parent to be detachable");this.manager=t,this.element=e,this._token=t.generateToken(),this._signature=t.captureSignature(e),this._path=t.buildPath(e),this._originalParent=e.parentNode,this._nextSibling=e.nextSibling,this._placeholder=null,this._placeholderRef=null,this._anchor=null,this._isDetached=!1,N.elementToDetacher.set(e,this),N.tokenToDetacher.set(this._token,this)}get parent(){return this._originalParent}get token(){return this._token}get isDetached(){return this._isDetached}hasLivePlaceholder(){const e=this.manager.getPlaceholderForToken(this._token,this._originalParent);return!!e&&(this._placeholder=e,this._placeholderRef=new WeakRef(e),N.placeholderToDetacher.set(e,this),!0)}hasLiveAnchor(){return!(!this._anchor||!this._anchor.isConnected())}refreshContext(){this.element.parentNode&&(this._originalParent=this.element.parentNode,this._nextSibling=this.element.nextSibling,this._signature=this.manager.captureSignature(this.element),this._path=this.manager.buildPath(this.element))}detach(){if(this._isDetached)return!1;try{this.refreshContext();const e=this.element.parentNode;if(!e)return k.handleError(new Error("Element has no parent at detach time"),`elementManager: No parent during detach ${k.prettyPrintElement(this.element)??""}`),!1;this._anchor=this.manager.makeAnchorBefore(this.element);const t=this.manager.getDoc(this.element);return this._placeholder=t.createComment(this.manager.makePlaceholderText(this._token)),this._placeholderRef=new WeakRef(this._placeholder),e.replaceChild(this._placeholder,this.element),this.manager._indexPlaceholder(e,this._placeholder),N.placeholderToDetacher.set(this._placeholder,this),N.tokenToPlaceholderRef.set(this._token,this._placeholderRef),this._isDetached=!0,N.elementsRemoved.add(this),this.manager.notifyElementManagerObservers("detach",{element:this.element,detacher:this}),!0}catch(e){return k.handleError(e,"detacher: failed to detach element"),!1}}reattach(){if(!this._isDetached)return!1;let e=!1,t=null;try{if(this.hasLivePlaceholder()){const n=this._placeholder,a=n.parentNode;this.manager._unindexPlaceholderFrom(a,n),N.placeholderToDetacher.delete(n),a.replaceChild(this.element,n),t="placeholder",e=!0}if(!e&&this.hasLiveAnchor()&&(this._anchor.insert(this.element),t="anchor",e=!0),!e){const n=this.manager.getRoot();let a=null;if(this._signature?.parentId&&(a=n.querySelector(`#${CSS.escape(this._signature.parentId)}`)||null),!a&&this._path){const e=this.manager.navigatePath(this._path,n);a=e?e.parentNode:null}if(a||(a=this.parent),a){const n=this.manager.insertNearSignature(a,this.element,this._signature);n.ok&&(t=n.where,e=!0)}}if(!e){const n=this.parent;if(n&&n.isConnected)this._nextSibling&&this._nextSibling.parentNode===n?(n.insertBefore(this.element,this._nextSibling),t="sibling"):(n.appendChild(this.element),t="parent");else{const e=this.manager.getRoot();(e.body||e.documentElement||e).appendChild(this.element),t="body"}e=!0}return!!e&&(this.refreshContext(),this._placeholder=null,this._placeholderRef=null,this._anchor=null,this._isDetached=!1,N.elementsRemoved.delete(this),this._token&&!N.tokenToPlaceholderRef.has(this._token)&&this.hasLivePlaceholder(),this.manager.notifyElementManagerObservers("reattach",{element:this.element,detacher:this,insertionPoint:t}),!0)}catch(e){return k.handleError(e,"detacher: failed to reattach element"),!1}}}const L={config:{maxProximitySearchDepth:3,maxGlobalPlaceholderScan:300,maxProximityPlaceholderVisits:800,maxAdjacentPlaceholderScan:400,maxReattachPasses:2,contentRoot:null,root:s.shadow},PLACEHOLDER_PREFIX:"⟪",PLACEHOLDER_SUFFIX:"⟫",_ephemeral:{depth:null},isInRoot(e,t=this.getRoot()){if(!e||!t)return!1;const n=e?.getRootNode?.()||this.getDoc(e);if(n===t)return!0;if(n&&n.host)return this.isInRoot(n.host,t);try{if("function"==typeof t.contains&&e instanceof Node)return t.contains(e)}catch{}return!1},elementManagerObserverSets:{tag:new Set,untag:new Set,detach:new Set,reattach:new Set},getDoc:e=>e&&(e.ownerDocument||e.getRootNode&&e.getRootNode({composed:!0}).ownerDocument)||document,getRoot(){return this.config.contentRoot||this.config.root||document},extractToken(e){return"string"!=typeof e?null:e.startsWith(this.PLACEHOLDER_PREFIX)&&e.endsWith(this.PLACEHOLDER_SUFFIX)?e.slice(this.PLACEHOLDER_PREFIX.length,-this.PLACEHOLDER_SUFFIX.length):null},configure(e={}){const{maxProximitySearchDepth:t,maxGlobalPlaceholderScan:n,maxProximityPlaceholderVisits:a,maxAdjacentPlaceholderScan:o,contentRoot:r,maxReattachPasses:i,root:s}=e;"number"==typeof t&&t>=0&&(this.config.maxProximitySearchDepth=t),"number"==typeof n&&(this.config.maxGlobalPlaceholderScan=Math.max(0,n)),"number"==typeof a&&(this.config.maxProximityPlaceholderVisits=Math.max(0,a)),"number"==typeof o&&(this.config.maxAdjacentPlaceholderScan=Math.max(0,o)),"number"==typeof i&&(this.config.maxReattachPasses=Math.max(1,i)),"object"==typeof r&&r&&(this.config.contentRoot=r),"object"==typeof s&&s&&(this.config.root=s)},generateToken:()=>`det_${crypto.randomUUID()}`,makePlaceholderText(e){return`${this.PLACEHOLDER_PREFIX}${e}${this.PLACEHOLDER_SUFFIX}`},_indexPlaceholder(e,t){if(!e||!t)return;const n=this.extractToken(t.textContent);if(!n)return;let a=N.parentToPlaceholders.get(e);a||(a=new Map,N.parentToPlaceholders.set(e,a)),a.set(n,this._newWeakRef(t))},_unindexPlaceholder(e){if(!e)return;const t=e.parentNode;t&&this._unindexPlaceholderFrom(t,e)},_unindexPlaceholderFrom(e,t){if(!e||!t)return;const n=this.extractToken(t.textContent);if(!n)return;const a=N.parentToPlaceholders.get(e);a&&(a.delete(n),0===a.size&&N.parentToPlaceholders.delete(e))},_hasPlaceholderCached(e){if(!e)return!1;const t=N.tokenToPlaceholderRef.get(e);if(!t)return!1;const n=t.deref?.();return!(!n||!n.isConnected)&&this.isInRoot(n)},_newWeakRef:e=>"function"==typeof WeakRef?new WeakRef(e):{deref:()=>e},getPlaceholderForToken(e,t=null){if(!e)return null;const n=N.tokenToPlaceholderRef.get(e);if(n){const t=n.deref?.();if(t&&t.isConnected&&this.isInRoot(t)){const n=N.tokenToDetacher.get(e);n&&N.placeholderToDetacher.set(t,n);const a=t.parentNode;return a&&this._indexPlaceholder(a,t),t}N.tokenToPlaceholderRef.delete(e)}if(t){const n=N.parentToPlaceholders.get(t);if(n&&n.has(e)){const a=n.get(e),o=a.deref?.();if(o&&o.isConnected&&this.isInRoot(o)&&o.parentNode===t){const t=N.tokenToDetacher.get(e);return t&&N.placeholderToDetacher.set(o,t),N.tokenToPlaceholderRef.set(e,a),o}n.delete(e),0===n.size&&N.parentToPlaceholders.delete(t)}}if(t){const n=this.findPlaceholderProximity(e,t);if(n){const t=N.tokenToDetacher.get(e);t&&N.placeholderToDetacher.set(n,t);const a=this._newWeakRef(n);N.tokenToPlaceholderRef.set(e,a);const o=n.parentNode;return o&&this._indexPlaceholder(o,n),n}}const a=this.findPlaceholderGlobal(e);if(a){const t=N.tokenToDetacher.get(e);t&&N.placeholderToDetacher.set(a,t);const n=this._newWeakRef(a);N.tokenToPlaceholderRef.set(e,n);const o=a.parentNode;return o&&this._indexPlaceholder(o,a),a}return null},captureSignature(e){if(!e||!e.parentNode)return null;const t=e.parentNode,n=e.previousElementSibling,a=e.nextElementSibling;let o=-1,r=0;for(let n=t.firstElementChild;n;n=n.nextElementSibling)n===e&&(o=r),r++;return{parentTag:t.tagName||null,parentId:t.id||null,prevTag:n?.tagName||null,prevId:n?.id||null,nextTag:a?.tagName||null,nextId:a?.id||null,childIndex:o,siblingCount:t.children.length,depth:this.getNodeDepth(e)}},getNodeDepth(e){const t=this._ephemeral.depth;if(t&&t.has(e))return t.get(e);let n=e,a=0;const o=this.getRoot();for(;n&&n.parentNode&&n!==o;)a++,n=n.parentNode;return t&&t.set(e,a),a},buildPath(e){const t=[];let n=e;for(;n&&n.parentNode;){const e=n.parentNode;let a=-1,o=0;for(let t=e.firstElementChild;t;t=t.nextElementSibling){if(t===n){a=o;break}o++}if(t.unshift({tag:n.tagName,index:a}),e.id){t.unshift({id:e.id,tag:e.tagName});break}n=e}return t.length?t:null},navigatePath(e,t){if(!e||!e.length)return null;let n=t;for(const t of e)if(t.id){if(n=n?.querySelector(`#${CSS.escape(t.id)}`),!n)return null}else if("number"==typeof t.index){if(!n||!n.children)return null;const e=n.children[t.index];if(!e)return null;n=e}return n},scoreCandidate(e,t){let n=0;const a=e._signature;if(!a||!t)return n;const o=t.parentNode;if(!o)return n;o.tagName===a.parentTag&&(n+=20),o.id&&o.id===a.parentId&&(n+=50);const r=t.previousElementSibling,i=t.nextElementSibling;r?.tagName===a.prevTag&&(n+=10),r?.id===a.prevId&&(n+=15),i?.tagName===a.nextTag&&(n+=10),i?.id===a.nextId&&(n+=15);const s=this.getNodeDepth(t);n-=2*Math.abs(s-a.depth);const l=e=>0===e?0:1===e?1:e<=4?2:e<=10?3:4;return l(o.children.length)===l(a.siblingCount)&&(n+=5),n},findPlaceholderProximity(e,t){if(!e||!t)return null;const n=this.makePlaceholderText(e);for(const e of t.childNodes)if(e.nodeType===Node.COMMENT_NODE&&e.textContent===n)return e;const a=Math.max(0,0|this.config.maxProximitySearchDepth);let o=t;for(let e=0;e<a&&o&&o.parentNode;e++)o=o.parentNode;const r=this.getDoc(o).createNodeIterator(o,NodeFilter.SHOW_COMMENT,null),i=new Map;let s=t,l=0;for(;s&&l<=a;)i.set(s,l++),s=s.parentNode;let c,d=null,u=1/0;const h=Math.max(0,0|this.config.maxProximityPlaceholderVisits);let p=0;for(;(c=r.nextNode())&&!(h&&++p>h);){if(c.textContent!==n)continue;let e=c.parentNode,t=0;for(;e&&!i.has(e)&&t<=a;)e=e.parentNode,t++;const o=t+(i.get(e)??a+1);if(o<u&&(d=c,u=o,0===u))break}return d},findPlaceholderGlobal(e){if(!e)return null;const t=Math.max(0,0|this.config.maxGlobalPlaceholderScan);if(0===t)return null;const n=this.getRoot(),a=this.getDoc(n),o=this.makePlaceholderText(e),r=a.createNodeIterator(n,NodeFilter.SHOW_COMMENT,null);let i,s=0;for(;i=r.nextNode();){if(s++,i.textContent===o)return i;if(s>=t)break}return null},insertNearSignature(e,t,n){if(!e)return{ok:!1};try{const a=this.getRoot();if(n?.nextId){const o=a.querySelector?.(`#${CSS.escape(n.nextId)}`);if(o&&o.parentNode===e)return e.insertBefore(t,o),{ok:!0,where:"sig-nextId"}}if(n?.prevId){const o=a.querySelector?.(`#${CSS.escape(n.prevId)}`);if(o&&o.parentNode===e)return e.insertBefore(t,o.nextSibling),{ok:!0,where:"sig-prevId"}}if("number"==typeof n?.childIndex&&n.childIndex>=0){const a=e.children[n.childIndex]||null;return e.insertBefore(t,a),{ok:!0,where:"sig-index"}}if(n?.prevTag||n?.nextTag){const a=Array.from(e.children),o=n.prevTag?a.findIndex((e=>e.tagName===n.prevTag)):-1,r=n.nextTag?a.findIndex((e=>e.tagName===n.nextTag)):-1;if(r>=0)return e.insertBefore(t,a[r]),{ok:!0,where:"sig-tag"};if(o>=0)return e.insertBefore(t,a[o].nextSibling),{ok:!0,where:"sig-tag"}}return e.appendChild(t),{ok:!0,where:"parent"}}catch(e){return k.handleError(e,"elementManager.insertNearSignature: failed"),{ok:!1}}},createDetacher(e){return new I(e,this)},makeAnchorBefore(e,t=!0){const n=new Range;return n.setStartBefore(e),n.setEndBefore(e),new R(n,t)},reattachDetachers(e){const t=new Set(e);this._ephemeral.depth=new WeakMap;const n=new Map,a=new Map;for(const e of t)n.set(e,new Set),a.set(e,0);for(const e of t){let o=this.effectiveParentForScope(e);for(;o;){const r=N.elementToDetacher.get(o);if(r&&t.has(r)){n.get(r).add(e),a.set(e,(a.get(e)||0)+1);break}o=o.parentNode}}const o=[...t].filter((e=>0===(a.get(e)||0)));for(;o.length;){const e=o.shift();e.reattach()&&(t.delete(e));for(const t of n.get(e)||[])a.set(t,(a.get(t)||0)-1),0===(a.get(t)||0)&&o.push(t)}const r=Array.from(t).sort(((e,t)=>{const n=this.reattachPriority(e),a=this.reattachPriority(t);return n.bucket!==a.bucket?n.bucket-a.bucket:n.depth!==a.depth?n.depth-a.depth:a.signatureScore-n.signatureScore}));for(const e of r)try{e.reattach()&&t.delete(e)}catch(e){k.handleError(e,"elementManager.reattachDetachers: first pass")}let i=!0,s=0,l=Math.max(1,0|this.config.maxReattachPasses);for(;t.size>0&&i&&s<l;){i=!1,s++;for(const e of Array.from(t))try{e.reattach()&&(t.delete(e),i=!0)}catch(e){k.handleError(e,`elementManager.reattachDetachers: pass ${s}`)}}this._ephemeral.depth=null,t.size>0&&k.handleError(new Error(`Failed to reattach ${t.size} elements after ${s} passes`),"elementManager.reattachDetachers: incomplete")},reattachPriority(e){const t=this._hasPlaceholderCached(e.token),n=e.hasLiveAnchor(),a=!(!e.parent||!e.parent.isConnected),o=t?0:n?1:a?2:3,r=this.effectiveParentForScope(e),i=r?this.getNodeDepth(r):1e3;let s=0;if(e._signature&&r){const t=r.lastElementChild||r;s=this.scoreCandidate(e,t)}return{bucket:o,depth:i,signatureScore:s}},restoreRemovedElements(){let e=Array.from(N.elementsRemoved);e=e.sort(((e,t)=>this.getNodeDepth(e.element)-this.getNodeDepth(t.element)||this.compareDomOrder(e.element,t.element)));for(const t of e)try{t.reattach()}catch(e){k.handleError(e,"elementManager.restoreRemovedElements: failed item")}const t=e.filter((e=>e.isDetached));t.length&&this.reattachDetachers(t)},removeEle(e){try{this.createDetacher(e).detach()}catch(t){try{e.remove?.()}catch(e){k.handleError(e,"elementManager.removeEle: hard remove failed")}k.handleError(t,"elementManager.removeEle: detacher failure – element forcibly removed")}},hasDetachedAncestor(e){let t=e?.parentNode;for(;t;){const e=N.elementToDetacher.get(t);if(e&&e.isDetached)return!0;t=t.parentNode}return!1},getInfo(e,{computeLayout:t=!1}={}){if(!e)return null;const n=N.elementToDetacher.get(e),a=e.isConnected;let o=null;if(t&&a)try{o=e.getBoundingClientRect()}catch(e){k.handleError(e,"elementManager.getInfo: failed to compute layout")}return{tagName:e.tagName,id:e.id||null,classList:Array.from(e.classList||[]),isConnected:a,isDetached:!!n?.isDetached,canReattach:!!n,parentTag:e.parentNode?.tagName||null,categoryList:Array.from(N.elementToCategories.get(e)||[]),rect:o,token:n?.token||null}},effectiveParentForScope(e){let t=e.parent,n=0;for(;t&&n++<100;){const e=N.elementToDetacher.get(t);if(!e||!e.isDetached)break;t=e.parent}return n>=100&&k.handleError(new Error("Potential parent cycle in effectiveParentForScope"),"elementManager"),t},query({root:e=L.config.contentRoot||L.config.root||document,selector:t="*",category:n=null,detachedOnly:a=!1,connectedOnly:o=!1,withInfo:r=!1,filter:i=null,computeLayout:s=!1}={}){let l=[];if(!a){let a=[];if(n){const o=N.categoryToDetachers.get(n);if(o&&o.size)for(const n of o){const o=n.element;o&&o.isConnected&&e.contains(o)&&("*"===t||o.matches(t))&&(!i||i(o))&&a.push(o)}}else e&&e.querySelectorAll&&(a=Array.from(e.querySelectorAll(t)),"function"==typeof i&&(a=a.filter(i)));l.push(...a)}if(!o){let a=[];if(n){const o=N.categoryToDetachers.get(n);if(o&&o.size)for(const n of o){const o=n.element;if(o&&!o.isConnected&&("*"===t||o.matches(t))&&(!i||i(o))){const t=this.effectiveParentForScope(n);t&&e.contains(t)&&a.push(o)}}}else for(const n of N.elementsRemoved){const o=n.element;if(o&&("*"===t||o.matches(t))&&(!i||i(o))){const t=this.effectiveParentForScope(n);t&&e.contains(t)&&a.push(o)}}l.push(...a)}return r?l.map((e=>({element:e,info:this.getInfo(e,{computeLayout:s})}))):l},tag(e,...t){if(!e||!t?.length)return;const n=this.createDetacher(e);let a=N.elementToCategories.get(e);a||(a=new Set,N.elementToCategories.set(e,a));const o=[];for(const e of t){if(!e||a.has(e))continue;a.add(e);let t=N.categoryToDetachers.get(e);t||(t=new Set,N.categoryToDetachers.set(e,t)),t.add(n),o.push(e)}o.length&&o.forEach((t=>this.notifyElementManagerObservers("tag",{element:e,category:t})))},untag(e,...t){if(!e||!t?.length)return;const n=N.elementToDetacher.get(e);if(!n)return;const a=N.elementToCategories.get(e);if(!a)return;const o=[];for(const e of t){if(!a.has(e))continue;a.delete(e);const t=N.categoryToDetachers.get(e);t?.delete(n),t&&0===t.size&&N.categoryToDetachers.delete(e),o.push(e)}o.length&&o.forEach((t=>this.notifyElementManagerObservers("untag",{element:e,category:t}))),0===a.size&&N.elementToCategories.delete(e)},getCategories:e=>Array.from(N.elementToCategories.get(e)||[]),getByCategory(e,{withInfo:t=!1,computeLayout:n=!1}={}){const a=N.categoryToDetachers.get(e);if(!a||!a.size)return[];const o=[];for(const e of a)e.element&&o.push(e.element);return t?o.map((e=>({element:e,info:this.getInfo(e,{computeLayout:n})}))):o},notifyElementManagerObservers(e,t){const n=this.elementManagerObserverSets[e];if(n&&n.size)for(const a of Array.from(n))if("function"==typeof a)try{a(t)}catch(t){k.handleError(t,`elementManager.${e} observer`)}},observe(e,t){return e&&"function"==typeof t&&this.elementManagerObserverSets[e]?(this.elementManagerObserverSets[e].add(t),()=>{this.elementManagerObserverSets[e].delete(t)}):()=>{}},unobserve(e,t){e&&"function"==typeof t&&this.elementManagerObserverSets[e]&&this.elementManagerObserverSets[e].delete(t)},forEachInCategory(e,t){const n=N.categoryToDetachers.get(e);if(!n||!n.size)return 0;let a=0;for(const o of n)if(o?.element)try{t(o.element,o),a++}catch(t){k.handleError(t,`elementManager.forEachInCategory: callback failed for category ${e}`)}return a},compareDomOrder(e,t){if(e===t)return 0;try{const n=e.compareDocumentPosition(t);if(n&Node.DOCUMENT_POSITION_FOLLOWING)return-1;if(n&Node.DOCUMENT_POSITION_PRECEDING)return 1}catch{}const n=N.elementToDetacher.get(e),a=N.elementToDetacher.get(t),o=n?._token||"",r=a?._token||"";return o<r?-1:o>r?1:0},detachCategory(e){const t=[...new Set(Array.isArray(e)?e:[e])],n=new Set;for(const e of t){const t=N.categoryToDetachers.get(e);if(t&&t.size)for(const e of t)e?.element&&n.add(e)}const a=Array.from(n);a.sort(((e,t)=>this.getNodeDepth(t.element)-this.getNodeDepth(e.element)||this.compareDomOrder(t.element,e.element)));let o=0;for(const t of a)try{t.detach()&&o++}catch(t){k.handleError(t,`elementManager.detachCategory: detach failed for ${JSON.stringify(e)}`)}return o},reattachCategory(e){const t=[...new Set(Array.isArray(e)?e:[e])],n=new Set;for(const e of t){const t=N.categoryToDetachers.get(e);if(t&&t.size)for(const e of t)e?.element&&n.add(e)}const a=Array.from(n);a.sort(((e,t)=>this.getNodeDepth(e.element)-this.getNodeDepth(t.element)||this.compareDomOrder(e.element,t.element)));for(const e of a)try{e.reattach()}catch(e){k.handleError(e,"elementManager.reattachCategory: forward-order reattach failed")}const o=a.filter((e=>e.isDetached));return o.length&&this.reattachDetachers(o),a.length},checkpointAndAttachAll(){const e=new Set(N.elementsRemoved),t="cp_"+ ++N._lastCheckpointId;N.checkpoints.set(t,e);let n=Array.from(e);n=n.sort(((e,t)=>this.getNodeDepth(e.element)-this.getNodeDepth(t.element)||this.compareDomOrder(e.element,t.element)));for(const e of n)try{e.reattach()}catch(e){k.handleError(e,"elementManager.checkpointAndAttachAll: failed item")}const a=n.filter((e=>e.isDetached));return a.length&&this.reattachDetachers(a),t},restoreCheckpoint(e){const t=N.checkpoints.get(e);if(!t)throw new Error(`Unknown checkpoint: ${e}`);let n=Array.from(t).filter((e=>!e.isDetached));n=n.sort(((e,t)=>this.getNodeDepth(t.element)-this.getNodeDepth(e.element)||this.compareDomOrder(t.element,e.element)));for(const e of n)if(e)try{e.detach()}catch(e){k.handleError(e,"elementManager.restoreCheckpoint: failed detaching on restore")}const a=Array.from(t).filter((e=>!e.isDetached&&!e.element.isConnected));return a.length&&this.reattachDetachers(a),N.checkpoints.delete(e),!0},withAllAttached(e){const t=this.checkpointAndAttachAll();let n=!1;try{const a=e();return n=!(!a||"function"!=typeof a.then),n?a.finally((()=>{try{this.restoreCheckpoint(t)}catch(e){k.handleError(e,"elementManager.withAllAttached: failed restoring checkpoint (async)")}})):a}finally{if(!n)try{this.restoreCheckpoint(t)}catch(e){k.handleError(e,"elementManager.withAllAttached: failed restoring checkpoint")}}},resetElementCache(){Object.assign(N,{elementsRemoved:new Set,elementToDetacher:new WeakMap,elementToCategories:new WeakMap,categoryToDetachers:new Map,checkpoints:new Map,_lastCheckpointId:0,placeholderToDetacher:new WeakMap,tokenToDetacher:new Map,tokenToPlaceholderRef:new Map,parentToPlaceholders:new WeakMap})}},O={cleanContent(e,t={}){const{restoreRemoved:n=!1,execute:a={},modes:o={},tag:r={}}=t;if(!(e instanceof Element))return console.warn("cleanContent: Expected Element, got",typeof e),document.createElement("div");if(n)try{L.restoreRemovedElements()}catch(e){k.handleError(e)}const i=(()=>{let e="undefined"!=typeof window&&window.location?.href||"http://localhost/";if("undefined"!=typeof document){const t=document.querySelector("base[href]");if(t)try{e=new URL(t.getAttribute("href"),e).href}catch(e){console.warn("cleanContent: invalid <base> href – ignored.",e)}}return e})(),s=e=>Array.isArray(e)?e:[],l={alwaysRemoveSelectors:s(S.alwaysRemoveSelectors),optionalRemoveSelectors:s(S.optionalRemoveSelectors),cleanupAnnotations:Boolean(S.cleanupAnnotations),suspiciousPatterns:[/(?<![a-zA-Z])ad(?:s|v(?:ert(?:s|ising?|isements?)?)?|vertise(?:ment|ments|r|rs)?|block(?:er|ing)?|sense|words?|campaign|network|tech|ops|spend|manager|server|roll|display|buyer|seller|exchange|form|unit|ID|id|view|click|track(?:er|ing)?)?(?![a-zA-Z])|(?<![a-zA-Z\w-])(?:[\w-]+[-_])?ad(?:[-_][\w-]+)?(?![a-zA-Z])/i],containerTags:new Set(["div","section","article","aside","span","p","li","figure","header","footer","nav","main","td","th"]),lazyLoadAttributes:new Set(["data-src","data-lazy-src","data-original","data-lazyload","data-srcset","data-bg","data-background-image"])},c=l.alwaysRemoveSelectors.join(","),d=l.optionalRemoveSelectors.join(","),u=Object.freeze({SELECTORS_ALWAYS_REMOVE:"selectors_always_remove",SELECTORS_OPTIONAL:"selectors_optional",ADS:"ads",IMAGES:"images",SANITIZE:"sanitize"}),h={[u.SELECTORS_ALWAYS_REMOVE]:!1!==a.selectors_always_remove&&!!c,[u.SELECTORS_OPTIONAL]:!1!==a.selectors_optional&&!!d,[u.ADS]:!1!==a.ads,[u.IMAGES]:!1!==a.images&&!!S?.removeAllImagesAndCaptions,[u.SANITIZE]:!1!==a.sanitize},p=new Set(["none","detach","attach","highlight","unhighlight","tag"]),m=e=>e===u.IMAGES?S.removeAllImagesAndCaptions?"highlight":"none":e===u.SELECTORS_ALWAYS_REMOVE||e===u.ADS?S.highlightRemovals?"highlight":"detach":e===u.SELECTORS_OPTIONAL?S.cleanupAnnotations?S.highlightRemovals?"highlight":"detach":"none":(u.SANITIZE,"none"),f=e=>{const t=o[e];return null==t?m(e):p.has(t)?t:m(e)},g={[u.SELECTORS_ALWAYS_REMOVE]:h[u.SELECTORS_ALWAYS_REMOVE]?f(u.SELECTORS_ALWAYS_REMOVE):"none",[u.SELECTORS_OPTIONAL]:h[u.SELECTORS_OPTIONAL]?f(u.SELECTORS_OPTIONAL):"none",[u.ADS]:h[u.ADS]?f(u.ADS):"none",[u.IMAGES]:h[u.IMAGES]?f(u.IMAGES):"none",[u.SANITIZE]:h[u.SANITIZE]?f(u.SANITIZE):"none"},y="string"==typeof r.prefix?r.prefix:"ae-removed",b=(()=>{const e=e=>new Set(Array.isArray(e)?e:[]);return{active:!!r.enabled,prefix:y,attach:e(r.attach),detach:e(r.detach),addClass:e(r.addClass),removeClass:e(r.removeClass),perCategory:r.categories||Object.create(null)}})(),E=e=>{const t=b.perCategory?.[e]||{};return{attach:!!(t.attach??b.attach.has(e)),detach:!!(t.detach??b.detach.has(e)),addClass:!!(t.addClass??b.addClass.has(e)),removeClass:!!(t.removeClass??b.removeClass.has(e)),classSuffix:"string"==typeof t.classSuffix?t.classSuffix:e}},w=/\b[\w-]*(?:caption|credit|source|legend|desc|label|text|description)[\w-]*\b/i,v=/\b[\w-]*(?:image|img|picture|pic|photo|figure|gallery|thumb|thumbnail|avatar|media)[\w-]*\b/i,x=/\b(icon|logo|flag|sprite|emoji|emoticon)[\w-]*\b/i,T=e=>{if(!(e&&e instanceof Element))return!1;if("figcaption"===e.tagName.toLowerCase())return!0;const t=e.textContent?.trim()??"",n=t.split(/\s+/).length,a=t.length>0&&t.length<300&&n<=60,o=(e.getAttribute("class")||"")+" "+(e.getAttribute("id")||"")+" "+(e.getAttribute("role")||"");return a&&w.test(o)&&!e.closest?.("nav, header, footer, button, a[role='button']")},C=e=>!!e&&("img"===e.tagName?.toLowerCase()||"picture"===e.tagName?.toLowerCase()),A=(e,t)=>{if(!(e&&e instanceof Element))return!1;if(C(e))return!1;let n=!1;for(const a of t)if(e.contains(a)){n=!0;break}if(!n)return!1;const a=e.tagName.toLowerCase();if(!l.containerTags.has(a)&&"figure"!==a)return!1;const o=(e.getAttribute("class")||"")+" "+(e.getAttribute("id")||"");return v.test(o)},_=(t,n)=>{let a=t,o=t.closest("figure")||t.parentElement;for(;o&&o!==e&&!A(o,n);)o=o.parentElement;(o&&o!==e&&A(o,n)||o===e&&A(o,n))&&(a=o);try{L.tag(a,u.IMAGES)}catch{}const r=new Set;for(const e of a.children)T(e)&&r.add(e);const i=a.nextElementSibling,s=a.previousElementSibling;if(T(i)&&r.add(i),T(s)&&r.add(s),"a"===t.parentElement?.tagName.toLowerCase()){const e=t.parentElement.nextElementSibling;T(e)&&r.add(e)}for(const e of r)try{L.tag(e,u.IMAGES)}catch{}},N=e=>{if(!e||/^(data:|blob:|about:|javascript:|#)/i.test(e))return e;try{return k.makeAbsoluteUrl(e,i)}catch(t){return console.warn(`cleanContent: absolutize failed for "${e}"`,t),null}},R=e=>(e||"").split(",").map((e=>{const[t,...n]=e.trim().split(/\s+/),a=N(t);return a?[a,...n].join(" "):null})).filter(Boolean).join(", "),I=e=>{let t=!1;for(let n=e.attributes.length-1;n>=0;n--){const a=e.attributes[n];/^on/i.test(a.name)&&(e.removeAttribute(a.name),t=!0)}return t},O=e=>{if(!e.hasAttribute("style"))return!1;const t=e.getAttribute("style");if(!/url\(/i.test(t))return!1;const n=t.replace(/url\(\s*(['"]?)(.*?)\1\s*\)/gi,((e,t,n)=>{if(/^(data:|blob:|#|https?:\/\/)/i.test(n))return`url("${n}")`;const a=N(n);return a?`url("${a}")`:'url("")'}));return n!==t&&(e.setAttribute("style",n),!0)},M=e=>{let t=!1;for(const n of l.lazyLoadAttributes){if(!e.hasAttribute(n))continue;const a=e.getAttribute(n);if(e.removeAttribute(n),a)if(n.endsWith("srcset")){const n=R(a);n&&(e.setAttribute("srcset",n),t=!0)}else if("data-bg"===n||"data-background-image"===n){const n=N(a);n&&(e.style.backgroundImage=`url("${n}")`,t=!0)}else{const n=N(a);n&&(e.setAttribute("src",n),t=!0)}else t=!0}if(e.hasAttribute("src")){const n=e.getAttribute("src"),a=N(n);a&&a!==n?(e.setAttribute("src",a),t=!0):a||(e.removeAttribute("src"),t=!0)}if(e.hasAttribute("srcset")){const n=e.getAttribute("srcset"),a=R(n);a&&a!==n?(e.setAttribute("srcset",a),t=!0):a||(e.removeAttribute("srcset"),t=!0)}return t};try{const t="none"!==g[u.IMAGES]?Array.from(e.querySelectorAll("img, picture")):[],n=[{node:e,visited:!1}];for(;n.length;){const{node:a,visited:o}=n.pop();if(o){if(a!==e&&h[u.SELECTORS_ALWAYS_REMOVE]&&c&&a.matches(c)){try{L.tag(a,u.SELECTORS_ALWAYS_REMOVE)}catch{}if("detach"===g[u.SELECTORS_ALWAYS_REMOVE])continue}if(a!==e&&h[u.SELECTORS_OPTIONAL]&&d&&a.matches(d)){try{L.tag(a,u.SELECTORS_OPTIONAL)}catch{}if("detach"===g[u.SELECTORS_OPTIONAL])continue}if(a!==e&&h[u.ADS]){const e=a.tagName?.toLowerCase();if(l.containerTags.has(e)){const e=a.id||"",t=`${e} ${a.className instanceof SVGAnimatedString?a.className.baseVal:a.className||""}`.toLowerCase();if(l.suspiciousPatterns.some((e=>e.test(t)))){try{L.tag(a,u.ADS)}catch{}if("detach"===g[u.ADS])continue}}}if(h[u.IMAGES]&&C(a)){const e=(a.getAttribute("class")||"")+" "+(a.getAttribute("id")||"")+" "+(a.getAttribute("alt")||"");if(x.test(e)||_(a,t),"detach"===g[u.IMAGES])continue}if(h[u.SANITIZE]){const e=a.tagName?.toLowerCase();let t=!1;if("img"!==e&&"source"!==e&&"picture"!==e||M(a)&&(t=!0),(a.hasAttribute?.("href")||a.hasAttribute?.("src"))&&["href","src"].forEach((e=>{if(!a.hasAttribute(e))return;let n=a.getAttribute(e).trim();if(!n)return void("src"===e&&(a.removeAttribute(e),t=!0));if(/^javascript:/i.test(n))return"href"===e?a.setAttribute("href","#"):a.removeAttribute(e),void(t=!0);if(/^#/.test(n)||/^(mailto|tel|sms):/i.test(n))return;const o=N(n);o?o!==n&&(a.setAttribute(e,o),t=!0):(a.removeAttribute(e),t=!0)})),O(a)&&(t=!0),I(a)&&(t=!0),t)try{L.tag(a,u.SANITIZE)}catch{}}}else{n.push({node:a,visited:!0});for(let e=a.lastElementChild;e;e=e.previousElementSibling)n.push({node:e,visited:!1})}}const a=[u.SELECTORS_ALWAYS_REMOVE,u.SELECTORS_OPTIONAL,u.ADS,u.IMAGES,u.SANITIZE],o=(e,t)=>{const n=L.getByCategory(e),a=E(e).classSuffix||e,o=y,r=`${y}-${a}`;for(const e of n)e?.classList&&("add"===t?e.classList.add(o,r):e.classList.remove(o,r))};for(const e of a){const t=g[e];if("detach"===t){if(e!==u.SANITIZE)try{L.detachCategory(e)}catch(e){k.handleError(e)}}else if("attach"===t)try{L.reattachCategory(e)}catch(e){k.handleError(e)}else if("highlight"===t)try{o(e,"add")}catch(e){k.handleError(e)}else if("unhighlight"===t)try{o(e,"remove")}catch(e){k.handleError(e)}}if(b.active)for(const e of a){const t=E(e);if(t.detach&&e!==u.SANITIZE)try{L.detachCategory(e)}catch(e){k.handleError(e)}if(t.attach)try{L.reattachCategory(e)}catch(e){k.handleError(e)}if(t.addClass)try{o(e,"add")}catch(e){k.handleError(e)}if(t.removeClass)try{o(e,"remove")}catch(e){k.handleError(e)}}return e}catch(t){return console.error("cleanContent: unexpected failure – returning modified input",t),e}},convertToPlainText(e,t={}){if(!e)return"";const{depth:n=0,includeLinks:a=!1,includeImageInfo:o=!1,markdownLike:r=!1}=t;try{let i="";const s=e.childNodes;for(let e=0;e<s.length;e++){const l=s[e];if(l.nodeType===Node.TEXT_NODE)l.parentElement&&l.parentElement.closest("pre")?i+=l.textContent:i+=l.textContent.replace(/[ \t\f\v\r]+/g," ");else if(l.nodeType===Node.ELEMENT_NODE){const e=l.nodeName.toLowerCase();switch(e){case"p":case"div":case"section":case"article":case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":case"header":case"footer":case"main":case"aside":case"nav":{const e=this.convertToPlainText(l,t).trim();e&&(i+=`\n\n${e}\n\n`)}break;case"br":i+="\n";break;case"ul":case"ol":{i+="\n\n";const a="ol"===e,o=l.querySelectorAll(":scope > li");for(let e=0;e<o.length;e++){const r=o[e],s=this.convertToPlainText(r,{...t,depth:n+1}).trim();if(!s)continue;const l="  ".repeat(n),c=a?`${e+1}. `:"• ",d=" ".repeat(c.length);i+=`${l}${c}${s.replace(/\n/g,`\n${l}${d}`)}\n`}i+="\n\n"}break;case"img":o&&l.alt&&(i+=`[Image: ${l.alt}]`);break;case"a":{const e=this.convertToPlainText(l,t),n=l.getAttribute("href");a&&n&&n.trim()&&"#"!==n.trim()?i+=`${e} (${n})`:i+=e}break;case"blockquote":{const e=this.convertToPlainText(l,t).trim();if(e){i+=`\n\n${e.split("\n").map((e=>`> ${e}`)).join("\n")}\n\n`}}break;case"pre":i+=`\n\n\`\`\`\n${l.textContent}\n\`\`\`\n\n`;break;case"code":l.closest("pre")||(i+=`\`${l.textContent}\``);break;case"table":{const e=Array.from(l.querySelectorAll("tr"));if(0===e.length)break;const n=e.map((e=>Array.from(e.querySelectorAll("th, td")).map((e=>this.convertToPlainText(e,t).trim())))),a=n[0].map(((e,t)=>Math.max(...n.map((e=>(e[t]||"").length)))));let o="\n\n";n.forEach(((e,t)=>{o+=e.map(((e,t)=>e.padEnd(a[t]))).join(" | ")+"\n",0===t&&l.querySelector("th")&&(o+=a.map((e=>"-".repeat(e))).join(" | ")+"\n")})),i+=o+"\n"}break;case"hr":i+="\n\n---\n\n";break;case"strong":case"b":i+=r?`**${this.convertToPlainText(l,t)}**`:this.convertToPlainText(l,t);break;case"em":case"i":i+=r?`*${this.convertToPlainText(l,t)}*`:this.convertToPlainText(l,t);break;case"script":case"style":case"noscript":break;default:i+=this.convertToPlainText(l,t)}}}return 0===n?i.replace(/(\n\s*){3,}/g,"\n\n").replace(/ +\n/g,"\n").replace(/\n +/g,"\n").trim():i}catch(t){return console.error("Error in convertToPlainText:",t),e.textContent||""}},async convertToMarkdownTurndown(e){if(!e)return"";try{"undefined"==typeof TurndownService&&await k.loadScript("https://cdnjs.cloudflare.com/ajax/libs/turndown/7.2.1/turndown.min.js");return(new TurndownService).turndown(e||"")}catch(t){return k.handleError(t,"Failed to convert to Markdown"),this.convertToPlainText(e)}},generateHtmlDocument(e,t,n){const{authors:a,tags:o,canonicalUrl:r,url:i,date:s,dateModified:c,description:d,language:u="en",images:h,mainImage:p,publisher:m={},section:f,siteName:g}=n||{},y=Array.isArray(o)?o:o?[o]:[],b=k.escapeHtml(k.stripSiteFromTitle(e,g)),E=k.escapeHtml(i||""),w=k.escapeHtml(r||i||""),v=k.escapeHtml(d||""),S=k.escapeHtml(u),x=s&&!isNaN(Date.parse(s))?new Date(s).toISOString():"",T=c&&!isNaN(Date.parse(c))?new Date(c).toISOString():"",C=k.escapeHtml(Array.isArray(h)&&h.length?h[0]:p||""),A=k.escapeHtml(g||""),_=(m.name&&k.escapeHtml(m.name),m.logo&&k.escapeHtml(m.logo),f?k.escapeHtml(f):""),N=r||i||"",R=s&&!isNaN(Date.parse(s))?new Date(s).toISOString():"",I=c&&!isNaN(Date.parse(c))?new Date(c).toISOString():"",L=Array.isArray(h)&&h.length?h[0]:p||"",O=d||"",M={"@context":"https://schema.org","@type":"NewsArticle",headline:k.stripSiteFromTitle(e,g),description:O,url:N,mainEntityOfPage:{"@type":"WebPage","@id":N},...R&&{datePublished:R},...I&&{dateModified:I},...L&&{image:{"@type":"ImageObject",url:L}},...a.length&&{author:a.map((e=>({"@type":"Person",name:"string"==typeof e?e:e.name||""})))},...m.name&&{publisher:{"@type":"Organization",name:m.name,...m.logo&&{logo:{"@type":"ImageObject",url:m.logo}}}},...y.length&&{keywords:y.join(",")},...f&&{articleSection:f}},D=['<meta charset="UTF-8">','<meta name="viewport" content="width=device-width,initial-scale=1">',`<title>${b}</title>`,w&&`<link rel="canonical" href="${w}">`,v&&`<meta name="description" content="${v}">`,y.length&&`<meta name="keywords" content="${y.map(k.escapeHtml).join(",")}">`,a.length&&`<meta name="author" content="${a.map((e=>k.escapeHtml(e.name||e))).join(", ")}">`,_&&`<meta name="section" content="${_}">`,"\x3c!-- Open Graph --\x3e",'<meta property="og:type" content="article">',A&&`<meta property="og:site_name" content="${A}">`,`<meta property="og:title" content="${b}">`,v&&`<meta property="og:description" content="${v}">`,`<meta property="og:url" content="${E}">`,x&&`<meta property="article:published_time" content="${x}">`,T&&`<meta property="article:modified_time" content="${T}">`,C&&`<meta property="og:image" content="${C}">`,"\x3c!-- Twitter Card --\x3e",'<meta name="twitter:card" content="summary_large_image">',`<meta name="twitter:title" content="${b}">`,v&&`<meta name="twitter:description" content="${v}">`,C&&`<meta name="twitter:image" content="${C}">`,"\x3c!-- JSON-LD --\x3e",`<script type="application/ld+json">\n${JSON.stringify(M,null,2)}\n<\/script>`,"\x3c!-- Styles --\x3e",`<style>\nbody {font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0 auto; line-height: 1.6; color: #333; max-width: 900px; padding: 20px;}\narticle {max-width: 800px; margin: auto;}\nh1 {margin:15px 0px 12px 0px;}\nh1 a {color: black;}\nh1 a:hover {text-decoration: none;}\nh2 {font-size: 1.4em; color: #555; margin-bottom: 0.7em;}\narticle :has(img, picture, video, figure, table, pre, code, iframe) {max-width: 100% !important;height: auto !important;margin-left: auto;margin-right: auto;display: block;}\narticle :is(img, picture, video, figure, table, pre, code, iframe) {max-width: 90%;height: auto;margin: 0.5em 0;margin-left: auto;margin-right: auto;display: block;}\nsection p, section:has(> div:nth-of-type(${l.MIN_PARAGRAPHS_STEP1_CANDIDATE})) div {margin-bottom: 1.5em;}\n.subtitle {color: #444;; font-style: italic; font-size: 1.10em; font-weight: 500;}\n.metadata {color: #666; font-size: 0.95em; margin-bottom:25px;}\na {color: #0066cc; text-decoration: none;}\na:hover {text-decoration: underline;}\n.tags {font-size: .7em;}\n\nblockquote {border-left: 3px solid #ddd; margin-left: 0; padding-left: 15px; color: #555;}\npre {background-color: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto;}\nfigcaption {font-size: 0.9em; color: #555; text-align: center; margin-top: -1em; margin-bottom: 1.5em;}\n</style>`].filter(Boolean).join("\n"),P=s&&k.formatReadableDate?k.escapeHtml(k.formatReadableDate(s)):"",$=a.length?`By ${a.map((e=>`<span>${k.escapeHtml(e.name||e)}</span>`)).join(", ")}`:"";return`\n<!DOCTYPE html>\n<html lang="${S}">\n<head>\n${D}\n</head>\n<body>\n<main id="content">\n<article>\n<header>\n<h1><a href="${E}">${b}</a></h1>\n${d&&!t.innerText.includes(d)?`<h2 class="subtitle">${k.escapeHtml(d)}</h2>`:""}\n<div class="metadata">\n${$?`<span class="byline">${$}</span><br>`:""}\n${P?`<time datetime="${k.escapeHtml(s)}">Published ${P}</time><br>`:""}\n</div>\n</header>\n<section>\n${t.innerHTML}\n</section>\n</article>\n</main>\n</body>\n</html>`},applyTextFiltering(e,t={}){const{reportStats:n=!1,restoreRemoved:a=!1,execute:o={},modes:r={},tag:i={}}=t;if(a)try{L.reattachCategory("text_filter")}catch(e){k.handleError(e)}if(!(e&&e instanceof Element))return"undefined"!=typeof console&&console.warn&&console.warn("applyTextFiltering: Invalid content parameter - returning empty div"),document.createElement("div");if(!S||"object"!=typeof S||!Array.isArray(S.textRemovalRules))return"undefined"!=typeof console&&console.warn&&console.warn("applyTextFiltering: Invalid userPreferences object or missing textRemovalRules array"),e;const s=Object.freeze({TEXT_FILTER:"text_filter"}),l={[s.TEXT_FILTER]:!1!==o.text_filter&&S.textRemovalRules.length>0},c=new Set(["none","detach","attach","highlight","unhighlight","tag"]),d=e=>e===s.TEXT_FILTER?S.highlightRemovals?"highlight":"detach":"none",u={[s.TEXT_FILTER]:l[s.TEXT_FILTER]?(e=>{const t=r[e];return null==t?d(e):c.has(t)?t:d(e)})(s.TEXT_FILTER):"none"};if("none"===u[s.TEXT_FILTER]&&!a)return e;const h="string"==typeof i.prefix?i.prefix:"ae-removed";function p(e,t){if(!e?.classList)return;const n=h,a=`${h}-${t}`;e.classList.add(n,a)}const m=(()=>{const e=e=>new Set(Array.isArray(e)?e:[]);return{active:!!i.enabled,prefix:h,attach:e(i.attach),detach:e(i.detach),addClass:e(i.addClass),removeClass:e(i.removeClass),perCategory:i.categories||Object.create(null)}})(),f=e=>{const t=m.perCategory?.[e]||{};return{attach:!!(t.attach??m.attach.has(e)),detach:!!(t.detach??m.detach.has(e)),addClass:!!(t.addClass??m.addClass.has(e)),removeClass:!!(t.removeClass??m.removeClass.has(e)),classSuffix:"string"==typeof t.classSuffix?t.classSuffix:e}},g={rulesProcessed:0,successfulTextRemovals:0,charactersRemoved:0,textNodesAffectedByDeletion:0,failedRules:[]},y=[];if(S.textRemovalRules.forEach(((e,t)=>{var n,a;if("string"==typeof e&&0!==e.trim().length)try{let t;const n=e.match(/^\/(.+)\/([dgimusy]*)$/);if(n){const[,e,a]=n;t=new RegExp(e,F(a))}else t=new RegExp(e,"gmu");y.push(t),g.rulesProcessed++}catch(o){const r=o instanceof Error?o.message:String(o);if(g.failedRules.push({index:t,rule:e,error:r}),"undefined"!=typeof console&&console.error&&console.error(`applyTextFiltering: Invalid regex pattern "${e}": ${r}`),void 0!==k&&"function"==typeof k.showToast){const t=(a=50,(n=e).length>a?n.substring(0,a-1)+"…":n);k.showToast(`Invalid regex: ${t}`)}}else g.failedRules.push({index:t,rule:e,error:"Rule is empty or invalid string"})})),0===y.length)return e;const b=[],E=[];let w=0;const v=new Set(["P","DIV","H1","H2","H3","H4","H5","H6","BLOCKQUOTE","LI","DD","DT","ARTICLE","SECTION","ASIDE","HEADER","FOOTER","MAIN","NAV","PRE","UL","OL","DL","TABLE","TR","TD","TH","FORM","FIELDSET","ADDRESS","FIGURE","FIGCAPTION","DETAILS","SUMMARY"]),x=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,(t=>function(e,t){for(let n=e.parentElement;n&&n!==t;n=n.parentElement)if(n.hasAttribute("data-preserve")||n.classList.contains("preserve-content"))return!0;return!1}(t,e)?NodeFilter.FILTER_REJECT:t.nodeValue.trim().length>0?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT));let T,C=null;const A=[];for(;T=x.nextNode();){const t=b.length;b.push(T);let n=null;for(let t=T.parentElement;t&&t!==e;t=t.parentElement)if(v.has(t.tagName)){n=t;break}C&&n!==C&&A.length>0&&(A.push("\n"),E[w++]=[-1,-1]),A.push(T.nodeValue);for(let e=0;e<T.nodeValue.length;e++)E[w++]=[t,e];C=n}if(0===b.length)return e;const _=A.join(""),N=new Map;for(const e of y){const t=e.global?e:new RegExp(e.source,F(e.flags));for(const e of _.matchAll(t)){if(0===e[0].length)continue;const t=e.index,n=t+e[0].length;g.successfulTextRemovals++,g.charactersRemoved+=e[0].length;for(let e=t;e<n;e++){const t=E[e];if(t&&-1!==t[0]){const[e,n]=t;N.has(e)||N.set(e,new Set),N.get(e).add(n)}}}}if(0===N.size)return e;g.textNodesAffectedByDeletion=N.size;const R=Array.from(N.keys()).sort(((e,t)=>t-e)),I=new Set,O=u[s.TEXT_FILTER];for(const e of R){let t=b[e];t.parentElement&&I.add(t.parentElement);const n=Array.from(N.get(e)).sort(((e,t)=>e-t)),a=[];if(n.length>0){let e=n[0],t=e+1;for(let o=1;o<n.length;o++){const r=n[o];r===t?t++:(a.push([e,t]),e=r,t=r+1)}a.push([e,t])}for(let e=a.length-1;e>=0;e--){const[n,o]=a[e];let r=null;o<t.nodeValue.length&&(r=t.splitText(o));const i=t.splitText(n),l=document.createElement("span");l.appendChild(i),t.parentNode.insertBefore(l,r),L.tag(l,s.TEXT_FILTER),"detach"===O?L.createDetacher(l).detach():"highlight"===O&&p(l,s.TEXT_FILTER)}0===t.nodeValue.trim().length&&t.remove()}const M=Array.from(I),D=new Set(["A","SPAN","EM","STRONG","I","B","U","S","MARK","CODE","Q","CITE","ABBR","DFN","SAMP","KBD","VAR","TIME","SUB","SUP"]),P=new Set(["P","DIV","H1","H2","H3","H4","H5","H6","BLOCKQUOTE","LI","DD","DT","ARTICLE","SECTION","ASIDE","HEADER","FOOTER","MAIN","NAV"]),$=new Set;for(;M.length>0;){const t=M.shift();if(!t||$.has(t)||!e.contains(t))continue;$.add(t);if(0===t.textContent.trim().length&&0===t.children.length){const n=t.tagName;if(D.has(n)||P.has(n)){const n=t.parentElement;L.tag(t,s.TEXT_FILTER),"detach"===O?L.createDetacher(t).detach():"highlight"===O&&p(t,s.TEXT_FILTER),n&&n!==e&&M.push(n)}}}if(m.active){const e=f(s.TEXT_FILTER);e.attach&&L.reattachCategory(s.TEXT_FILTER),e.detach&&L.detachCategory(s.TEXT_FILTER),e.addClass&&H(s.TEXT_FILTER,"add"),e.removeClass&&H(s.TEXT_FILTER,"remove")}function H(e,t){const n=L.getByCategory(e),a=f(e).classSuffix||e,o=h,r=`${h}-${a}`;for(const e of n)e?.classList&&("add"===t?e.classList.add(o,r):e.classList.remove(o,r))}return n&&(g.charactersRemoved>0||g.failedRules.length>0||g.rulesProcessed>0)&&"undefined"!=typeof console&&console.info&&console.info("applyTextFiltering execution statistics:",g),e;function F(e){let t=e||"";return t.includes("g")||(t+="g"),t.includes("u")||(t+="u"),t}},cleanContentAndFilter(e,t=!0){let n=this.cleanContent(e,{restoreRemoved:t});return S?.textRemovalRules?.length&&(n=this.applyTextFiltering(n)),n}},M={handleCoord:{x:0,y:0},overlayHost:null,detailsPanel:null,controlBar:null,settingsWrapper:null,previewContainer:null,editView:null,updateMarkdownView:null,detailsPanelHighlightSync:null,metadataPreviewController:null,refreshTagHighlight:()=>{},refreshAllTagHighlights:()=>{},refreshDetailsPanelAfterDomUpdate:null,_elementPickerState:{isActive:!1,provisionallySelectedElement:null,confirmationBar:null,originalOverlayDisplay:"",originalOverlayDisplayDiv:"",originalBackdropDisplay:"",originalBodyPointerEvents:"",originalDetailsPanel:"",onElementAccepted:null,onPickerCancelled:null,eventListeners:{click:null,keydown:null}},createOverlay(){const e=document.createElement("div");e.className="ae-overlay-host",e.id="ae-host",e.style.cssText="all: initial !important;",this.overlayHost=e;const t=e.attachShadow({mode:"closed"});s.shadow=t,t.adoptedStyleSheets=[d];const n=document.createElement("div");n.id="ae-backdrop",t.appendChild(n);const a=document.createElement("div");return a.className="ae-overlay",a.id="ae-overlay",t.appendChild(a),this.overlay=a,s.overlay=a,k.makeInert(),{host:e,overlay:a}},createControls(e,t){const n=document.createElement("div");n.className="ae-controls",n.id="article-control-bar";const a=document.createElement("div");a.id="article-control-bar-right";const o=document.createElement("button");o.textContent="Close",o.className="ae-btn ae-btn-close",n.addEventListener("click",(()=>{e.scrollTo({top:0,behavior:"auto"})}));const r=(e,n=!1)=>{t&&t(),document.body.classList.remove("modal-open"),k.makeInert(!1),s.listeners.currentEscapeHandler&&(document.removeEventListener("keydown",s.listeners.currentEscapeHandler),s.listeners.currentEscapeHandler=null),_.readabilityContent=null,_.metadata=null,_.updateContent=null,_.findArticleCache=null,_.css=null,L.resetElementCache(),A.isInitialized&&A.cleanup(),n&&("function"===s.cleanupFunctions.extractButtonCleanup&&(s.cleanupFunctions.extractButtonCleanup(),s.cleanupFunctions.extractButtonCleanup=null,document.querySelector("#ae-button")?.remove()),document.querySelectorAll(".ae").forEach((e=>{e.remove()})),document.querySelector("#ae-toast-container")?.remove(),M._elementPickerState.isActive&&document.querySelector("#ae-selection-bar")?.remove())};o.addEventListener("click",r),l.IS_SAFARI?window.onpagehide=r.bind(null,void 0,!l.IS_USERSCRIPT):window.onbeforeunload=r.bind(null,void 0,!l.IS_USERSCRIPT),s.listeners.currentEscapeHandler&&document.removeEventListener("keydown",s.listeners.currentEscapeHandler);const i=e=>{if("Escape"===e.key){if(this._elementPickerState.isActive)return;r()}};return document.addEventListener("keydown",i),s.listeners.currentEscapeHandler=i,n.appendChild(a),a.appendChild(o),n},createSettingsWrapper(e){const t=document.createElement("div");t.className="article-settings-wrapper",this.settingsWrapper=t;const n=document.createElement("div");n.className="metadata-inputs";const a=document.createElement("div");a.className="metadata-details";const o=document.createElement("input");o.type="text",o.id="title",o.value=k.stripSiteFromTitle(e.title,e.siteName),o.className="ae-title",o.addEventListener("input",h((()=>{_.metadata.title=o.value}),300));const r=document.createElement("input");r.type="text",r.id="input",r.value=e.authors?.map((e=>e.name)).join(", ")||"",r.placeholder="Author",k.applyStyles(r,{flex:"1",minWidth:"120px"}),r.addEventListener("input",h((()=>{const e=k.parseAuthors(r.value);_.metadata.authors=e.authors.map((e=>({name:e})))}),300));const i=document.createElement("input");i.type="text",i.id="date",i.value=k.formatReadableDate(e.date||e.dateModified)||"",i.placeholder="Date",k.applyStyles(i,{flex:"1",minWidth:"120px"}),i.addEventListener("input",h((()=>{const e=i.value.trim().toLowerCase();if("now"===e||"today"===e||"tonight"===e||"current"===e||"present"===e)_.metadata.date=(new Date).toISOString(),i.value=k.formatReadableDate(_.metadata.date);else{const e=Date.parse(i.value);_.metadata.date=isNaN(e)?i.value:new Date(e).toISOString()}}),300)),a.appendChild(r),a.appendChild(i);const s=document.createElement("input");s.type="text",s.id="excerpt",s.value=(e.description.includes("...")||e.description.includes("…")?"":e.description)||"",s.className="ae-subheading",s.addEventListener("input",h((()=>{_.metadata.description=s.value}),300)),n.appendChild(o),n.appendChild(a),n.appendChild(s);const l=()=>({..._.metadata,title:o.value,author:k.parseAuthors(r.value).author,authors:k.parseAuthors(r.value).authors.map((e=>({name:e,url:"",role:""}))),date:_.metadata.date,description:s.value}),c=document.createElement("div");c.className="metadata-preview-wrapper",n.appendChild(c);const d=[o,a,s];let u=!1;const p=e=>{u=!!e,n.classList.toggle("showing-preview",u),d.forEach((e=>{e&&(e.style.display=u?"none":"")})),c.style.display=u?"block":"none",c.innerHTML=u?(()=>{const{authors:e,url:t,date:n,description:a,title:o,siteName:r}=l(),i=k.escapeHtml(k.stripSiteFromTitle(o,r)),s=(k.escapeHtml(t||""),n&&k.escapeHtml(k.formatReadableDate(n))),c=e.length?`By ${e.map((e=>`<span>${k.escapeHtml(e.name||e)}</span>`)).join(", ")}`:"";return`<header id="header-preview">\n  <h2>${i}</h2>\n    <h3 class="subtitle">${k.escapeHtml(a)}</h3>\n  <div class="metadata">\n    ${c?`<span class="byline">${c}</span><br>`:""}\n    ${s?`<time datetime="${k.escapeHtml(n)}">Published ${s}</time><br>`:""}\n  </div>\n</header>`})():""},m={setActive:e=>p(e),isActive:()=>u};return M.metadataPreviewController=m,t.appendChild(n),{settingsWrapper:t,getCurrentMetadata:l}},createPreviewTabs(e){let t=null;const n=document.createElement("div");n.id="preview-contents-container",this.previewContainer=n;const r=document.createElement("div");r.className="ae-tab-container";const i=document.createElement("button");i.textContent="Edit Article",i.className="ae-tab selected";const c=document.createElement("button");c.textContent="Markdown Preview",c.className="ae-tab";const d=[i,c];r.appendChild(i),r.appendChild(c);const u=document.createElement("div");u.id="md_view",u.classList.add("extractor-preview-content");const h=document.createElement("div");function p(e=!0){let t;return t=h.firstChild?e?h.firstChild.cloneNode(!0):h.firstChild:document.createElement("div"),t.querySelectorAll(".ae-removed").forEach((e=>{e.remove()})),t}h.id="edit_view",h.classList.add("extractor-preview-content"),this.editView=h,L.configure({contentRoot:h}),e&&h.appendChild(e);let m=null;function f(e,t=[]){if(!e||e.nodeType!==Node.ELEMENT_NODE)return t;t.push(e);for(const n of e.children)f(n,t);return t}function g(e){if(!e||e.nodeType!==Node.ELEMENT_NODE)return;const t=("string"==typeof e.className?e.className:"").trim(),n=t?t.split(/\s+/):[],a=n.filter((e=>e&&!e.startsWith("ae-removed")));a.length?a.length===n.length&&a.join(" ")===n.join(" ")||(e.className=a.join(" ")):e.hasAttribute("class")&&e.removeAttribute("class");for(const t of e.children)g(t)}const y={};const b=new Set(["ae-removed-flash"]);function E(e){const t=Array.from(e.classList||[]);let n=t.find((e=>e.startsWith("ae-removed-")&&!b.has(e)));return!n&&t.includes("ae-removed")&&(n="ae-removed"),n?function(e){if(!y[e]){const t=document.createElement("span");t.className=e,s.shadow.appendChild(t),y[e]=getComputedStyle(t).outlineColor,t.remove()}return y[e]}(n):null}function w(e,t=.15){if(!e||"string"!=typeof e)return null;const n=e.trim().match(/^#?([0-9a-f]{3}|[0-9a-f]{6})$/i);if(!n)return null;let a=n[1];3===a.length&&(a=a.split("").map((e=>e+e)).join(""));const o=parseInt(a,16);return`rgba(${o>>16&255}, ${o>>8&255}, ${255&o}, ${t})`}function v(e,t,n=[],a=[],o=[],r={}){const{indentUnit:i="  ",newLine:s="\n",whitespacePolicy:l="smart",preserveTags:c=["pre","code","script","style","textarea","title"],trimTextNodes:d=!0,maxConsecutiveBlankLines:u=1,wrapComments:h=!1,wrapDoctype:p=!1,debug:m=!1,tagWrapper:f="span",tagClass:g="ae-html-tag",useShadowStyles:y=!1,elementIndexLookup:b=null}=r,E=new Set(["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr"]),v=new Set(["script","style"]),S=new Set(["textarea","title"]),x=new Set(c.map((e=>e.toLowerCase()))),T=(e,t)=>{const r=Number.isFinite(t)?t:null,i=(e=>{if(!Number.isFinite(e))return[];const t=[],o=n[e],r=a[e];if(o&&t.push(`outline: 1.5px solid ${o}`),r){t.push(`--ae-html-tag-accent: ${r}`);const e=w(r,.14),n=w(r,.22),a=w(r,.3);e&&t.push(`--ae-html-tag-bg: ${e}`),n&&t.push(`--ae-html-tag-hover: ${n}`),a&&t.push(`--ae-html-tag-active: ${a}`)}return t})(r),s=Number.isFinite(r)?o[r]:null,l=[`class="${g}"`];return Number.isFinite(r)&&l.push(`data-el-idx="${r}"`),s&&l.push(`data-slice="${k.escapeHtml(s)}"`),i.length>0&&l.push(`style="${i.join("; ")}"`),y&&l.push('part="html-tag"'),`<${f} ${l.join(" ")}>${k.escapeHtml(e)}</${f}>`},C=e=>{const t=e.tagName.toLowerCase(),n=(e=>{const t=Array.from(e.attributes);return 0===t.length?"":" "+t.map((e=>{const t=e.name,n=e.value;return`${t}="${k.escapeHtml(n)}"`})).join(" ")})(e);return`<${t}${n}>`},A=e=>{if("preserve"===l)return!0;if("collapse"===l)return!1;const t=e?.tagName?.toLowerCase();return t&&x.has(t)},_=[];let N=0,R=0;const I=(e,{preserve:t=!1}={})=>{const n=!e||0===e.trim().length;if(!t)if(n){if(N>=u)return;N++}else N=0;_.push(e)},L=e=>i.repeat(Math.max(0,e)),O=(e,t,n)=>{const a=(e=>{const t=e.tagName.toLowerCase();return E.has(t)?"":`</${t}>`})(e);if(!a)return;const o=T(a,n);I(L(t)+o)},M=(e,t,{preserve:n=!1}={})=>{const a=L(t),o=e.split(/\r?\n/);for(let e=0;e<o.length;e++){const t=o[e];(t||n)&&I(a+k.escapeHtml(t),{preserve:n})}},D=(e,t=0,n=null)=>{if(e)switch(e.nodeType){case Node.ELEMENT_NODE:{const n=e,a=n.tagName.toLowerCase(),o=b?.get(n);R++;const r={isVoid:E.has(a),isRawText:v.has(a),isRCData:S.has(a),preserveWhitespace:A(n),elementIndex:o};if(((e,t,n)=>{const a=C(e),o=T(a,n);I(L(t)+o)})(n,t,o),r.isRawText||r.isRCData){const e=n.textContent||"";e.length&&M(e,t+1,{preserve:!0})}else if(!r.isVoid){let e=n.firstChild;for(;e;)D(e,t+1,r),e=e.nextSibling}r.isVoid||O(n,t,o);break}case Node.TEXT_NODE:{const a=e.textContent||"",o=n?.preserveWhitespace||A(e.parentElement),r=((e,t)=>{if(t)return e;let n=e.replace(/[ \t\r\n\f]+/g," ");return d&&(n=n.trim()),n})(a,o);r&&M(r,t,{preserve:o});break}case Node.COMMENT_NODE:{const n=`\x3c!--${e.textContent||""}--\x3e`,a=h?T(n,null):k.escapeHtml(n);I(L(t)+a);break}case Node.DOCUMENT_TYPE_NODE:{const n=e;let a=`<!DOCTYPE ${n.name}`;n.publicId&&(a+=` PUBLIC "${n.publicId}"`),n.systemId&&(a+=n.publicId?` "${n.systemId}"`:` SYSTEM "${n.systemId}"`),a+=">";const o=p?T(a,null):k.escapeHtml(a);I(L(t)+o);break}case Node.PROCESSING_INSTRUCTION_NODE:I(L(t)+k.escapeHtml(`<?${e.target} ${e.data}?>`));break;case Node.CDATA_SECTION_NODE:I(L(t)+k.escapeHtml(`<![CDATA[${e.textContent||""}]]>`))}};let P=e.firstChild;for(;P;)D(P,0,null),P=P.nextSibling;let $=_.join(s);return $=$.replace(/[ \t]+$/gm,""),$&&!$.endsWith(s)&&($+=s),m&&(t&&t.length&&R!==t.length&&console.warn(`[wrapHtmlWithClickableTags] Element count mismatch: processed ${R}, expected ${t.length}`),console.log(`[wrapHtmlWithClickableTags] Stream-processed ${R} elements`)),$}const S=document.createElement("div");S.id="ae-details-panel",S.style.display="none",s.shadow.appendChild(S);let x=l.IS_MOBILE,T=null,C=!1,A=new WeakMap;const _=()=>{A=new WeakMap},N=e=>{if(!e)return;let t=e;for(;t&&t!==h&&t!==document.body&&t!==document.documentElement;)A.delete(t),t=t.parentElement};let R,I,D=!1,P=null,$=!1;const H=["child","siblings","ancestor"],F={child:{filterLabel:"Show HTML",accent:"#0B7DDA"},siblings:{filterLabel:"Show Siblings",accent:"#8E3FD4"},ancestor:{filterLabel:"Show Ancestors",accent:"#3d8b40"}},z=new Map,U=new Set;let B=null,j=()=>{},G=null,W=null;const q=(e,t={})=>{if(!t||"object"!=typeof t)return{...e};const{obstructiveElements:n,...a}=t;return n?{...e,...a,obstructiveElements:{...e.obstructiveElements,...n}}:{...e,...a}},V=(e={})=>{if(!S)return{...e};const t={};W instanceof Element&&(t.top=W);return q({scrollContainer:S,obstructiveElements:t,horizontalOnScreenFactor:1},e)},Y=(e={})=>{const t=M.overlay||s.overlay||window,n={};if(M.controlBar instanceof Element&&(n.top=M.controlBar),S instanceof Element&&t instanceof Element){const e=t.getBoundingClientRect(),a=S.getBoundingClientRect(),o=Math.max(0,Math.min(a.right,e.right)-Math.max(a.left,e.left)),r=Math.max(0,Math.min(a.bottom,e.bottom)-Math.max(a.top,e.top));o>0&&a.top<e.bottom&&(n.bottom=S),r>0&&a.left<e.right&&(n.right=S),r>0&&a.left<e.left&&a.right>e.left&&(n.left=S)}return q({scrollContainer:t,obstructiveElements:n,horizontalOnScreenFactor:0},e)},X=(e,t)=>{Array.isArray(e)||(e=[e]),e[0].classList.contains(t)||(requestAnimationFrame((()=>{e.forEach((e=>{e.classList.remove(t),e.classList.add(t)}))})),a((()=>{e.forEach((e=>{e.classList.remove(t)}))}),905))},K=async(e,t=!0)=>{if(!e||!S)return;const n=(e=>{if(!e)return[];const t=M.detailsPanelHighlightSync;return t&&"function"==typeof t.getTagsForElement?t.getTagsForElement(e):[]})(e),a=n.find((e=>e.isConnected));if(a){const e=V({horizontalOnScreenFactor:0,keepTallElements:!1,scrollTo:!1}),o=V({onScreenFactor:1,keepTallElements:!1}),r=oe(a,e);if(!r&&t)return await le(a,o),void X(n,"ae-tag-flash");const i=oe(n[1],e);r&&i?X(n,"ae-tag-flash"):!r&&i?X(n[1],"ae-tag-flash"):r&&!i?X(n[0],"ae-tag-flash"):(await le(a,o),X(n,"ae-tag-flash"))}},J=()=>{T||(T=document.createElement("button"),T.className="ae-restore-btn",T.textContent="Show Details",s.shadow.appendChild(T),T.addEventListener("click",(()=>{x=!1,C=!1,D||!$?ne(!0):S.style.display="block",T&&(T.remove(),T=null)}))),T.style.display="block"};let Z,Q={restore:null,panel:null};const ee=new Set;function te(e={}){const{refresh:n=!1,init:a=null}=e,o=M.metadataPreviewController;if(a){Z=document.createElement("button"),Z.id="ae-preview-btn",Z.className="ae-preview-btn ae-btn disabled",Z.textContent="Preview";a.querySelector("#article-control-bar-right").appendChild(Z),Z.addEventListener("click",(e=>{"Previewing"===Z.textContent?(Z.textContent="Preview",Z.classList.remove("previewing"),T&&Q.restore&&(T.style.display=Q.restore),S&&Q.details&&(S.style.display=Q.details)):(Z.textContent="Previewing",Z.classList.add("previewing"),Q.details=S?.style.display,Q.restore=T?.style.display,T&&(T.style.display="none"),S&&(S.style.display="none")),te(),e.preventDefault(),e.stopPropagation()}))}if(!Z)return;n&&(ee.forEach((e=>e.classList.remove("invisible"))),ee.clear(),Z.textContent="Preview",Z.classList.remove("previewing"),Q.details=null,Q.restore=null,o?.setActive?.(!1)),t=new Set(h.querySelectorAll(".ae-removed"));const r="Previewing"===Z.textContent;o?.setActive?.(r),r?(t.forEach((e=>{ee.has(e)||(e.classList.add("invisible"),ee.add(e))})),ee.forEach((e=>{t.has(e)||(e.classList.remove("invisible"),ee.delete(e))}))):(ee.forEach((e=>e.classList.remove("invisible"))),ee.clear());const i=0===t.size,l="markdown"===s.currentTab,c=i||l;Z.classList.toggle("disabled",c),Z.disabled=c,i&&r&&(Z.textContent="Preview",Z.classList.remove("previewing"),T&&Q.restore&&(T.style.display=Q.restore),S&&Q.details&&(S.style.display=Q.details),o?.setActive?.(!1))}const ne=(e=!1,t={})=>{const n=t.retainHtml,o=m||P,r=Boolean(m),i=r&&P!==m;if(!o)return S.style.display="none",T&&(T.style.display="none"),P=null,D=!1,_(),C||(x=l.IS_MOBILE),void(G&&(G.textContent="No element selected",G.dataset.state="none"));if(x&&!e)return i&&(D=!0),void J();if(D=!1,T&&(T.style.display="none"),!$){S.innerHTML='\n<div id="html-toolbar" style="background-color:white;position:sticky;top:0;outline:0.5px solid #bbb;z-index:1;">\n<div style="display:flex; align-items:center; justify-content:space-between;">\n<span id="ae-resize-handle">⠿</span>\n<span style="font-weight:bold; font-size:15px;"><span id="details-panel-selection-state">Element Details:</span><code id="details-panel-tag" style="padding:5px;"></code></span>\n\n\n<button id="minimize-details-btn" title="Minimize" aria-label="Minimize details panel">━</button>\n</div>\n<div style="display:flex;gap:3px;flex-wrap:wrap;justify-content:space-between;padding:5px;">\n<div id="html-filter-container" style="display:flex;gap:0px 6px;flex-wrap:wrap;padding:4px 4px 0px 0px;"></div>\n<button id="quick-remove-btn" class="ae-btn-small orange">Quick Remove</button>\n</div>\n</div>\n<dl id="details-dl-list" style="margin: 0px 5px 0px 5px;">\n\n<dt style="font-weight:bold; margin-top:.5em;">ID:</dt>\n<dd id="details-panel-id" style="margin:0 0 .5em 1em;"></dd>\n\n<dt style="font-weight:bold; margin-top:.5em;">Classes:</dt>\n<dd id="details-panel-classes" style="margin:0 0 .5em 1em;"></dd>\n\n<dt style="font-weight:bold; margin-top:.5em;">Attributes:</dt>\n<dd id="details-panel-attrs" style="margin:0 0 .5em 1em;"></dd>\n\n<dt id="details-panel-categories-label" style="font-weight:bold; margin-top:.5em;">Categories:</dt>\n<dd id="details-panel-categories" style="margin:0 0 .5em 1em;"><em>None</em></dd>\n</dl>\n<div id="ae-markup-container"></div>\n',G=S.querySelector("#details-panel-selection-state"),G&&(G.dataset.state="none");const e=S.querySelector("#ae-resize-handle");(()=>{const t=160,n=120,a=10,o=()=>window.innerWidth-2*a,r=()=>window.innerHeight-2*a;let i,s,l,c;function d(e){const d=e.clientX-i,u=e.clientY-s;let h=l-d,p=c-u;h=Math.min(Math.max(h,t),o()),p=Math.min(Math.max(p,n),r()),S.style.width=h+"px",S.style.height=p+"px",M.handleCoord.x=h+a,M.handleCoord.y=p+a}function u(t){e.removeEventListener("pointermove",d),e.releasePointerCapture(t.pointerId)}e.addEventListener("pointerdown",(function(t){t.button&&0!==t.button||(t.preventDefault(),i=t.clientX,s=t.clientY,l=S.offsetWidth,c=S.offsetHeight,e.setPointerCapture(t.pointerId),e.addEventListener("pointermove",d),e.addEventListener("pointerup",u,{once:!0}),e.addEventListener("pointercancel",u,{once:!0}))}))})();const t=S.querySelector("#html-filter-container");H.forEach((e=>{const n=F[e],a=document.createElement("label");a.className="ae-html-filter",a.style.display="flex",a.style.alignItems="center",a.style.gap="4px";const o=document.createElement("input");o.type="checkbox",o.dataset.slice=e,o.id=`ae-toggle-${e}-html`;const r=document.createElement("span");r.textContent=n.filterLabel,r.style.color=n.accent,a.appendChild(o),a.appendChild(r),t.appendChild(a),z.set(e,o)}));const n=(M.detailsPanelHighlightSync||(M.detailsPanelHighlightSync=function({getHighlightColor:e,invalidateSliceCache:t}={}){const n=new Set,a=new WeakMap,o=e=>{if(!e)return null;let t=a.get(e);return t||(t={elements:[],elementToIndex:new Map,tagsByIndex:new Map,getElements:null,dirty:!1},a.set(e,t)),t},r=(e,t)=>{if(!e||!t)return t;const n="function"==typeof t.getElements?t.getElements():t.elements,a=Array.isArray(n)?n:[];return t.elements=a,t.elementToIndex=new Map,a.forEach(((e,n)=>{e&&t.elementToIndex.set(e,n)})),t.tagsByIndex=new Map,t.dirty=!1,t},i=(e,t)=>{if(!e||!t)return new Map;const n=new Map;return e.querySelectorAll(".ae-html-tag").forEach((e=>{const t=Number(e.dataset.elIdx);Number.isFinite(t)&&(n.has(t)||n.set(t,[]),n.get(t).push(e))})),t.tagsByIndex=n,n},s=(e,t,n)=>{if(!e||!t||null==n)return[];if(t.tagsByIndex||i(e,t),!t.tagsByIndex.has(n)){const a=Array.from(e.querySelectorAll(`.ae-html-tag[data-el-idx="${n}"]`));t.tagsByIndex.set(n,a)}return t.tagsByIndex.get(n)||[]},l=(e,t)=>{const n=t?`1.5px solid ${t}`:"";e.forEach((e=>{e&&e.style&&(e.style.outline=n)}))},c=t=>{const n=o(t);n&&(n.dirty&&r(t,n),i(t,n),n.elements.forEach(((t,a)=>{const o=e?.(t)||null,r=n.tagsByIndex.get(a)||[];l(r,o)})))},d=e=>{n.delete(e),a.delete(e)},u={register:(e,{getElements:t}={})=>{if(!e)return()=>{};n.add(e);const a=o(e);return a&&(a.getElements=t||a.getElements,a.dirty=!0),()=>d(e)},unregister:d,refreshElement:t=>{if(!t)return;const a=e?.(t)||null;n.forEach((e=>{const n=o(e);if(!n)return;n.dirty&&r(e,n);const i=n.elementToIndex.get(t);if(null==i)return;const c=s(e,n,i);l(c,a)}))},refreshContainer:c,refreshAll:()=>n.forEach((e=>c(e))),onMarkupUpdated:(e,t)=>{const n=o(e);n&&(Array.isArray(t)?(n.elements=t,n.elementToIndex=new Map,t.forEach(((e,t)=>{e&&n.elementToIndex.set(e,t)})),n.tagsByIndex=new Map,n.dirty=!1):n.dirty=!0,c(e))},clearElements:()=>{n.forEach((e=>{const t=o(e);t&&(t.elements=[],t.elementToIndex=new Map,t.tagsByIndex=new Map,t.dirty=!1,e&&(e._aeElements=null,e._aeRenderedResult=null))}))},invalidateElement:(e,{dropIndex:t=!1}={})=>{e&&n.forEach((n=>{const o=a.get(n);if(!o)return;const r=o.elementToIndex.get(e);null!=r&&(o.tagsByIndex&&o.tagsByIndex.delete(r),t&&(o.elementToIndex.delete(e),o.dirty=!0))}))},getTagsForElement:e=>{if(!e)return[];const t=[];return n.forEach((n=>{const a=o(n);if(!a)return;a.dirty&&r(n,a);const i=a.elementToIndex.get(e);null!=i&&s(n,a,i).forEach((e=>{e instanceof HTMLElement&&t.push(e)}))})),t}},h=({element:e})=>{t?.(e),u.invalidateElement(e),u.refreshElement(e)},p=({element:e})=>{t?.(e),u.invalidateElement(e,{dropIndex:!0}),u.refreshElement(e)};return u._observers=[L.observe("tag",h),L.observe("untag",h),L.observe("detach",p),L.observe("reattach",p)],u}({getHighlightColor:E,invalidateSliceCache:N})),M.detailsPanelHighlightSync);M.refreshTagHighlight=e=>n.refreshElement(e),M.refreshAllTagHighlights=()=>n.refreshAll(),B=S.querySelector("#ae-markup-container");const o=e=>{B.innerHTML=`<div class="ae-html-empty" style="font-style:italic; color:#666;">${e}</div>`,B._aeElements=null,B._aeRenderedResult=null,n.onMarkupUpdated?.(B,[])};o("Enable an HTML slice above to display markup."),n.register(B,{getElements:()=>B?._aeElements||[]});const r=e=>F[e]?.accent||null,i=e=>{if(!e||e.nodeType!==Node.ELEMENT_NODE)return;g(e);const t=e=>{e&&e.nodeType===Node.ELEMENT_NODE&&(e.removeAttribute("style"),Array.from(e.children).forEach(t))};t(e)},c=()=>{if(!P||!U.size||!h.contains(P))return null;const e=Array.from(U).sort(),t=e.join("|")||"__none__",n=(e=>{if(!e)return null;let t=A.get(e);return t||(t=new Map,A.set(e,t)),t})(P);if(!n)return null;if(n.has(t))return n.get(t);const a=e.includes("ancestor"),o=e.includes("siblings"),s=e.includes("child"),l=[];let c=P.parentElement;for(;c&&c!==document.documentElement&&c!==document.body&&h.contains(c)&&c!==h;)l.unshift(c),c=c.parentElement;const d=P.parentElement,u=d&&d!==h&&h.contains(d),p=[],m=[],g=[],y=[],b=new WeakMap,w=(e,t)=>{const n=t?r(t):null,a=p.length;return e.forEach((e=>{p.push(e),m.push(E(e)),g.push(n),y.push(t??null)})),{startIndex:a,count:e.length}},S=(e,t)=>e?w([e],t):{startIndex:p.length,count:0},x=(e,t)=>{if(!e)return{startIndex:p.length,count:0};const n=f(e,[]);return w(n,t)},T=document.createElement("div");let C=T;const _=(e,t,n,a=!0)=>{if(!e||!t)return null;const o=t.cloneNode(a);if(!a)for(;o.firstChild;)o.removeChild(o.firstChild);let r;return i(o),e.appendChild(o),r=null==n?a?x(t,null):S(t,null):a?x(t,n):S(t,n),r&&r.count>0&&((e,t,n)=>{if(!e||!Number.isFinite(t)||!Number.isFinite(n)||n<=0)return;const a=f(e,[]),o=a.length,r=Math.min(n,o);for(let e=0;e<r;e++)b.set(a[e],t+e)})(o,r.startIndex,r.count),o};a&&l.length?l.forEach((e=>{C=_(C,e,"ancestor",!1)||C})):o&&u&&(C=_(C,d,null,!1)||C);const k=C===T?null:C,N=k||T,R=[],I=[];if(o&&u&&d){let e=d.firstElementChild;for(;e&&e!==P;)R.push(e),e=e.nextElementSibling;for(e=P.nextElementSibling;e;)I.push(e),e=e.nextElementSibling}const L=()=>{_(N,P,"child",s)};o&&u&&k?(R.forEach((e=>_(k,e,"siblings",!0))),L(),I.forEach((e=>_(k,e,"siblings",!0)))):L();const O={interactiveMarkup:v(T,p,m,g,y,{elementIndexLookup:b}),elements:p,outlines:m,accents:g,slices:y,cacheKey:t,sortedSlices:e};return n.set(t,O),O};j=()=>{if(!B)return;if(!U.size)return o("Enable an HTML slice above to display markup."),void(B.style.display="none");if(!P)return B.style.display="block",void o("Select an element to view its HTML context.");const e=c();if(B.style.display="block",!e||!e.interactiveMarkup||!e.elements.length)return void o("No HTML available for the current selection.");const t=`<pre>${e.interactiveMarkup}</pre>`,a=B._aeRenderedResult!==e;B._aeRenderedResult=e,B._aeElements=e.elements,a&&(B.innerHTML=t),n.onMarkupUpdated?.(B,e.elements)},R=(e,{rebuild:t=!1}={})=>{U.add(e),t&&_(),j()},I=e=>{U.delete(e),U.size?j():(o("Enable an HTML slice above to display markup."),B.style.display="none")};const d=S.querySelector("#html-toolbar");W=d;const u=e=>{const t=e.target.closest(".ae-copyable");if(!t)return;e.preventDefault();const n=t.dataset.copy||t.textContent.trim(),a=()=>{const e=document.createElement("textarea");e.value=n,e.style.position="fixed",e.style.opacity="0",e.className="ae",document.body.appendChild(e),e.select();try{document.execCommand("copy"),k.showToast(`Copied selector: ${n}`,1800)}catch(e){k.showToast("Unable to copy selector.")}document.body.removeChild(e)};navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(n).then((()=>k.showToast(`Copied selector: ${n}`,1800))).catch((()=>a())):a()},p=300;let y=null,b=!1;const w=()=>{y&&(clearTimeout(y),y=null)};S.addEventListener("pointerdown",(e=>{const t=e.target.closest(".ae-html-tag");t&&(b=!1,y=a((async()=>{y=null;const e=t.closest("#ae-markup-container"),n=e&&e._aeElements,a=Number(t.dataset.elIdx),o=n&&n[a];if(o){if(o.classList.contains("ae-removed"))o.classList.remove(...l.HIGHLIGHT_CLASSES);else{o.classList.add("ae-removed","ae-removed-nav");const e=Y({target:o,onScreenFactor:1,keepTallElements:!0});oe(o,{...e,scrollTo:!1})||(b=!0,M.refreshTagHighlight(o),await le(o,e)),X(o,"ae-removed-flash")}b||M.refreshTagHighlight(o)}b=!0}),p))})),S.addEventListener("pointerup",w),S.addEventListener("pointerleave",w),S.addEventListener("pointercancel",w),S.addEventListener("change",(e=>{const t=e.target.closest('.ae-html-filter input[type="checkbox"]');if(!t)return;const n=t.dataset.slice;n&&(t.checked?R(n):I(n))})),S.addEventListener("click",(async e=>{if(b)return b=!1,e.preventDefault(),void e.stopPropagation();const t=e.target,n=t.closest("#quick-remove-btn"),a=t.closest("#minimize-details-btn"),o=t.closest(".ae-html-tag"),r=o&&o.closest("#ae-markup-container");if(!(n||a||o||r||0===S.scrollTop)){t.closest("#html-toolbar")&&!t.closest("#html-filter-container,#ae-resize-handle,#minimize-details-btn,.ae-copyable")&&(S.scrollTop=0)}if(o&&r){const t=r._aeElements,n=Number(o.dataset.elIdx),a=t&&t[n];if(a){const e=S.scrollTop;m=a,ne(!0,{retainHtml:!0}),S.scrollTop=e;const t=Y({target:a,onScreenFactor:1,keepTallElements:!0});oe(a,{...t,scrollTo:!1})||await le(a,t),X(a,"ae-removed-flash"),K(a)}return e.preventDefault(),void e.stopPropagation()}if(n)try{const e=L.withAllAttached((()=>k.generateCssSelector(P,{rootNode:h,doc:s.overlay})));if(!e)return void k.showToast("Couldn't generate a selector for this element.");const t=s.shadow?.getElementById("ae-optional-remove-selectors");if(!t)return void k.showToast("Settings textarea not found.");const n=t.value.split("\n").map((e=>e.trim())).filter(Boolean);n.includes(e)||n.unshift(e),t.value=n.join("\n");const a=s.shadow?.querySelector(".ae-advanced-options");if(!a.classList.contains("visible")){const e=s.shadow?.getElementById("options-chevron")?.parentElement;e&&!e.nextSibling?.classList.contains("visible")&&e.click()}t.parentElement.previousElementSibling.scrollIntoView({behavior:"instant",block:"start"}),t.dispatchEvent(new Event("input",{bubbles:!0})),t.focus(),t.setSelectionRange(0,e.length),t.scrollTop=0,k.showToast(`Selector added to extra content cleanup:\n${e}.\nClick "Update Settings" to save, and check extra cleanup to enable.`,4e3)}catch(e){console.error(e),k.showToast("Error adding selector.")}else a?(C=!0,x=!0,S.style.display="none",J()):u(e)})),$=!0}const c=Array.from(U),d=P!==o;if(G&&(r?(G.textContent="Element Details:",G.dataset.state="active"):(G.textContent="Prior Element Details:",G.dataset.state="stale")),!d&&!e)return void(S.style.display="block");d&&(_(),B&&(B._aeElements=null),M.detailsPanelHighlightSync?.clearElements?.()),P=o;const u=o.tagName.toLowerCase(),p=o.id||null,y=Array.from(o.classList||[]).filter((e=>!e.startsWith("ae-removed"))),b=Array.from(o.attributes||[]).filter((e=>"id"!==e.name&&"class"!==e.name&&"style"!==e.name)).map((e=>({name:e.name,value:e.value}))),w="function"==typeof L?.getCategories?L.getCategories(o):[];S.querySelector("#details-panel-tag").innerHTML=u?`<code class="ae-copyable" data-copy="${k.escapeHtml(u)}">${k.escapeHtml(u)}</code>`:"<em>None</em>";S.querySelector("#details-panel-id").innerHTML=p?`<code class="ae-copyable" data-copy="#${k.escapeHtml(CSS.escape(p))}">#${k.escapeHtml(p)}</code>`:"<em>None</em>";S.querySelector("#details-panel-classes").innerHTML=y.length?y.map((e=>`<code class="ae-copyable" data-copy=".${k.escapeHtml(CSS.escape(e))}">.${k.escapeHtml(e)}</code>`)).join(", "):"<em>None</em>";S.querySelector("#details-panel-attrs").innerHTML=b.length?`[${b.map((e=>`<code class="ae-copyable" data-copy="[${k.escapeHtml(CSS.escape(e.name))}=&quot;${k.escapeHtml(CSS.escape(e.value))}&quot;]">${k.escapeHtml(e.name)}="${k.escapeHtml(e.value)}"</code>`)).join("], [")}]`:"<em>None</em>";const O=S.querySelector("#details-panel-categories-label"),q=S.querySelector("#details-panel-categories"),V={selectors_optional:"Settings: Remove more",selectors_always_remove:"Settings: Always Remove Selectors",ads:"Ads",text_filter:"Settings: Always Remove Text (Regex)",images:"Settings: Highlight images for removal"};w.length?(O.classList.remove("invisible"),q.classList.remove("invisible"),q.innerHTML=w.length?w.map((e=>`<code class="ae-copyable" data-copy="${k.escapeHtml(V[e])}">${k.escapeHtml(V[e])}</code>`)).join(", "):"<em>None</em>"):(O.classList.add("invisible"),q.classList.add("invisible")),S.style.display="block";const Z=d||e&&n;c.forEach((e=>{const t=z.get(e);t?.checked&&(R(e,{rebuild:Z}),K(P))})),c.length||j()};M.refreshDetailsPanelAfterDomUpdate=({preserveScroll:e=!0}={})=>{if(!$)return;if(!m&&!P)return;if(_(),B&&(B._aeElements=null),M.detailsPanelHighlightSync?.clearElements?.(),x||"none"===S.style.display)return D=!0,void J();const t=e?S.scrollTop:null;ne(!0),e&&"number"==typeof t&&(S.scrollTop=t)};function ae(e,t,n,a=.5){const o=t.getBoundingClientRect();let r;r=n?n.y:(o.top+o.bottom)/2;let i=null,s=1/0;const l=window.innerHeight,c=window.innerWidth;return e.forEach((function(e){const t=e.getBoundingClientRect();if(t.width>0&&t.height>0&&t.right>0&&t.left<c){const n=Math.max(t.top,0),o=Math.min(t.bottom,l);if(Math.max(0,o-n)>=t.height*a){const n=(t.top+t.bottom)/2,a=Math.abs(r-n);a<s&&(i=e,s=a)}}})),i}function oe(e,t={}){const{onScreenFactor:n=1,horizontalOnScreenFactor:a=null,keepTallElements:o=!1,marginConstraints:r={},scrollContainer:i=window,obstructiveElements:s={},scrollTo:l=!1,scrollBehavior:c="smooth",onScrollAttempt:d=null}=t;if(!e)return!1;const u=Array.isArray(e)?e:[e];if(!u.length)return!1;const h={top:0,right:0,bottom:0,left:0,...r};let p=re(i),m=p.rect,f=!0;for(const e of u){if(!(e instanceof Element)){f=!1;continue}p=re(i),m=p.rect;const t=e.getBoundingClientRect(),r=ie(t,m,h,s,p.element),{effectiveTop:u,effectiveBottom:g,effectiveHeight:y,effectiveLeft:b,effectiveRight:E,effectiveWidth:w}=r;if(y<=0||w<=0){f=!1;continue}const v=Math.min(Math.max(n,0),1),S="number"==typeof a?Math.min(Math.max(a,0),1):null,x=t.height>y,T=t.width>w,C=Math.max(t.top,u),A=Math.min(t.bottom,g),_=Math.max(0,A-C),k=Math.max(t.left,b),N=Math.min(t.right,E),R=Math.max(0,N-k),I=_>=(x?y:t.height)*v||x&&o&&_>0;let L=!0;if(null!==S){L=R>=(T?w:t.width)*S}if(!(I&&L)&&(f=!1,l)){if(se(e,p,r,{behavior:c})){if("function"==typeof d)try{d()}catch(e){}p=re(i),m=p.rect}}}return f}function re(e){if(e===window||e===document||e===document.body||e===document.documentElement){const e=document.scrollingElement||document.documentElement;return{element:window,rect:{top:0,left:0,right:window.innerWidth,bottom:window.innerHeight,width:window.innerWidth,height:window.innerHeight},scrollTop:e.scrollTop,scrollHeight:e.scrollHeight,clientHeight:window.innerHeight,documentElement:e}}const t=e.getBoundingClientRect();return{element:e,rect:t,scrollTop:e.scrollTop,scrollHeight:e.scrollHeight,clientHeight:e.clientHeight,documentElement:null}}function ie(e,t,n,a,o){let r=t.top+(n.top||0),i=t.bottom-(n.bottom||0),s=t.left+(n.left||0),l=t.right-(n.right||0);const c=["top","bottom","left","right"];for(const n of c){const c=(d=a[n])?Array.isArray(d)?d:[d]:[];for(const a of c){if("number"==typeof a){"top"===n&&(r+=a),"bottom"===n&&(i-=a),"left"===n&&(s+=a),"right"===n&&(l-=a);continue}if(!(a instanceof Element))continue;if(a===o)continue;const c=a.getBoundingClientRect(),d=Math.max(0,Math.min(c.bottom,t.bottom)-Math.max(c.top,t.top)),u=Math.max(0,Math.min(c.right,t.right)-Math.max(c.left,t.left));if(d<=0||u<=0)continue;const h=!(c.right<=e.left||c.left>=e.right),p=!(c.bottom<=e.top||c.top>=e.bottom);if("top"===n&&h){r+=Math.max(0,Math.min(c.bottom,t.bottom)-Math.max(c.top,t.top))}else if("bottom"===n&&h){i-=Math.max(0,Math.min(t.bottom,c.bottom)-Math.max(t.top,c.top))}else if("left"===n&&p){s+=Math.max(0,Math.min(c.right,t.right)-Math.max(c.left,t.left))}else if("right"===n&&p){l-=Math.max(0,Math.min(t.right,c.right)-Math.max(t.left,c.left))}}}var d;return{effectiveTop:r,effectiveBottom:i,effectiveHeight:Math.max(0,i-r),effectiveLeft:s,effectiveRight:l,effectiveWidth:Math.max(0,l-s)}}function se(e,t,n,{behavior:a="smooth"}={}){const{element:o}=t;if(!e||!o)return!1;const r=()=>function(e,t,{behavior:n="smooth"}={}){if(!e||!t||!t.element)return!1;const{element:a,rect:o,scrollTop:r,clientHeight:i,scrollHeight:s,documentElement:l}=t,c=e.getBoundingClientRect();if(!c)return!1;const d=Math.max(c.height,0),u=Math.max(i,0),h=d>=u?0:(u-d)/2;let p;if(a===window){l||document.scrollingElement||document.documentElement;p=c.top+r-h;const e=Math.max(0,s-u);return p=Math.min(Math.max(p,0),e),window.scrollTo({top:p,behavior:n}),!0}if(!o)return!1;const m=c.top-o.top;p=r+m-h;const f=Math.max(0,s-u);return p=Math.min(Math.max(p,0),f),a.scrollTo({top:p,behavior:n}),!0}(e,t,{behavior:a}),{effectiveTop:i,effectiveBottom:s,effectiveHeight:l}=n;if(l<=0)return r();const c=e.getBoundingClientRect();if(!c||0===c.height)return r();const d=c.height>=l,u=c.top,h=c.bottom;let p;if(d)if(u<i)p=i;else{if(!(h>s))return!1;p=s-c.height}else{p=i+(l-c.height)/2}if(!Number.isFinite(p))return r();const m=u-p;if(Math.abs(m)<1)return!1;const f=re(o),{scrollTop:g,scrollHeight:y,clientHeight:b,documentElement:E}=f;let w=g+m;const v=Math.max(0,y-b);if(w=Math.min(Math.max(w,0),v),o===window){E||document.scrollingElement||document.documentElement;window.scrollTo({top:w,behavior:a})}else o.scrollTo({top:w,behavior:a});return!0}async function le(e,t={}){const{scrollContainer:n=window,onScreenFactor:a=.5,horizontalOnScreenFactor:o=null,marginConstraints:r={},obstructiveElements:i={},scrollBehavior:s="smooth",waitForScrollEnd:l=!0,scrollEndIdleMs:c=120,scrollTo:d=!0,keepTallElements:u=!1}=t;if(!e)return Promise.resolve(!1);const h=(Array.isArray(e)?e:[e]).filter((e=>e instanceof Element));if(!h.length)return Promise.resolve(!1);let p=!1;const m={onScreenFactor:a,horizontalOnScreenFactor:o,keepTallElements:u,marginConstraints:r,scrollContainer:n,obstructiveElements:i,scrollBehavior:s,onScrollAttempt:()=>{p=!0}};return oe(h,{...m,scrollTo:d})?l&&p?(await de(n,c),!0):Promise.resolve(!0):new Promise((e=>{const t=n===window||n===document||n===document.body||n===document.documentElement?null:n,s=function(e,t,n){const a={top:e.top||0,right:e.right||0,bottom:e.bottom||0,left:e.left||0};function o(e){return e?Array.isArray(e)?e:[e]:[]}const r=o(t.top),i=o(t.bottom),s=o(t.left),l=o(t.right),c=n&&n!==window?n.getBoundingClientRect():{top:0,bottom:window.innerHeight,left:0,right:window.innerWidth};function d(e,t){let n=0;for(const a of e)if("number"==typeof a)n=Math.max(n,a);else if(a instanceof Element){const e=a.getBoundingClientRect();if("top"===t){const t=Math.max(0,Math.min(e.bottom,c.bottom)-Math.max(e.top,c.top));n=Math.max(n,t)}else if("bottom"===t){const t=Math.max(0,Math.min(c.bottom,e.bottom)-Math.max(c.top,e.top));n=Math.max(n,t)}else if("left"===t){const t=Math.max(0,Math.min(e.right,c.right)-Math.max(e.left,c.left));n=Math.max(n,t)}else if("right"===t){const t=Math.max(0,Math.min(c.right,e.right)-Math.max(c.left,e.left));n=Math.max(n,t)}}return n}return{top:a.top+d(r,"top"),bottom:a.bottom+d(i,"bottom"),left:a.left+d(s,"left"),right:a.right+d(l,"right")}}(r,i,t),d=`${-s.top}px ${-s.right}px ${-s.bottom}px ${-s.left}px`;let u=!1;const f=t=>{u||(u=!0,y&&y.disconnect(),e(t))},g=()=>oe(h,{...m,scrollTo:!1})?(l?de(n,c).then((()=>f(!0))):f(!0),!0):!(l||!p)&&(f(!0),!0);let y=null;y=new IntersectionObserver((()=>{u||g()}),{root:t,rootMargin:d,threshold:ce(a,o)}),h.forEach((e=>y.observe(e))),l&&de(n,c).then((()=>{u||g()||f(!!p)}))}))}function ce(e,t=null){const n=e=>Math.min(Math.max(e,0),1),a=n(Number.isFinite(e)?e:0),o="number"==typeof t?n(t):null,r=null===o?a:n(a*o),i=new Set([r]);[-.1,.1].forEach((e=>{const t=r+e;t>0&&t<1&&i.add(t)}));const s=Array.from(i).sort(((e,t)=>e-t));return s.length||s.push(0),s}function de(e,t=120){return new Promise((n=>{let r=null;const i=e===window||e===document||e===document.body||e===document.documentElement?window:e,s={passive:!0},l=()=>{null!==r&&o(r),r=a((()=>{i.removeEventListener("scroll",l,s),n()}),t)};i.addEventListener("scroll",l,s),l()}))}function ue(e,t={}){const{onScreenFactor:n=.5,keepTallElements:a=!1}=t;if(!e)return!1;Array.isArray(e)||(e=[e]);const o=window.innerHeight;return e.every((e=>{if(e instanceof Element){const t=e.getBoundingClientRect(),r=t.height>1*o+n;if(r&&!a)return!1;const i=Math.max(t.top,0),s=Math.min(t.bottom,o),l=Math.max(0,s-i);return l>=t.height*n||l&&r}}))}h.addEventListener("click",(function(e){if("Previewing"==Z.textContent)return e.preventDefault(),void e.stopPropagation();let n=e.target;t||(t=new Set(h.querySelectorAll(".ae-removed")),te());const a={x:e.clientX,y:e.clientY};let o;const r=n.classList.contains("ae-removed");for(;n&&n!==h;){if(n.nodeType===Node.ELEMENT_NODE){if(r&&n.parentElement!==h){let e=ae(n.querySelectorAll(".ae-removed"),n,a);e&&(n=e)}else if(r&&n.parentElement===h)n.classList.remove(...l.HIGHLIGHT_CLASSES);else{let e=n.closest(".ae-removed");o=e&&ue(e.children),e&&(e.children.length||o)&&(n=e)}if(n.children.length>=5&&!ue(n)){e.preventDefault(),e.stopPropagation();break}const i=n.classList.toggle("ae-removed");i?(t.add(n),1==t.size&&te()):(n.classList.remove(...l.HIGHLIGHT_CLASSES),t.delete(n)),M.refreshTagHighlight(n),i?m=n:0==t.size?(m=null,te()):m=null,e.preventDefault(),e.stopPropagation(),m&&x?(P!==m&&(D=!0),J()):ne(),i&&(X(n,"ae-removed-flash"),K(n));break}n=n.parentNode}e.preventDefault(),e.stopPropagation()}),{capture:!0}),s.currentTab="edit";const he=async()=>{try{const e=p(),t=await O.convertToMarkdownTurndown(e);if("undefined"==typeof marked&&await k.loadScript("https://cdnjs.cloudflare.com/ajax/libs/marked/16.3.0/lib/marked.umd.min.js"),"undefined"==typeof marked)throw new Error("Marked.js failed to load.");const n=marked.parse(t);u.innerHTML=n}catch(e){k.handleError(e,"Failed to render Markdown"),u.textContent="Failed to render Markdown"}};M.updateMarkdownView=he;i.addEventListener("click",(()=>{if("edit"===s.currentTab)return;s.currentTab="edit",c.classList.contains("selected")&&d.forEach((e=>e.classList.toggle("selected"))),k.applyStyles(u,{display:"none"}),k.applyStyles(h,{display:"block"});const e="Previewing"===Z.textContent;!m||x||e?m&&x&&T&&!e?T.style.display="block":S.style.display="none":S.style.display="block",te()})),c.addEventListener("click",(async()=>{"markdown"!==s.currentTab&&(s.currentTab="markdown",i.classList.contains("selected")&&d.forEach((e=>e.classList.toggle("selected"))),await he(),k.applyStyles(u,{display:"block"}),k.applyStyles(h,{display:"none"}),S.style.display="none",T&&(T.style.display="none"),te())})),k.applyStyles(h,{display:"block"}),k.applyStyles(u,{display:"none"}),n.appendChild(u),n.appendChild(h);return{previewContainer:n,previewTabs:r,getPreviewTabContents:(e=!0)=>{try{return"markdown"===s.currentTab?e?u.cloneNode(!0):u:p(e)||""}catch(e){return k.handleError(e,"Failed to get current preview content"),document.createElement("div")}},updateContent:(e,t={})=>{const{redraw:n=!0}=t;try{n&&(h.innerHTML="",e&&h.appendChild(e)),"markdown"===s.currentTab&&he()}catch(e){k.handleError(e,"Failed to update content")}},managePreviewButton:te}},createExportButtons(e,t){const n=document.createElement("div");n.className="ae-tools";const a=document.createElement("select");a.id="export-selector",a.innerHTML='<option value="">Export actions</option>';const o=[{label:"⧉ – Copy as Plain Text",handler:async()=>{try{const n=t(),a=O.convertToPlainText(e()),o=(a.includes(n.description)?k.generateMetadataHeaderPlain(n,!0):k.generateMetadataHeaderPlain(n))+a;await k.copyToClipboard(o)}catch(e){console.error("Error copying as plain text:",e),k.showToast("Failed to copy as plain text")}}},{label:"⧉ – Copy as Rich Text",handler:async()=>{try{const n=t(),a=O.generateHtmlDocument(n.title,e(),n),o=document.createElement("div");o.innerHTML=a,o.style.position="absolute",o.style.left="-9999px",o.style.cssText="font-family:'system-ui' !important;",s.shadow.appendChild(o);const r=document.createRange();r.selectNodeContents(o);const i=window.getSelection();if(!i)return o.remove(),void k.showToast("Failed to copy rich text: No selection available.");i.removeAllRanges(),i.addRange(r);try{const e=new Blob([a],{type:"text/html"}),t=new ClipboardItem({"text/html":e});await navigator.clipboard.write([t]),k.showToast("Rich text copied!")}catch(e){o&&o.remove(),console.error("Rich text copy error:",e),k.showToast("Error copying: "+e.message)}i.removeAllRanges(),o.remove()}catch(e){tempContainer&&tempContainer.remove(),console.error("Error copying as rich text:",e),k.showToast("Failed to copy as rich text")}}},{label:"⧉ – Copy as Markdown",handler:async()=>{try{const n=t(),a=await O.convertToMarkdownTurndown(e()),o=(a.includes(n.description)?k.generateMetadataHeaderMarkdown(n,!0):k.generateMetadataHeaderMarkdown(n))+"\n\n"+a;await k.copyToClipboard(o)}catch(e){console.error("Error copying as Markdown:",e),k.showToast("Failed to copy as Markdown")}}},{label:"⧉ – Copy as HTML",handler:async()=>{try{const n=t(),a=O.generateHtmlDocument(n.title,e(),n);await k.copyToClipboard(a)}catch(e){console.error("Error copying as HTML:",e),k.showToast("Failed to copy as HTML")}}},{label:"↓ – Download as TXT",handler:async()=>{try{const n=t(),a=`${k.sanitizeFilename(n.title)}.txt`,o=O.convertToPlainText(e()),r=(o.includes(n.description)?k.generateMetadataHeaderPlain(n,!0):k.generateMetadataHeaderPlain(n))+o;k.downloadFile(a,r,"text/plain")}catch(e){console.error("Error downloading as TXT:",e),k.showToast("Failed to download as TXT")}}},{label:"↓ – Download as MD",handler:async()=>{try{const n=t(),a=`${k.sanitizeFilename(n.title)}.md`,o=await O.convertToMarkdownTurndown(e()),r=(o.includes(n.description)?k.generateMetadataHeaderMarkdown(n,!0):k.generateMetadataHeaderMarkdown(n))+"\n\n"+o;k.downloadFile(a,r,"text/markdown")}catch(e){console.error("Error downloading as MD:",e),k.showToast("Failed to download as MD")}}},{label:"↓ – Download as HTML",handler:async()=>{try{const n=t(),a=`${k.sanitizeFilename(n.title)}.html`,o=O.generateHtmlDocument(n.title,e(),n);k.downloadFile(a,o,"text/html")}catch(e){console.error("Error downloading as HTML:",e),k.showToast("Failed to download as HTML")}}}];o.forEach((e=>{const t=document.createElement("option");t.value=e.label,t.textContent=e.label,a.appendChild(t)})),n.appendChild(a);let r=null,i=null;return a.addEventListener("change",(()=>{const e=a.value;if(e)if(i&&(i.remove(),i=null),r=e,l.IS_SAFARI&&e.includes("Copy"))i=document.createElement("button"),i.id="ae-confirm-copy",i.textContent="Copy",i.className="ae-btn ae-btn-copy",i.addEventListener("click",(async()=>{const e=o.find((e=>e.label===r));e&&await e.handler(),a.value="",i&&i.remove(),i=null,r=null})),n.appendChild(i);else{const t=o.find((t=>t.label===e));t&&t.handler(),a.value="",r=null}})),n},replaceDocumentReliably(e){try{return document.write(e),void document.close()}catch(e){console.warn("document.write() failed:",e)}try{return void this.replaceWithNativeWrite(e)}catch(e){console.warn("this.replaceWithNativeWrite() failed:",e)}const t=(new DOMParser).parseFromString(e,"text/html");Array.from(t.documentElement.attributes).forEach((e=>{document.documentElement.setAttribute(e.name,e.value)})),document.head.replaceWith(document.adoptNode(t.head)),document.body.replaceWith(document.adoptNode(t.body)),document.querySelectorAll("script").forEach((e=>{const t=document.createElement("script");Array.from(e.attributes).forEach((e=>{t.setAttribute(e.name,e.value)})),e.src||(t.textContent=e.textContent),e.replaceWith(t)}))},replaceWithNativeWrite(e){const t=document.createElement("iframe");t.style.display="none",document.body.appendChild(t);const n=t.contentDocument,a=n.write,o=(n.open,n.close);t.remove(),a.call(document,e),o.call(document)},documentWrite(e){try{const t=Object.getPrototypeOf(document),n=t.open||Document.prototype.open,a=t.write||Document.prototype.write,o=t.close||Document.prototype.close;return n.call(document),a.call(document,e),o.call(document),!0}catch(e){return console.error("Native method failed:",e),!1}},createReplacePageButton(e,t,n=!1){const a=document.createElement("button");return a.textContent="Replace Page",a.className="ae-btn ae-btn-replace",a.addEventListener("click",(()=>{try{const a=t(),o=e(!1),r=O.generateHtmlDocument(a.title,o,a);if(this.documentWrite(r),n){const e="string"==typeof n?n:"reader";try{const t=new URL(window.location.href);t.searchParams.set(e,"true"),history.replaceState({processed:!0},a.title,t.toString())}catch(t){const n=window.location.href.split("#")[0]+`#${e}}`;history.replaceState({processed:!0},a.title,n)}}}catch(e){k.handleError(e,"Failed to replace page")}})),a},createSettingsSection(e){const t=document.createElement("div");t.className="ae-settings";const n=document.createElement("button");n.type="button",n.textContent="Advanced",n.className="ae-btn orange";const a=document.createElement("span");a.className="chevron",a.id="options-chevron",n.appendChild(a);const o=document.createElement("div");o.className="ae-advanced-options";const r=document.createElement("div");r.className="ae-tab-container";const i=document.createElement("button");i.textContent="Settings",i.className="ae-tab selected",i.dataset.tab="settings";const c=document.createElement("button");c.textContent="Cloud Sync",c.id="sync-tab",c.className="ae-tab",c.dataset.tab="sync",r.appendChild(i),r.appendChild(c);const d=document.createElement("div");d.id="advanced-settings-content";const u=document.createElement("button");u.textContent="Update Settings",u.className="ae-btn ae-btn-update-settings disabled",u.disabled=!0;const p=document.createElement("button");p.textContent="Cancel",p.className="ae-btn ae-btn-cancel-settings disabled",p.disabled=!0;const f=(e,t,n,a,o)=>{const r=document.createElement("div");r.className="ae-option",r.style.cssText="display: flex;flex-direction: row;align-items: center;";const i=document.createElement("input");i.type=t,i.id=e,"checkbox"===t&&(i.checked=n),r.appendChild(i);const s=document.createElement("label");return s.htmlFor=e,s.textContent=a,r.appendChild(s),i.addEventListener("change",o),r},g=document.createElement("button");g.id="ae-btn-pick-element",g.textContent="Pick Article Element",g.className="ae-btn standard-blue",g.addEventListener("click",(()=>{this.startElementSelectionMode((e=>{const t=k.generateCssSelector(e,{doc:document});if(t){S.customArticleSelector=t,S.extractionMethod=l.EXTRACTION_METHODS.CUSTOM,S.save({sync:!0,updateTimestamp:!0});const e=s.shadow?.getElementById("custom-article-selector-input");e&&(e.value=t),this.finishElementSelectionMode(),D.extractArticle()}else k.showToast("Could not generate a unique selector.",2e3,document.body),this.finishElementSelectionMode()}),(()=>{k.showToast("Element selection cancelled.",2e3,document.body),this.finishElementSelectionMode()}))}));const y=document.createElement("div");y.className="ae-option";const b=document.createElement("label");b.htmlFor="custom-article-selector-input",b.textContent="Custom Article CSS Selector for this site:";const E=document.createElement("input");E.type="text",E.id="custom-article-selector-input",k.applyStyles(E,{width:"100%"}),E.value=S.customArticleSelector||"",y.appendChild(b),y.appendChild(E),d.appendChild(y),d.appendChild(g);const w=f("ae-cleanup-annotations","checkbox",S.cleanupAnnotations,"Remove more",(()=>{S.cleanupAnnotations=s.shadow.getElementById("ae-cleanup-annotations").checked,S.save();const e="selectors_optional";S.cleanupAnnotations&&!S.highlightRemovals?(L.detachCategory(e),L.forEachInCategory(e,(t=>{t?.classList.remove("ae-removed",`ae-removed-${e}`)}))):S.cleanupAnnotations?(L.reattachCategory(e),L.forEachInCategory(e,(t=>{t?.classList.add("ae-removed",`ae-removed-${e}`)}))):(L.reattachCategory(e),L.forEachInCategory(e,(t=>{t?.classList.remove("ae-removed",`ae-removed-${e}`)}))),M.refreshAllTagHighlights(),M.refreshDetailsPanelAfterDomUpdate(),this.managePreviewButton?.(),"markdown"===s.currentTab&&M.updateMarkdownView()})),v=f("ae-highlight-removals","checkbox",S.highlightRemovals,"Show removals",(()=>{S.highlightRemovals=s.shadow.getElementById("ae-highlight-removals").checked,S.save();const e=S.cleanupAnnotations?["selectors_optional","selectors_always_remove","ads","text_filter"]:["selectors_always_remove","ads","text_filter"];S.highlightRemovals?(L.reattachCategory(e),e.forEach((e=>{L.forEachInCategory(e,(t=>{t?.classList?.add("ae-removed",`ae-removed-${e}`)}))}))):(L.detachCategory(e),e.forEach((e=>{L.forEachInCategory(e,(t=>{t?.classList?.remove("ae-removed",`ae-removed-${e}`)}))}))),M.refreshAllTagHighlights(),M.refreshDetailsPanelAfterDomUpdate(),this.managePreviewButton?.()})),x=f("ae-remove-all-images","checkbox",S.removeAllImagesAndCaptions,"Highlight images for removal",(()=>{S.removeAllImagesAndCaptions=s.shadow.getElementById("ae-remove-all-images").checked,S.save();const e=s.shadow.getElementById("edit_view");S.removeAllImagesAndCaptions?(O.cleanContent(e,{execute:{images:!0,sanitize:!1,selectors_always_remove:!1,selectors_optional:!1}}),L.forEachInCategory("images",(e=>{e?.classList?.add("ae-removed","ae-removed-images")}))):L.forEachInCategory("images",(e=>{e?.classList?.remove("ae-removed","ae-removed-images")})),M.refreshAllTagHighlights(),M.refreshDetailsPanelAfterDomUpdate(),this.managePreviewButton?.(),"markdown"===s.currentTab&&M.updateMarkdownView()})),T=document.createElement("div");T.className="ae-option";const C=document.createElement("label");C.htmlFor="ae-always-remove-selectors",C.textContent="Always remove these selectors (one per line):";const _=document.createElement("textarea");_.id="ae-always-remove-selectors",_.value=(S.alwaysRemoveSelectors||[]).join("\n"),T.appendChild(C),T.appendChild(_);const N=document.createElement("div");N.className="ae-option";const R=document.createElement("label");R.id="ae-optional-remove-selectors-label",R.htmlFor="ae-optional-remove-selectors",R.textContent="Remove these selectors when 'Remove more' is enabled (one per line):";const I=document.createElement("textarea");I.id="ae-optional-remove-selectors",I.value=(S.optionalRemoveSelectors||[]).join("\n"),N.appendChild(R),N.appendChild(I);const P=document.createElement("div");P.className="ae-option";const $=document.createElement("label");$.htmlFor="ae-text-removal",$.textContent="Always Remove Text (regex, one per line):";const H=document.createElement("textarea");H.id="ae-text-removal",H.value=(S.textRemovalRules||[]).join("\n"),P.appendChild($),P.appendChild(H);let F={customSelector:(E.value||"").trim(),alwaysRemove:_.value||"",optionalRemove:I.value||"",textRemoval:H.value||""},z=!1;function U(e){return new Set(String(e).split(/\r?\n/).map((e=>e.trim())).filter(Boolean))}function B(e,t){const n=U(e),a=U(t);if(n.size!==a.size)return!1;for(const e of n)if(!a.has(e))return!1;return!0}const j=(e=!1,t=!1)=>{const n=E.value.trim()!==F.customSelector,a=_.value!==F.alwaysRemove||t&&!B(_.value,F.alwaysRemove),o=I.value!==F.optionalRemove||t&&!B(I.value,F.optionalRemove),r=H.value!==F.textRemoval||t&&!B(H.value,F.textRemoval),i=n||a||o||r;if(u.disabled=!i,p.disabled=!i,u.classList.toggle("disabled",!i),p.classList.toggle("disabled",!i),e)return{selectorChanged:n,textChanged:r,alwaysChanged:a,optionalChanged:o}},G=h(j,300),W=()=>{z||(k.showToast("Save changes by pressing 'Update Settings' below."),u.disabled=!1,p.disabled=!1,u.classList.remove("disabled"),p.classList.remove("disabled"),z=!0),G()};[E,_,I,H].forEach((e=>e.addEventListener("input",W)));const q=document.createElement("button");function V(e){return"selectors_optional"===e?S.cleanupAnnotations?S.highlightRemovals?"highlight":"detach":"none":S.highlightRemovals?"highlight":"detach"}function Y(e,t,n){const a=t.join(",");L.forEachInCategory(e,(t=>{t.classList.remove("ae-removed",`ae-removed-${e}`),L.untag(t,e)})),"none"!==n&&a?(L.withAllAttached((()=>{const t=s.shadow.getElementById("edit_view");Array.from(t.querySelectorAll(a)).forEach((t=>{L.tag(t,e),"highlight"===n&&t.classList.add("ae-removed",`ae-removed-${e}`)}))})),"detach"===n&&L.detachCategory(e),M.refreshAllTagHighlights(),M.refreshDetailsPanelAfterDomUpdate()):M.refreshAllTagHighlights()}q.textContent="Add Defaults",q.className="ae-btn ae-btn-add-defaults",q.addEventListener("click",(()=>{const e=new Set(_.value.split("\n").map((e=>e.trim())).filter(Boolean));l.ALWAYS_REMOVE_DEFAULTS.forEach((t=>e.add(t))),_.value=[...e].join("\n");const t=new Set(I.value.split("\n").map((e=>e.trim())).filter(Boolean));l.OPTIONAL_REMOVE_DEFAULTS.forEach((e=>t.add(e))),I.value=[...t].join("\n"),_.dispatchEvent(new Event("input",{bubbles:!0})),k.showToast("Defaults added. Click 'Update' to save.")})),p.addEventListener("click",(()=>{E.value=F.customSelector,_.value=F.alwaysRemove,I.value=F.optionalRemove,H.value=F.textRemoval,j(),z=!1})),u.addEventListener("click",(()=>{const e=j(!0,!0),t=[...U(_.value)],n=[...U(I.value)],a=[...U(H.value)];if(S.customArticleSelector=(E.value||"").trim(),S.customArticleSelector&&e.selectorChanged&&(S.extractionMethod=l.EXTRACTION_METHODS.CUSTOM),S.alwaysRemoveSelectors=t,_.value=t.join("\n"),S.optionalRemoveSelectors=n,I.value=n.join("\n"),S.textRemovalRules=a,H.value=a.join("\n"),S.save({sync:!0,updateTimestamp:!0}),e.selectorChanged||e.textChanged)if(e.selectorChanged)D.extractArticle({sync:!1});else{const e=s.shadow.getElementById("edit_view"),t="text_filter";L.forEachInCategory(t,(e=>{e.classList.remove("ae-removed",`ae-removed-${t}`),L.untag(e,t)})),O.applyTextFiltering(e.firstChild,{restoreRemoved:!0}),M.refreshDetailsPanelAfterDomUpdate(),k.showToast("Text removal rules updated & preview updated.")}else(e.alwaysChanged||e.optionalChanged)&&(e.alwaysChanged&&Y("selectors_always_remove",t,V("selectors_always_remove")),e.optionalChanged&&Y("selectors_optional",n,V("selectors_optional")));Object.values(e).some(Boolean)&&(k.showToast("Settings updated & preview updated."),F={customSelector:(E.value||"").trim(),alwaysRemove:_.value,optionalRemove:I.value,textRemoval:H.value},j(),z=!1,"markdown"===s.currentTab&&M.updateMarkdownView()),M.refreshAllTagHighlights(),M.refreshDetailsPanelAfterDomUpdate(),this.managePreviewButton?.()})),d.appendChild(document.createElement("HR")),d.appendChild(P),d.appendChild(T),d.appendChild(N);const X=document.createElement("div");X.style.cssText="display: flex; flex-direction: row; column-gap: 10px; flex-wrap: wrap; justify-content: space-between;",d.appendChild(X),X.appendChild(w),X.appendChild(x),X.appendChild(v),X.appendChild(q),d.appendChild(document.createElement("HR"));const K=document.createElement("div");K.style.cssText="display: flex; gap: 10px;",K.appendChild(u),K.appendChild(p),d.appendChild(K);const J=document.createElement("div");J.id="sync-tab-container",J.className="sync-tab-container",J.style.display="none";const Z=f("sync-enabled-toggle","checkbox",S.syncEnabled,"Enable Google Drive Sync for this site",(e=>{e.target.checked?(S.syncEnabled=!0,S.save({updateTimestamp:!1}),ne(!0),A.init()):confirm("Disabling sync for this site will stop it from updating from the cloud. Other connection details will be kept. Are you sure?")?(S.syncEnabled=!1,S.save(),ne(!1),A.cleanup()):e.target.checked=!0})),Q=document.createElement("div");Q.id="sync-controls-container",Q.className="sync-controls-container";const ee=document.createElement("div");ee.id="sync-conflict-resolver",ee.className="sync-conflict-resolver";const te=document.createElement("div");te.className="import-export-container invisible",te.id="import-export-container",J.appendChild(Z),J.appendChild(Q),J.appendChild(ee),J.appendChild(te);const ne=e=>{if(Q.innerHTML="",te.innerHTML="",e){const e=document.createElement("div");e.id="sync-status";const t=document.createElement("button");t.id="sync-connect-btn",t.textContent="Connect to Google Drive",t.className="invisible ae-btn ae-btn-primary",t.addEventListener("click",(()=>A.handleAuthClick()));const n=document.createElement("button");n.textContent="Disconnect",n.id="sync-disconnect-btn",n.className="invisible ae-btn ae-btn-close",n.addEventListener("click",(async()=>{confirm("This will clear authorization from this browser and remove this site's settings from the cloud. Are you sure?")&&await A.handleDisconnectClick(!1)})),Q.appendChild(e),Q.appendChild(t),Q.appendChild(n);const a=document.createElement("button");a.textContent="Download Cloud Settings",a.className="ae-btn standard-blue",a.onclick=async()=>{try{k.showToast("Fetching from Google Drive...");const e=await A.findOrCreateFile(),t=await A.readFile(e,!0),n=k.formatReadableDate((new Date).toISOString(),{sortable:!0});k.downloadFile(n+"_ae-cloud-backup.json",JSON.stringify(t,null,2),"application/json")}catch(e){k.handleError(e,"Failed to download settings.")}};const o=document.createElement("button");o.textContent="Upload Settings to Cloud",o.className="ae-btn standard-blue",o.onclick=()=>{const e=document.createElement("input");e.type="file",e.accept=".json,application/json",e.onchange=e=>{const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onerror=()=>{k.showToast("Error: Could not read the selected file.",4e3),m.error("FileReader error",n.error)},n.onload=e=>{const t=e.target.result;t?confirm("This will overwrite ALL your settings in the cloud with the contents of this file. The new settings will then be applied to the current page. This action cannot be undone.\n\nAre you sure you want to proceed?")&&A.uploadGlobalSettingsAndReload(t):k.showToast("Error: The selected file is empty.",4e3)},n.readAsText(t)},e.click()},te.appendChild(a),te.appendChild(o),te.classList.remove("invisible"),A.updateSyncStatus()}else te.classList.add("invisible")};ne(S.syncEnabled),o.appendChild(r),o.appendChild(d),o.appendChild(J),[i,c].forEach((e=>{e.addEventListener("click",(()=>{i.classList.remove("selected"),c.classList.remove("selected"),e.classList.add("selected"),d.style.display="settings"===e.dataset.tab?"block":"none",J.style.display="sync"===e.dataset.tab?"block":"none"}))})),n.addEventListener("click",(()=>{e.querySelector(".ae-readability-options")?.classList.remove("visible"),e.querySelector("#readability-chevron")?.classList.remove("visible"),a.classList.toggle("visible"),o.classList.toggle("visible")})),t.appendChild(o);const ae=document.createElement("div");ae.className="ae-option ae-method-selector";const oe=document.createElement("select");oe.id="ae-method",oe.className="ae-tools";return[{value:l.EXTRACTION_METHODS.READABILITY,name:"Readability.js"},{value:l.EXTRACTION_METHODS.CUSTOM,name:"Custom Engine"}].forEach((e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.name,S.extractionMethod===e.value&&(t.selected=!0),oe.appendChild(t)})),oe.addEventListener("change",(()=>{S.extractionMethod=oe.value,S.save(),L.resetElementCache(),D.extractArticle()})),ae.appendChild(oe),{settingsContainer:t,methodOption:ae,advancedHeader:n}},createReadabilitySection(e){const t=s.readabilityPrefs;function n(){const e={atkinson:'"Atkinson Hyperlegible Next", sans-serif',roboto:"Roboto, sans-serif","noto-sans":'"Noto Sans", sans-serif',literata:"Literata, serif",inter:"Inter, sans-serif"}[t.fontFamily]||"system-ui, sans-serif",n=["roboto","noto-sans","inter","system-ui","atkinson"].includes(t.fontFamily)?`"wdth" ${t.fontWidth}`:"",a=`#preview-contents-container p, #preview-contents-container :has(> div:nth-of-type(${l.MIN_PARAGRAPHS_STEP1_CANDIDATE})) div`,o=`\n#preview-contents-container {\nfont-size: ${t.fontSize}px;\nfont-family: ${e};\n${n?`font-variation-settings: ${n};`:""}\nmax-width: ${t.lineWidth}px;\nmargin-left: auto;\nmargin-right: auto;\nline-height: ${t.lineHeight};\nfont-weight: ${t.fontWeight};\ntext-align: ${t.textAlign};\n}\n${a} {\nmargin-bottom: ${t.paragraphSpacing}px !important;\n}\n#ae-overlay {\nmax-width: ${t.overlayWidth}%\n}\n`,r=new CSSStyleSheet;r.replaceSync(o),s.shadow.adoptedStyleSheets.push(r)}k.ensureFontLink(t.fontFamily);const a=document.createElement("button");a.type="button",a.textContent="Readability",a.className="ae-btn ae-btn-readability";const o=document.createElement("span");o.id="readability-chevron",o.className="chevron",a.appendChild(o);const r=document.createElement("div");function i(e,t,a,o,r,i,s,l){const c=document.createElement("div");c.className=`ae-option readability-option ${e}`;const d=document.createElement("label");d.htmlFor=e,d.textContent=`${t}: ${i}${s}`;const u=document.createElement("input");return u.type="range",u.id=e,u.min=a,u.max=o,u.step=r,u.value=i,u.addEventListener("input",(()=>{const e=u.value;d.textContent=`${t}: ${e}${s}`,l(e),n()})),c.appendChild(d),c.appendChild(u),c}r.className="ae-readability-options",r.className="ae-readability-options";{const e=document.createElement("div");e.className="ae-option";const a=document.createElement("label");a.htmlFor="readability-font-family",a.textContent="Font family:";const o=document.createElement("select");o.id="readability-font-family";[{value:"system-ui",label:"System Font"},{value:"atkinson",label:"Atkinson Hyperlegible Next"},{value:"literata",label:"Literata"},{value:"noto-sans",label:"Noto Sans"},{value:"roboto",label:"Roboto"},{value:"inter",label:"Inter"}].forEach((e=>{const n=document.createElement("option");n.value=e.value,n.textContent=e.label,t.fontFamily===e.value&&(n.selected=!0),o.appendChild(n)})),o.addEventListener("change",(()=>{t.fontFamily=o.value,t.save(),k.ensureFontLink(t.fontFamily),n()})),e.appendChild(a),e.appendChild(o),r.appendChild(e)}r.appendChild(i("readability-font-size","Font size",12,36,1,t.fontSize,"px",(e=>{t.fontSize=parseInt(e,10),t.save()}))),r.appendChild(i("readability-line-height","Line spacing",1,2,.1,t.lineHeight,"",(e=>{t.lineHeight=parseFloat(e),t.save()}))),r.appendChild(i("readability-paragraph-spacing","Paragraph spacing",0,50,2,t.paragraphSpacing,"px",(e=>{t.paragraphSpacing=parseInt(e,10),t.save()}))),r.appendChild(i("readability-font-weight","Font weight",100,900,100,t.fontWeight,"",(e=>{t.fontWeight=parseInt(e,10),t.save()}))),r.appendChild(i("readability-font-width","Font width",50,200,1,t.fontWidth,"",(e=>{t.fontWidth=parseInt(e,10),t.save()}))),r.appendChild(i("readability-line-width","Line width",400,1200,50,t.lineWidth,"px",(e=>{t.lineWidth=parseInt(e,10),t.save()})));{const e=document.createElement("div");e.className="ae-option";const a=document.createElement("label");a.htmlFor="readability-text-align",a.textContent="Text alignment:";const o=document.createElement("select");o.id="readability-text-align";["left","center","right","justify"].forEach((e=>{const n=document.createElement("option");n.value=e,n.textContent=e.charAt(0).toUpperCase()+e.slice(1),t.textAlign===e&&(n.selected=!0),o.appendChild(n)})),o.addEventListener("change",(()=>{t.textAlign=o.value,t.save(),n()})),e.appendChild(a),e.appendChild(o),r.appendChild(e)}return r.appendChild(i("readability-overlay-width","Overlay width",50,100,5,t.overlayWidth,"%",(e=>{t.overlayWidth=parseInt(e,10),t.save()}))),k.applyStyles(r,{width:"100%"}),a.addEventListener("click",(()=>{e.querySelector(".ae-advanced-options")?.classList.remove("visible"),e.querySelector("#options-chevron")?.classList.remove("visible"),o.classList.toggle("visible"),r.classList.toggle("visible")})),n(),{readabilityHeader:a,readabilityOptions:r,applyReadability:n}},_createConfirmationBar(){const e=this._elementPickerState;e.confirmationBar&&e.confirmationBar.remove(),e.confirmationBar=document.createElement("div"),e.confirmationBar.id="ae-selection-bar";const t=document.createElement("span");t.id="ae-selection-status";const n=document.createElement("div");n.className="buttons-group";const a=document.createElement("button");a.textContent="Accept",a.className="accept-btn",a.onclick=()=>{e.provisionallySelectedElement&&e.onElementAccepted&&e.onElementAccepted(e.provisionallySelectedElement)};const o=document.createElement("button");o.textContent="Cancel",o.className="cancel-btn",o.onclick=()=>{e.onPickerCancelled&&e.onPickerCancelled()},n.appendChild(a),n.appendChild(o),e.confirmationBar.appendChild(t),e.confirmationBar.appendChild(n),document.body.appendChild(e.confirmationBar)},_removeConfirmationBar(){const e=this._elementPickerState;e.confirmationBar&&(e.confirmationBar.remove(),e.confirmationBar=null)},_updateConfirmationBarText(e){const t=this._elementPickerState;if(t.confirmationBar){const n=t.confirmationBar.querySelector("#ae-selection-status");n&&(n.textContent=e)}},_handleElementSelectionClick(e){const t=this._elementPickerState,n=document.body.querySelectorAll(".ae-toast");if(!t.isActive||t.confirmationBar&&t.confirmationBar.contains(e.target)||n&&Array.from(n).some((t=>t.contains(e.target))))return;e.preventDefault(),e.stopPropagation();const a=e.target;if(a===document.body||a===document.documentElement)return;const o=t.provisionallySelectedElement;if(o&&(o.classList.remove("ae-select-highlight"),t.provisionallySelectedElement=null),o===a)return void this._updateConfirmationBarText("Click an element to select it, or press Esc to cancel.");t.provisionallySelectedElement=a,a.classList.add("ae-select-highlight");const r=function(e,t,n="class"){const a=new RegExp(`(\\s)${n}=(["'])(.*?)\\2`),o=new Set(Array.isArray(t)?t:[t]);return e.replace(a,((e,t,a,r)=>{const i=r.split(/\s+/).filter((e=>!o.has(e)));return i.length?`${t}${n}=${a}${i.join(" ")}${a}`:""}))}(k.prettyPrintElement(a).substring(0,100),"ae-select-highlight");this._updateConfirmationBarText(`Selected: ${r}?`)},_handlePickerKeyDown(e){const t=this._elementPickerState;t.isActive&&"Escape"===e.key&&(e.preventDefault(),e.stopPropagation(),t.onPickerCancelled&&t.onPickerCancelled())},startElementSelectionMode(e,t){if(this._elementPickerState.isActive||!this.overlayHost)return void console.warn("Element selection mode cannot be started or is already active.");const n=this._elementPickerState;n.isActive=!0,n.onElementAccepted=e,n.onPickerCancelled=t,n.provisionallySelectedElement=null,n.originalOverlayDisplay=this.overlayHost.style.display,this.overlayHost.style.display="none",n.originalOverlayDisplayDiv=this.overlay.style.display,this.overlay.style.display="none",k.makeInert(!1);const a=s.shadow,o=a.querySelector("#ae-backdrop");o?(n.originalBackdropDisplay=o.style.display,o.style.display="none"):n.originalBackdropDisplay="none";const r=a.querySelector("#ae-details-panel");M.detailsPanel=r,r&&(n.originalDetailsPanel=r.style.display,"block"==n.originalDetailsPanel&&(r.style.display="none"));const i=a.querySelector(".ae-restore-btn");i?.classList.toggle("invisible");const l=document.querySelector("#ae-button");l&&(l.style.display="none"),n.originalBodyPointerEvents=document.body.style.pointerEvents,document.body.style.pointerEvents="auto",document.body.classList.remove("modal-open"),document.body.classList.add("selection-open"),this._createConfirmationBar(),this._updateConfirmationBarText("Click an element to select it, or press Esc to cancel."),n.eventListeners.click=this._handleElementSelectionClick.bind(this),n.eventListeners.keydown=this._handlePickerKeyDown.bind(this),document.documentElement.addEventListener("click",n.eventListeners.click,!0),document.addEventListener("keydown",n.eventListeners.keydown,!0),k.showToast("Element selection mode active. Click an element to select/deselect. Use Accept or Cancel/Esc.",3e3,document.body)},finishElementSelectionMode(){if(!this._elementPickerState.isActive)return;const e=this._elementPickerState;document.documentElement.removeEventListener("click",e.eventListeners.click,!0),document.removeEventListener("keydown",e.eventListeners.keydown,!0),e.eventListeners={click:null,keydown:null},this._removeConfirmationBar(),e.provisionallySelectedElement&&e.provisionallySelectedElement.classList.remove("ae-select-highlight"),this.overlayHost&&(this.overlay.style.display=e.originalOverlayDisplayDiv||"block",this.overlayHost.style.display=e.originalOverlayDisplay||"block");const t=s.shadow;if(t&&void 0!==e.originalBackdropDisplay){const n=t.querySelector("#ae-backdrop");n&&(n.style.display=e.originalBackdropDisplay||"")}if("block"==e.originalDetailsPanel){const e=t.querySelector("#ae-details-panel");e&&(e.style.display="block")}const n=t.querySelector(".ae-restore-btn");n?.classList.toggle("invisible");const a=document.querySelector("#ae-button");a&&(a.style.display="block"),document.body.style.pointerEvents=e.originalBodyPointerEvents,document.body.classList.remove("selection-open"),document.body.classList.add("modal-open"),e.isActive=!1,e.provisionallySelectedElement=null,e.onElementAccepted=null,e.onPickerCancelled=null,e.originalOverlayDisplay="",e.originalBackdropDisplay="",e.originalDetailsPanel=""}},D={async extractArticle(e={}){const{sync:t=!0}=e;M.overlayHost?(M.overlayHost.remove(),M.overlayHost=null):document.getElementById("ae-host")?.remove(),document.body.classList.add("modal-open"),s.listeners.currentEscapeHandler&&(document.removeEventListener("keydown",s.listeners.currentEscapeHandler),s.listeners.currentEscapeHandler=null),s.shadow=null,M.createOverlay();try{if(S.extractionMethod===l.EXTRACTION_METHODS.READABILITY)try{await this.extractWithReadability()}catch(e){S.extractionMethod=l.EXTRACTION_METHODS.CUSTOM,S.save({updateTimestamp:!1}),k.handleError(e,"Readability failed, trying custom algorithm..."),await this.extractWithCustomAlgorithm()}else try{await this.extractWithCustomAlgorithm()}catch(e){k.showToast("Could not find article automatically. Please select it.",3e3,document.body);const t=document.getElementById("ae-button");t&&(t.style.display="none"),M.startElementSelectionMode((e=>{const n=k.generateCssSelector(e,{doc:document});n?(S.customArticleSelector=n,S.extractionMethod=l.EXTRACTION_METHODS.CUSTOM,S.save({updateTimestamp:!0}),M.finishElementSelectionMode(),D.extractArticle({sync:!1}),M.finishElementSelectionMode(),D.extractArticle({sync:!1}),S.syncEnabled&&(A.isInitialized&&A.cleanup(),A.init())):(k.showToast("Could not generate a unique selector for the chosen element.",2e3,document.body),M.finishElementSelectionMode(),M.overlayHost&&(M.overlayHost.remove(),M.overlayHost=null),document.body.classList.remove("modal-open"),t&&(t.style.display="block"))}),(()=>{k.showToast("Element selection cancelled.",2e3,document.body),M.finishElementSelectionMode(),M.overlayHost&&(M.overlayHost.remove(),M.overlayHost=null),document.body.classList.remove("modal-open"),t&&(t.style.display="block")}))}}catch(e){document.body.classList.remove("modal-open"),k.makeInert(!1),k.handleError(e,"Failed to display extracted content")}try{S.syncEnabled&&t&&(A.isInitialized&&A.cleanup(),A.init())}catch(e){k.handleError(e,"Failed sync after extracting article, disabling sync."),S.syncEnabled=!1,S.save()}},async extractWithReadability(e={}){const{useDOMPurify:t=!1}=e;try{const e=document.cloneNode(!0);if("undefined"==typeof Readability&&await k.loadScript("https://cdnjs.cloudflare.com/ajax/libs/readability/0.6.0/Readability.min.js"),"undefined"==typeof Readability)throw new Error("Readability.js script failed to load or define Readability global.");const n=new Readability(e,{keepClasses:!0,serializer:e=>e}).parse();if(!n||!n.content)throw new Error("Readability extraction failed to produce content");let a;_.readabilityContent=n.content.cloneNode(!0),t&&"function"==typeof DOMPurify.sanitize&&(a=DOMPurify.sanitize(n.content.cloneNode(!0),{IN_PLACE:!0})),a=O.cleanContentAndFilter(_.readabilityContent);const o={...this.extractMetadata()};n.title&&(o.title=n.title),n.publishedTime&&(o.date=n.publishedTime),n.siteName&&(o.siteName=n.siteName),n.excerpt&&(o.description||(o.description=n.excerpt));const r=k.parseAuthors(n.byline);r.authors.length>0&&(o.authors=r.authors.map((e=>({name:e})))),_.metadata=o,this.displayExtractedContent(a,o)}catch(e){throw console.error("Error in readability extraction:",e),e}},async extractWithCustomAlgorithm(e={}){const{useDOMPurify:t=!1}=e;try{const e=S.customArticleSelector,n=this.findArticle(e);if(!n)throw new Error("Custom extraction failed to produce content");const a=n.cloneNode(!0);let o;s.articleElement=n,o=t&&"function"==typeof DOMPurify.sanitize?DOMPurify.sanitize(n.cloneNode(!0),{IN_PLACE:!0}):a,o=O.cleanContentAndFilter(o);const r=this.extractMetadata();_.metadata=r,this.displayExtractedContent(o,r)}catch(e){throw e}},findArticle(t){_.findArticleCache||(_.findArticleCache=new WeakMap);const n=_.findArticleCache;function a(e,t,a){if(!e||"string"!=typeof t)return;const o=n.get(e);if(o&&o.has(t))return o.get(t);if("function"!=typeof a)return;const r=a();return function(e,t,a){if(!e||"string"!=typeof t)return;n.has(e)||n.set(e,new Map);n.get(e).set(t,a)}(e,t,r),r}function o(e){return a(e,"normalizedText",(()=>a(e,"textContent",(()=>(e.textContent||"").trim())).replace(/\s+/g," ").replace(/\s*([.!?])\s*/g,"$1 ").trim()))}function r(e){return a(e,"paragraphsCount",(()=>e.getElementsByTagName("p").length))}function i(e){return l.BLOCK_LEVEL_TAGS.has(e.toUpperCase())}function s(e){return a(e,"isUnlikely",(()=>{const t=`${e.className} ${e.id}`;return l.REGEXPS.unlikelyCandidates.test(t)||l.REGEXPS.negative.test(t)&&!l.REGEXPS.positive.test(t)}))}function c(e){return a(e,"classWeight",(()=>{const t=`${e.className} ${e.id}`;let n=0;const a={negative:l.REGEXPS.negative,unlikelyCandidates:l.REGEXPS.unlikelyCandidates,okMaybeItsACandidate:l.REGEXPS.okMaybeItsACandidate,positive:l.REGEXPS.positive,byline:l.REGEXPS.byline};for(const[e,o]of Object.entries(a))if(o&&o.test(t)){const t=e.toUpperCase().replace(/([A-Z])/g,"_$1").replace(/^_/,"");n+=l.CLASS_WEIGHT_SCORES[t]||0}return n}))}function d(e){return a(e,"linkDensity",(()=>{const t=o(e).length;if(0===t)return 0;return a(e,"linkLength",(()=>Array.from(e.getElementsByTagName("a")).reduce(((e,t)=>e+o(t).length),0)))/t}))}function u(e){return(e.match(l.REGEXPS.commas)||[]).length}function h(e,t){const n=(void 0!==t?t:o(e)).length,r=a(i=e,"innerHTMLLength",(()=>i.innerHTML?i.innerHTML.length:0))||1;var i;return 0===n||0===r?0:n/r*(l.TEXT_TO_HTML_SCORE_FACTOR||10)}function p(e,t=!1){return-d(e)*(t?l.CONTENT_NODE_LINK_DENSITY_PENALTY_FACTOR||50:l.LINK_DENSITY_PENALTY_FACTOR||25)}function m(e){const t=o(e),n=t.length,a=d(e),r=l.MIN_CONTENT_NODE_TEXT_LENGTH||25,i=l.CONTENT_NODE_LINK_DENSITY_THRESHOLD||.5;if(n<r||a>i)return{element:e,score:0,textLength:n,linkDensityVal:a};let s=1;s+=Math.min(Math.sqrt(n),20),s+=c(e),s+=u(t);const h=(t.match(/[,;:.!?]/g)||[]).length;s+=Math.min(.5*h,10);const m=t.split(/[.!?]+/).filter((e=>e.trim().length>10));return s+=Math.min(2*m.length,20),s+=p(e,!0),{element:e,score:Math.max(0,s),textLength:n,linkDensityVal:a}}function f(e,t,n,a){const i=void 0!==n?n:o(e),s=void 0!==a?a:r(e);let d=t+c(e);return d+=Math.min(l.PARAGRAPH_SCORE_CAP||50,s*(l.PARAGRAPH_SCORE_FACTOR||5)),d+=u(i),d+=h(e,i),d+=p(e),d+=Math.min(.5*(i.match(/[,;:.!?]/g)||[]).length,10),{element:e,score:d,textLength:i.length,paragraphs:s}}if(t&&"string"==typeof t&&""!==t.trim()){e;try{const e=document.querySelector(t);if(e)return e;{const e=`Custom selector "${t}" found no element. Proceeding with heuristic search.`;k.handleError(new Error(e),e)}}catch(n){const a=`Invalid custom selector "${t}": ${n.message}`;e,k.showToast(a,2e3,document.body)}}const{step1Candidates:g,finalCandidateElement:y}=function(){try{const t=[{selector:`:is([class*="content" i],[class*="text" i]:is([class*="main" i],[class*="content" i],[class*="body" i],[class*="container" i],[class*="wrapper" i]),[class*="post" i],[class*="story" i],[class*="entry" i],[class*="article" i],[id*="article" i],[id*="post" i],[id*="content" i],[id*="story" i],[id*="entry" i]):is(article, section, div):has(:is(p,[class*=paragraph]):nth-of-type(${l.MIN_PARAGRAPHS_STEP1_CANDIDATE})):not(:is([class*="list" i]),[class*="sidebar" i]):not(:has(article,main,h1,time,footer,[class*="comment" i],[class*="byline" i],[class*="read" i]:is([class*="related" i],[class*="most" i],[class*="next" i],[class*="more" i])))`,weight:10}],n=[],a=new Set,i=l.MIN_TEXT_LENGTH_STEP1_CANDIDATE||200,c=l.MIN_PARAGRAPHS_STEP1_CANDIDATE||3;for(const{selector:l,weight:d}of t)try{const e=document.querySelectorAll(l);for(const t of e){if(a.has(t)||s(t))continue;if(!t.offsetParent&&t!==document.body)continue;const e=o(t),l=r(t);e.length<i||l<c||(n.push(f(t,d,e,l)),a.add(t))}}catch(t){e,k.handleError(t,`CSS selector error for "${l}"`)}n.sort(((e,t)=>t.score-e.score));const d=l.STEP1_EARLY_RETURN_SCORE||250,u=n.length>0&&n[0].score>d?n[0].element:null;return{step1Candidates:n,finalCandidateElement:u}}catch(e){return k.handleError(e,"Failed in Step 1"),{step1Candidates:[],finalCandidateElement:null}}}();if(y)return y;let b=null,E=-1/0;function w(e,t="Unknown"){if(!e)return void 0;const n=function(e){const t=[];if(!e)return t;const n=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,null,!1);let a;for(;a=n.nextNode();){const e=a.tagName.toUpperCase(),n=o(a),r=l.MIN_CONTENT_NODE_TEXT_LENGTH||25;if("P"!==e)if("DIV"===e){let e=!1;for(const t of a.children)if(i(t.tagName)){e=!0;break}if(!e&&n.length>=r){t.push(a);continue}if(1===a.children.length&&"P"===a.children[0].tagName.toUpperCase()){const e=l.DIV_TO_P_LINK_DENSITY_THRESHOLD||.3;if(d(a)<e){o(a.children[0]).length>=r&&t.push(a.children[0]);continue}}}else if(["BLOCKQUOTE","PRE"].includes(e))n.length>=r&&t.push(a);else if("LI"===e){if(n.length>=2*r&&d(a)<.5){const e=a.parentElement;e&&["UL","OL"].includes(e.tagName)&&(s(e)||t.push(a))}}else if(["TD","TH"].includes(e))n.length>=3*r&&d(a)<.3&&t.push(a);else for(const e of a.children)i(e.tagName.toUpperCase())&&n.length-o(e).length>=r&&d(a)<.2&&!s(e)&&t.push(e);else n.length>=r&&t.push(a)}return[...new Set(t)]}(e);if(0===n.length)return void 0;const a=function(e,t){const n=new Map,a=l.ANCESTOR_SCORE_DECAY_DIVISOR_OFFSET||1;for(const r of e){if(r.score<=0)continue;let e=r.element.parentElement,i=0;for(;e&&e!==t.parentElement&&e!==document.documentElement;){n.has(e)||n.set(e,{accumulatedScore:0,contentNodeCount:0,linkDensityVal:d(e),classWeight:c(e),textLength:o(e).length});const s=n.get(e);if(s.accumulatedScore+=r.score/(i+a),s.contentNodeCount++,e===t)break;e=e.parentElement,i++}}return n}(n.map(m),e);if(0===a.size)return void 0;const{bestContainer:r,bestScore:u}=function(e){let t=null,n=-1/0;const a=l.MIN_CONTENT_NODES_FOR_BEST_CONTAINER||3,o=l.BEST_CONTAINER_LINK_DENSITY_THRESHOLD||.4;for(const[r,i]of e.entries()){if(i.contentNodeCount<a||i.linkDensityVal>o)continue;let c=i.accumulatedScore;const d=r.parentElement;let u=null;if(d&&(u=e.get(d)),u){if(i.contentNodeCount<u.contentNodeCount*l.DESCEND_TO_REFINE_CONTENT_NODE_THRESHOLD)continue;const e=l.LINK_DENSITY_DIFF_MULTIPLIER||10;c+=(u.linkDensityVal-i.linkDensityVal)*e}d&&(c+=2*(h(r)-h(d))),c+=i.classWeight,s(r)&&(c*=l.IS_UNLIKELY_PROPAGATED_PENALTY_MULTIPLIER||.5);const p=r.tagName.toUpperCase();["ARTICLE","MAIN"].includes(p)&&(c*=l.SEMANTIC_TAG_BOOST_MULTIPLIER||1.2),c+=i.contentNodeCount/(r.getElementsByTagName("*").length||1)*50,c>n&&(n=c,t=r)}return{bestContainer:t,bestScore:n}}(a);if(!r)return void 0;const{container:p,score:f}=function(e,t,n){let a=e,o=n,r=0;const i=l.DESCEND_TO_REFINE_MAX_DEPTH||3,s=l.DESCEND_TO_REFINE_CONTENT_NODE_THRESHOLD||.6,c=t.get(e);if(!c)return{container:e,score:o};for(;r<i;){let e=null,n=-1/0;const i=t.get(a);if(!i)break;for(const o of a.children){const r=t.get(o);if(!r)continue;if(r.linkDensityVal>=(l.BEST_CONTAINER_LINK_DENSITY_THRESHOLD||.4))continue;if(r.contentNodeCount<c.contentNodeCount*s)continue;let d=r.accumulatedScore+r.classWeight;d+=(i.linkDensityVal-r.linkDensityVal)*(l.LINK_DENSITY_DIFF_MULTIPLIER||10),d+=2*(h(o)-h(a)),d>n&&(e=o,n=d)}if(!e)break;a=e,o=n,r++}return{container:a,score:o}}(r,a,u);f>E&&(E=f,b=p)}const v=l.TOP_N_CANDIDATES_FROM_STEP1||3;g.length>0&&g.slice(0,v).forEach(((e,t)=>{w(e.element,`Step1-${t+1}`)}));const S=l.MIN_SCORE_FOR_BROAD_SEARCH||50;if(!b||E<S){e;w(document.querySelector(`:is(\n[id*="article" i],\n[id*="post" i],\n[id*="content" i],\n[id*="story" i],\n[id*="entry" i],\n[class*="post" i],\n[class*="story" i],\n[class*="entry" i],\n[class*="article" i],\n[role="main"],\n#main,\n#content,\narticle,\nmain):has(p:nth-of-type(${l.MIN_PARAGRAPHS_STEP1_CANDIDATE-1}))`)||document.querySelector("article,main")||document.body,"Broad")}return b},extractMetadata(){const e={title:"",canonicalUrl:"",url:"",datePublished:"",dateModified:"",date:"",authors:[],publisher:{name:"",logo:""},siteName:"",description:"",images:[],mainImage:"",tags:[],section:"",language:"",confidence:{}},t=e.confidence,n=/^https?:\/\/(?:www\.)?[\w.-]+\.[\w.-]+\/(?:author|authors|writer|writers|by|profile|user|contributor|c|people|person|staff|team|about)\/([\w._\-+~]+)\/?(?:\?.*|#.*)?$/i;function a(e){return"string"!=typeof e?"":e.trim().replace(/\s+/g," ")}function o(e){if(!e||"string"!=typeof e)return"";try{return new URL(e,document.baseURI).href}catch{return e}}function r(e){return e&&"string"==typeof e?e.replace(/[._\-+~]/g," ").replace(/\s+/g," ").trim().replace(/\b\w/g,(e=>e.toUpperCase())):""}function i({name:i,url:s,role:l,source:c}){let d=k.parseAuthors(i||"").author;const u=o(s||""),h=a(l||"");if(u&&!d){const e=u.match(n);e&&e[1]&&(d=k.parseAuthors(r(e[1])).author)}if(!d)return;const p=new Intl.Collator(void 0,{sensitivity:"base",ignorePunctuation:!0}),m=e.authors.find((e=>0==p.compare(a(e.name),a(d))));m?(!m.url&&u&&(m.url=u),!m.role&&h&&(m.role=h)):(e.authors.push({name:d,url:u,role:h}),t.authors||(t.authors=c))}function s(n,a,r,l={}){if(null==a||""===a)return;let c=a;if(l.date){const e=new Date(String(a));if(isNaN(e.getTime()))return;c=e.toISOString()}if(l.url&&(c=o(String(a)),!c))return;const d="string"==typeof c?c.trim():String(c);if(""===d&&!l.date)return;if(l.csv&&"string"==typeof d&&d.includes(","))return void d.split(/\s*,\s*/).forEach((e=>{e.trim()&&s(n,e.trim(),r,{...l,csv:!1})}));if(l.author)return void String(d).split(/\s*(?:[,;\/|&]|\band\b)\s*/i).filter(Boolean).forEach((e=>{i({name:e,url:"",role:"",src:r})}));(Array.isArray(n)?n:[n]).forEach((n=>{if(!n)return;const a=n.split("."),o=a.pop();let i=e;for(const e of a)i[e]&&"object"==typeof i[e]||(i[e]={}),i=i[e];const s=i[o],l=n;if(Array.isArray(s)){const e="string"==typeof c?c.trim():c;""===e||s.includes(e)||(s.push(e),t[l]||(t[l]=r))}else s||(i[o]="string"==typeof c?c.trim():c,t[l]||(t[l]=r))}))}try{const t=document.querySelector('meta[property="og:title"]');t?.content?s("title",a(t.content),"og:title"):s("title",a(document.title),"document.title");const n=document.documentElement.getAttribute("lang");n&&s("language",n.split("-")[0],"html[lang]");const o=document.querySelector('link[rel="canonical"]');o?.href&&s("canonicalUrl",o.href,"link[rel=canonical]",{url:!0});const r=document.querySelector('meta[property="og:url"]');if(r?.content&&s("url",r.content,"og:url",{url:!0}),!e.url){s("url",e.canonicalUrl||window.location.href,e.canonicalUrl?"canonical|window":"window.location",{url:!0})}}catch(e){console.error("extractMetadata (Base) error:",e)}const l=()=>{const t=Array.from(document.querySelectorAll('script[type="application/ld+json"]')),n=[],o=new Map;if(t.forEach((e=>{try{const t=JSON.parse(e.textContent||"");(Array.isArray(t)?t:t&&"object"==typeof t?[t]:[]).forEach((e=>{(Array.isArray(e["@graph"])?e["@graph"]:[e]).forEach((e=>{e&&"object"==typeof e&&(n.push(e),e["@id"]&&"string"==typeof e["@id"]&&o.set(e["@id"],e))}))}))}catch(e){}})),0===n.length)return;const r=e=>Array.isArray(e?.["@type"])?e["@type"]:(e?.["@type"]?[e["@type"]]:[]).filter((e=>"string"==typeof e)),l=(e,t)=>e.some((e=>e.toLowerCase()===t.toLowerCase()||e.toLowerCase().endsWith(`/${t.toLowerCase()}`))),c=["Article","NewsArticle","BlogPosting","TechArticle","Report","ScholarlyArticle"],d=(e,t)=>{if(!e)return;let n=e;"string"==typeof e&&e.startsWith("http")?n=o.get(e)||{name:e}:"string"==typeof e?n={name:e}:e["@id"]&&"string"==typeof e["@id"]&&Object.keys(e).length<=2&&(n=o.get(e["@id"])||e),n&&"object"==typeof n&&n.name&&(s("publisher.name",a(String(n.name)),t),n.logo&&(Array.isArray(n.logo)?n.logo:[n.logo]).forEach((e=>{let n=e;"string"==typeof e&&e.startsWith("http")?n=o.get(e)||{url:e}:"string"==typeof e?n={url:e}:e?.["@id"]&&"string"==typeof e["@id"]&&Object.keys(e).length<=2&&(n=o.get(e["@id"])||e);const a="string"==typeof n?n:String(n?.url||n?.contentUrl||"");a&&s("publisher.logo",a,`${t}Logo`,{url:!0})})))},u=new Set,h=(e,t)=>{if(!(!e||"object"!=typeof e||e["@id"]&&u.has(e["@id"]))){if(s("title",a(String(e.headline||e.name)),`${t}:headlineOrName`),e.datePublished&&s("datePublished",String(e.datePublished),`${t}:datePublished`,{date:!0}),e.dateModified&&s("dateModified",String(e.dateModified),`${t}:dateModified`,{date:!0}),(e.description||e.abstract)&&s("description",a(String(e.description||e.abstract)),`${t}:description`),e.articleSection&&s("section",a(String(e.articleSection)),`${t}:articleSection`),e.url&&"string"==typeof e.url&&s("url",e.url,`${t}:url`,{url:!0}),e.inLanguage){const n=Array.isArray(e.inLanguage)?e.inLanguage[0]:e.inLanguage;"string"==typeof n&&s("language",n.split("-")[0],`${t}:inLanguage`)}if(e.keywords){(Array.isArray(e.keywords)?e.keywords:"string"==typeof e.keywords?e.keywords.split(/,|\//):[]).forEach((e=>s("tags",a(String(e)),`${t}:keywords`)))}var n,r;e.image&&(n=e.image,r=`${t}:image`,n&&(Array.isArray(n)?n:[n]).forEach((e=>{let t=e;"string"==typeof e&&e.startsWith("http")?t=o.get(e)||{url:e}:"string"==typeof e?t={url:e}:e?.["@id"]&&"string"==typeof e["@id"]&&Object.keys(e).length<=2&&(t=o.get(e["@id"])||e);const n="string"==typeof t?t:String(t?.url||t?.contentUrl||"");n&&s(["mainImage","images"],n,r,{url:!0})}))),e.author&&((e,t)=>{e&&(Array.isArray(e)?e:[e]).forEach((e=>{if(!e||"object"!=typeof e&&"string"!=typeof e)return;let n=e;"string"==typeof e&&e.startsWith("http")?n=o.get(e)||{name:e}:"string"==typeof e?n={name:e}:e["@id"]&&"string"==typeof e["@id"]&&Object.keys(e).length<=2&&(n=o.get(e["@id"])||e);const a=n?.name?String(n.name):"string"==typeof n?n:"",r=n?.url||n?.sameAs||"";let s="";if("object"==typeof n){const e=String(n.jobTitle||n.roleName||n.description||n.role||"");(n.jobTitle||n.roleName||n.role&&"string"==typeof n.role||e.length<100&&/\b(author|editor|writer|contributor|journalist|photographer|artist|creator)\b/i.test(e))&&(s=e)}i({name:a,url:String(r),role:s,source:t})}))})(e.author,`${t}:author`),e.publisher&&d(e.publisher,`${t}:publisher`),e["@id"]&&u.add(e["@id"])}};let p=n.find((e=>c.some((t=>l(r(e),t)))));p?h(p,"json-ld:mainContent"):(p=n.find((e=>l(r(e),"WebPage"))),p&&h(p,"json-ld:webPage")),e.publisher.name&&e.siteName||n.forEach((t=>{if(t["@id"]&&u.has(t["@id"]))return;const n=r(t);l(n,"Organization")&&!e.publisher.name&&d(t,"json-ld:organization"),l(n,"WebSite")&&!e.siteName&&(t.name&&s("siteName",a(String(t.name)),"json-ld:webSiteName"),t.publisher&&!e.publisher.name&&d(t.publisher,"json-ld:webSitePublisher"))}))};try{l()}catch(e){console.error("extractMetadata (JSON-LD) error:",e)}try{const e=Array.from(document.querySelectorAll("meta[property], meta[name]")),t=new Map;e.forEach((e=>{const n=e.getAttribute("property")||e.getAttribute("name"),a=e.getAttribute("content");n&&a&&(t.has(n)||t.set(n,[]),t.get(n).push(a))}));[["og:title","title",{source:"og:title"}],["twitter:title","title",{source:"twitter:title"}],["og:description","description",{source:"og:description"}],["twitter:description","description",{source:"twitter:description"}],["description","description",{source:"meta:description"}],["og:image",["mainImage","images"],{source:"og:image",url:!0}],["twitter:image",["mainImage","images"],{source:"twitter:image",url:!0}],["og:image:secure_url",["mainImage","images"],{source:"og:image:secure_url",url:!0}],["article:published_time","datePublished",{source:"article:published_time",date:!0}],["article:modified_time","dateModified",{source:"article:modified_time",date:!0}],["og:updated_time","dateModified",{source:"og:updated_time",date:!0}],["og:site_name","siteName",{source:"og:site_name"}],["author","authors",{source:"meta:author",author:!0}],["article:author",null,{source:"article:author",specialAuthorHandling:!0}],["keywords","tags",{source:"meta:keywords",csv:!0}],["article:tag","tags",{source:"article:tag"}],["article:section","section",{source:"article:section"}],["DC.title","title",{source:"dc:title"}],["DC.description","description",{source:"dc:description"}],["DC.creator","authors",{source:"dc:creator",author:!0}],["DC.publisher","publisher.name",{source:"dc:publisher"}],["DC.date.issued","datePublished",{source:"dc:date.issued",date:!0}],["DC.date.created","datePublished",{source:"dc:date.created",date:!0}],["DC.date.modified","dateModified",{source:"dc:date.modified",date:!0}],["DC.language","language",{source:"dc:language"}]].forEach((([e,n,o])=>{const r=t.get(e);r&&r.forEach((e=>{const t=a(e);o.specialAuthorHandling?t.startsWith("http")?i({name:"",url:t,role:"",source:o.source}):t.split(/\s*(?:[,;\/|&]|\band\b)\s*/i).filter(Boolean).forEach((e=>{i({name:e,url:"",role:"",source:o.source})})):n&&s(n,t,o.source,o)}))}))}catch(e){console.error("extractMetadata (Meta) error:",e)}try{e.title&&(e.datePublished||e.dateModified)&&e.authors.length>0&&(t.title?.includes("json-ld")||t.title?.startsWith("og:"))&&!Object.values(t).some((e=>e?.startsWith("microdata")))||document.querySelectorAll("[itemscope][itemtype]").forEach((e=>{const t=e.getAttribute("itemtype")||"",n=t.startsWith("http://schema.org/")||t.startsWith("https://schema.org/")?t.substring(t.lastIndexOf("/")+1):t;/Article|NewsArticle|BlogPosting|WebPage|Person|Organization/i.test(n)&&e.querySelectorAll("[itemprop]").forEach((e=>{const t=e.getAttribute("itemprop");if(!t)return;let r="",l="";if("META"===e.tagName?r=e.getAttribute("content")||"":"IMG"===e.tagName||"VIDEO"===e.tagName||"AUDIO"===e.tagName?(r=e.src||e.getAttribute("content")||"",l=r):"A"===e.tagName||"LINK"===e.tagName?(r=e.textContent||"",l=e.href||e.getAttribute("content")||""):r=e.hasAttribute("datetime")?e.getAttribute("datetime")||"":e.textContent||"",r=a(r),!(r||"image"===t||"logo"===t||"author"===t||"A"===e.tagName&&l))return;const c=`microdata:${n.toLowerCase()}:${t}`;switch(t){case"headline":case"name":/Article|NewsArticle|BlogPosting|WebPage/i.test(n)?s("title",r,c):/Person/i.test(n)?i({name:r,url:l,role:"",source:c}):/Organization/i.test(n)&&s("publisher.name",r,c);break;case"datePublished":s("datePublished",r,c,{date:!0});break;case"dateModified":s("dateModified",r,c,{date:!0});break;case"author":let t=r,d=l;if(e.hasAttribute("itemscope")){const n=e.querySelector('[itemprop="name"]');n&&(t=a(n.textContent||""));const r=e.querySelector('[itemprop="url"]');r&&(d=o(r.href||r.getAttribute("content")||""))}i({name:t,url:d,role:"",source:c});break;case"description":case"abstract":s("description",r,c);break;case"image":s(["mainImage","images"],e.src||e.getAttribute("content"),c,{url:!0});break;case"publisher":let u=r;if(e.hasAttribute("itemscope")){const t=e.querySelector('[itemprop="name"]');t&&(u=a(t.textContent||""))}s("publisher.name",u,c);break;case"logo":s("publisher.logo",e.src||e.getAttribute("content"),c,{url:!0});break;case"keywords":s("tags",r,c,{csv:!0});break;case"articleSection":s("section",r,c);break;case"url":l&&s("url",l,c,{url:!0});break;case"inLanguage":s("language",r.split("-")[0],c)}}))}))}catch(e){console.error("extractMetadata (Microdata) error:",e)}try{(()=>{if(e.authors.length>0&&t.authors&&!t.authors.startsWith("byline"))return;const a=[':is(header, :is(article, main) [class*="header" i])\n:is([class*="byline" i], a[rel="author"], [class*="name" i], [class*="author" i], [class*="writer" i]) a'];let s=!1;for(const t of a)if(document.querySelectorAll(t).forEach((e=>{let a="",l="",c="",d="";if("A"===e.tagName){a=o(e.href),l=k.parseAuthors(e.textContent||"").author;const t=a.match(n);t&&t[1]&&(c=k.parseAuthors(r(t[1])).author)}else{const t=e.querySelector("a");if(t){a=o(t.href),l=k.parseAuthors(t.textContent||e.textContent||"").author;const i=a.match(n);i&&i[1]&&(c=k.parseAuthors(r(i[1])).author)}}d=c?!l||/^(author|profile|user|writer|staff|editor|contributors?)$/i.test(l.toLowerCase())?c:l:k.parseAuthors(l).author,d.split(" ").map((e=>e.charAt(0))).some((e=>e===e.toLowerCase()))&&(d=null),d&&"by"!==d.toLowerCase()&&d.split(/\s*(?:[,;\/|&]|\band\b)\s*/i).filter(Boolean).forEach((e=>{"by"!==e.toLowerCase()&&(i({name:e,url:d===e?a:"",role:"",source:`byline:${t}`}),s=!0)}))})),s&&e.authors.length>0)break})()}catch(e){console.error("extractMetadata (Byline) error:",e)}try{if(!e.title){const e=document.querySelector("h1");e?.textContent&&s("title",a(e.textContent),"h1:textContent")}}catch(e){console.error("extractMetadata (Heuristics) error:",e)}try{!e.siteName&&e.publisher.name&&(e.siteName=e.publisher.name,t.siteName||(t.siteName="derived:publisher.name")),e.date||(e.datePublished?(e.date=e.datePublished,t.date||(t.date=t.datePublished||"derived:datePublished")):e.dateModified&&(e.date=e.dateModified,t.date||(t.date=t.dateModified||"derived:dateModified"))),!e.mainImage&&e.images.length>0&&(e.mainImage=e.images[0],t.mainImage||(t.mainImage=t.images||"derived:images[0]")),Object.keys(t).forEach((n=>{const a=n.split("."),o=a.pop();let r=e,i=!0;for(const e of a){if(!r[e]||"object"!=typeof r[e]){i=!1;break}r=r[e]}if(!i||"object"!=typeof r||null===r)return;const s=r[o];(""===s||Array.isArray(s)&&0===s.length||"object"==typeof s&&null!==s&&!Array.isArray(s)&&0===Object.keys(s).length&&!(s instanceof Date))&&delete t[n]})),(()=>{const t=document.createElement("div"),n=e=>(t.innerHTML=e,t.textContent.trim());["title","description","siteName","section"].forEach((t=>{e[t]&&(e[t]=n(e[t]))})),e.publisher?.name&&(e.publisher.name=n(e.publisher.name)),e.authors=e.authors.map((e=>({name:n(e.name),url:e.url,role:e.role?n(e.role):""}))),e.tags=e.tags.map((e=>n(e)))})()}catch(e){console.error("extractMetadata (Derived/Polish) error:",e)}return e},displayExtractedContent(e,t){try{const n=s.overlay,a=M.createControls(n,(()=>{M.overlayHost?.remove(),M.overlayHost=null})),{settingsWrapper:o,getCurrentMetadata:r}=M.createSettingsWrapper(t),{previewContainer:i,previewTabs:l,getPreviewTabContents:c,updateContent:d,managePreviewButton:u}=M.createPreviewTabs(e);M.getCurrentMetadata=r,M.getPreviewTabContents=c,M.managePreviewButton=u;const h=M.createExportButtons(c,r),p=M.createReplacePageButton(c,r),{settingsContainer:m,methodOption:f,advancedHeader:g}=M.createSettingsSection(n),{readabilityHeader:y,readabilityOptions:b,applyReadability:E}=M.createReadabilitySection(o),w=d;_.updateContent=(e,t={})=>{const{redraw:n=!0}=t;w(e,t),u({refresh:n}),E()},u({init:a}),a.prepend(p),M.controlBar=a,h.appendChild(f),h.appendChild(y),h.appendChild(g),o.appendChild(h),o.appendChild(m),o.appendChild(b),o.appendChild(l),n.appendChild(a),n.appendChild(o),n.appendChild(i),document.body.appendChild(M.overlayHost),E()}catch(e){k.handleError(e,"Failed to display extracted content")}}};!async function(){try{document.adoptedStyleSheets=[c];const e=s.readabilityPrefs.fontFamily;e&&l.GOOGLE_FONTS_MAP[e]&&k.ensureFontLink(e);(()=>{let e=document.getElementById("ae-button");e||(e=document.createElement("button"),e.textContent="Extract Article  📰",e.id="ae-button",e.className="ae",document.body.appendChild(e),s.cleanupFunctions.extractButtonCleanup=function(e,{storageKey:t="aeButtonPos",dragThreshold:n=6}={}){const a=(e,t,n)=>Math.min(Math.max(e,t),n),o=(t,n=NaN)=>{const a=getComputedStyle(e).getPropertyValue(t).trim();if(!a)return n;const o=parseFloat(a);return Number.isFinite(o)?o:n},r=(t,n)=>e.style.setProperty(t,n+"px"),i=(e=!1)=>{const t=e?window.visualViewport:document.documentElement;return e?{w:t.width,h:t.height,x:t.offsetLeft,y:t.offsetTop}:{w:t.clientWidth,h:t.clientHeight,x:t.offsetLeft,y:t.offsetTop}};try{const n=JSON.parse(localStorage.getItem(t));n&&Number.isFinite(n.x)&&Number.isFinite(n.y)?(r("--ae-x",n.x),r("--ae-y",n.y)):(r("--ae-x",i().w-10-e.offsetWidth),r("--ae-y",10))}catch{}let s=0,l=0,c=0,d=0,u=null,h=!1,p=0,m="",f=!1;const g=(e,t)=>{cancelAnimationFrame(p),p=requestAnimationFrame((()=>{r("--ae-x",e),r("--ae-y",t)}))};e.addEventListener("click",(e=>{f?(f=!1,e.preventDefault(),e.stopImmediatePropagation()):D.extractArticle()}),!0);const y=()=>{const t=e.getBoundingClientRect(),n=i();let r=o("--ae-x",t.left),s=o("--ae-y",t.top);const l=n.x,c=n.y,d=n.x+n.w-t.width,u=n.y+n.h-t.height,h=a(r,l,Math.max(l,d)),p=a(s,c,Math.max(c,u));h===r&&p===s||g(h,p)},b=t=>{null!=t.button&&0!==t.button||(h=!1,u=e.getBoundingClientRect(),c=o("--ae-x",u.left),d=o("--ae-y",u.top),s=t.clientX,l=t.clientY,e.setPointerCapture?.(t.pointerId),e.classList.add("dragging"),m=document.body.style.userSelect,document.body.style.userSelect="none",e.addEventListener("pointermove",E),e.addEventListener("pointerup",w,{once:!0}),e.addEventListener("pointercancel",w,{once:!0}))},E=e=>{const t=e.clientX-s,o=e.clientY-l,r=i(),p=r.x,m=r.y,f=r.x+r.w-u.width,y=r.y+r.h-u.height,b=a(c+t,p,Math.max(p,f)),E=a(d+o,m,Math.max(m,y));!h&&(Math.abs(b-c)>n||Math.abs(E-d)>n)&&(h=!0),g(b,E)},w=n=>{cancelAnimationFrame(p),e.removeEventListener("pointermove",E),e.releasePointerCapture?.(n.pointerId),e.classList.remove("dragging"),document.body.style.userSelect=m,f=h;try{const n=e.getBoundingClientRect(),a=o("--ae-x",n.left),r=o("--ae-y",n.top);localStorage.setItem(t,JSON.stringify({x:a,y:r}))}catch{}},v=()=>y();return window.addEventListener("resize",v),(()=>{const t=getComputedStyle(e),n=e.getBoundingClientRect();t.getPropertyValue("--ae-x").trim()||r("--ae-x",n.left),t.getPropertyValue("--ae-y").trim()||r("--ae-y",n.top),y()})(),e.addEventListener("pointerdown",b),{destroy(){window.removeEventListener("resize",v),e.removeEventListener("pointerdown",b),e.removeEventListener("pointermove",E),e.classList.remove("dragging"),document.body.style.userSelect=m},getPosition(){const t=e.getBoundingClientRect();return{x:o("--ae-x",t.left),y:o("--ae-y",t.top)}},setPosition(e,t,n=!0){g(e,t),n&&y()}}}(e).destroy)})()}catch(e){console.error("Initialization error:",e),alert("Article Extractor failed to initialize: "+e.message)}}()}();
